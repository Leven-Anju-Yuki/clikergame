/*! For license information please see main-7f044e6d.be2b3b19.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).xss={})}(this,(function(e){"use strict";var t=function(){return t=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},t.apply(this,arguments)};function i(e,t,i){if(i||2===arguments.length)for(var r,s=0,a=t.length;s<a;s++)!r&&s in t||(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return e.concat(r||Array.prototype.slice.call(t))}var r=/[^a-zA-Z0-9\\_:.-]/gim,s=/</g,a=/>/g,o=/&#([a-zA-Z0-9]*);?/gim,n=/&quot;/g,l=/&colon;?/gim,d=/&newline;?/gim,c=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,u=/u\s*r\s*l\s*\(.*/gi,p=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,h=/"/g,f=function(e){return e.replace(s,"&lt;").replace(a,"&gt;")},m={indexOf:function(e,t){var i,r;for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1},forEach:function(e,t,i){var r,s;for(r=0,s=e.length;r<s;r++)t.call(i,e[r],r,e)},some:function(e,t,i){var r,s;for(r=0,s=e.length;r<s;r++)if(t.call(i,e[r],r,e))return!0;return!1},trim:function(e){return e.replace(/(^\s*)|(\s*$)/g,"")},isArray:function(e){return e instanceof Array},includes:function(e,t){if("string"==typeof e)return-1!==e.indexOf(t);for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},spaceIndex:function(e){var t=/\s|\n|\t/.exec(e);return t?t.index:-1},uniq:function(e){for(var t={},i=[],r=0;r<e.length;r++)t[e[r]]||(i.push(e[r]),t[e[r]]=!0);return i},from:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t},keys:function(e){var t=[];for(var i in e)t.push(i);return t}};function v(e){return null==e}function g(e){var t,i=m.spaceIndex(e);return t=-1===i?e.slice(1,-1):e.slice(1,i+1),"/"===(t=m.trim(t).toLowerCase()).slice(0,1)&&(t=t.slice(1)),"/"===t.slice(-1)&&(t=t.slice(0,-1)),t}function y(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"="===i?t:-1}return-1}function _(e,t){for(;t>0;t--){var i=e[t];if(" "!==i)return"="===i?t:-1}return-1}function w(e){return function(e){return'"'===e[0]&&'"'===e[e.length-1]||"'"===e[0]&&"'"===e[e.length-1]}(e)?e.substr(1,e.length-2):e}function I(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"'"===i||'"'===i?t:-1}return-1}function A(e){var t,i,r,s,a,o,n,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="",c=0;for(e=function(e){e=e.replace(/rn/g,"n");for(var t="",i=0;i<e.length;i++){var r=e.charCodeAt(i);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(63&r|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(63&r|128))}return t}(e);c<e.length;)s=(t=e.charCodeAt(c++))>>2,a=(3&t)<<4|(i=e.charCodeAt(c++))>>4,o=(15&i)<<2|(r=e.charCodeAt(c++))>>6,n=63&r,isNaN(i)?o=n=64:isNaN(r)&&(n=64),d=d+l.charAt(s)+l.charAt(a)+l.charAt(o)+l.charAt(n);return d}function T(e){var t,i,r,s,a,o,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",d=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");d<e.length;)t=n.indexOf(e.charAt(d++))<<2|(s=n.indexOf(e.charAt(d++)))>>4,i=(15&s)<<4|(a=n.indexOf(e.charAt(d++)))>>2,r=(3&a)<<6|(o=n.indexOf(e.charAt(d++))),l+=String.fromCharCode(t),64!==a&&(l+=String.fromCharCode(i)),64!==o&&(l+=String.fromCharCode(r));return l=function(e){for(var t="",i=0,r=0,s=0,a=0;i<e.length;)(r=e.charCodeAt(i))<128?(t+=String.fromCharCode(r),i++):r>191&&r<224?(a=e.charCodeAt(i+1),t+=String.fromCharCode((31&r)<<6|63&a),i+=2):(a=e.charCodeAt(i+1),s=e.charCodeAt(i+2),t+=String.fromCharCode((15&r)<<12|(63&a)<<6|63&s),i+=3);return t}(l),l}function S(e){return"</"===e.slice(0,2)}function k(e,t,i){var r="",s=0,a=!1,o=!1,n=0,l=e.length,d="",c="";e:for(n=0;n<l;n++){var u=e.charAt(n);if(!1===a){if("<"===u){a=n;continue}}else if(!1===o){if("<"===u){r+=i(e.slice(s,n)),a=n,s=n;continue}if(">"===u||n===l-1){r+=i(e.slice(s,a)),d=g(c=e.slice(a,n+1)),r+=t(a,r.length,d,c,S(c)),s=n+1,a=!1;continue}if('"'===u||"'"===u)for(var p=1,h=e.charAt(n-p);""===h.trim()||"="===h;){if("="===h){o=u;continue e}h=e.charAt(n-++p)}}else if(u===o){o=!1;continue}}return s<l&&(r+=i(e.substr(s))),r}function b(e,t){var i=0,s=0,a=[],o=!1,n=e.length;function l(e,i){if(!((e=(e=m.trim(e)).replace(r,"").toLowerCase()).length<1)){var s=t(e,i||"");s&&a.push(s)}}for(var d=0;d<n;d++){var c=e.charAt(d),u=void 0;if(!1!==o||"="!==c)if(!1===o||d!==s){if(/\s|\n|\t/.test(c)){if(e=e.replace(/\s|\n|\t/g," "),!1===o){if(-1===(u=y(e,d))){l(m.trim(e.slice(i,d))),o=!1,i=d+1;continue}d=u-1;continue}if(-1===(u=_(e,d-1))){l(o,w(m.trim(e.slice(i,d)))),o=!1,i=d+1;continue}}}else{if(-1===(u=e.indexOf(c,d+1)))break;l(o,m.trim(e.slice(s+1,u))),o=!1,i=(d=u)+1}else o=e.slice(i,d),i=d+1,s='"'===e.charAt(i)||"'"===e.charAt(i)?i:I(e,d+1)}return i<e.length&&(!1===o?l(e.slice(i)):l(o,w(m.trim(e.slice(i))))),m.trim(a.join(" "))}function C(e,t,i){if(i=function(e){return function(e){for(var t="",i=0,r=e.length;i<r;i++)t+=e.charCodeAt(i)<32?" ":e.charAt(i);return m.trim(t)}(e=function(e){return e.replace(l,":").replace(d," ")}(e=function(e){return e.replace(o,(function(e,t){return"x"===t[0]||"X"===t[0]?String.fromCharCode(parseInt(t.substr(1),16)):String.fromCharCode(parseInt(t,10))}))}(e=function(e){return e.replace(n,'"')}(e))))}(i),"href"===t||"src"===t){if("#"===(i=m.trim(i)))return"#";if("http://"!==i.substr(0,7)&&"https://"!==i.substr(0,8)&&"mailto:"!==i.substr(0,7)&&"tel:"!==i.substr(0,4)&&"data:image/"!==i.substr(0,11)&&"ftp://"!==i.substr(0,6)&&"./"!==i.substr(0,2)&&"../"!==i.substr(0,3)&&"#"!==i[0]&&"/"!==i[0])return""}else if("background"===t){if(c.lastIndex=0,c.test(i))return""}else if("style"===t){if(p.lastIndex=0,p.test(i))return"";if(u.lastIndex=0,u.test(i)&&(c.lastIndex=0,c.test(i)))return""}return function(e){return e=function(e){return e.replace(h,"&quot;")}(e),f(e)}(i)}var x=function(e){return"string"==typeof e?e.replace(/'/g,'"').replace('=""',"").replace(/\s+/g,"").toLowerCase():""},P=function(){function e(e){var t=function(e){var t={};for(var i in e)t[i]=e[i];return t}(e||{});t.stripIgnoreTag&&(t.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),t.onIgnoreTag=function(){return""}),t.whiteList={},t.onTag=function(){},t.onTagAttr=function(){},t.onIgnoreTag=function(){},t.onIgnoreTagAttr=function(){},t.safeAttrValue=C,t.escapeHtml=f,this.options=Object.assign(t,e)}return e.prototype.process=function(e){if(!(e=(e=e||"").toString()))return"";var t=this.options,i=t.whiteList,r=t.onTag,s=t.onIgnoreTag,a=t.onTagAttr,o=t.onIgnoreTagAttr,n=t.safeAttrValue,l=t.escapeHtml;t.stripBlankChar&&(e=function(e){var t=e.split("");return(t=t.filter((function(e){var t=e.charCodeAt(0);return!(127===t||t<=31&&10!==t&&13!==t)}))).join("")}(e)),t.allowCommentTag||(e=function(e){for(var t="",i=0;i<e.length;){var r=e.indexOf("\x3c!--",i);if(-1===r){t+=e.slice(i);break}t+=e.slice(i,r);var s=e.indexOf("--\x3e",r);if(-1===s)break;i=s+3}return t}(e));var d=!1;t.stripIgnoreTagBody&&(d=function(e,t){"function"!=typeof t&&(t=function(){});var i=!Array.isArray(e),r=[],s=!1;return{onIgnoreTag:function(a,o,n){if(function(t){return!!i||-1!==m.indexOf(e,t)}(a)){if(n.isClosing){var l="[/removed]",d=n.position+10;return r.push([!1!==s?s:n.position,d]),s=!1,l}return s||(s=n.position),"[removed]"}return t(a,o,n)},remove:function(e){var t="",i=0;return m.forEach(r,(function(r){t+=e.slice(i,r[0]),i=r[1]})),t+=e.slice(i)}}}(t.stripIgnoreTagBody,s),s=d.onIgnoreTag);var c=k(e,(function(e,t,d,c,u){var p={sourcePosition:e,position:t,isClosing:u,isWhite:Object.prototype.hasOwnProperty.call(i,d)},h=r(d,c,p);if(!v(h))return h;if(p.isWhite){if(p.isClosing)return"</".concat(d,">");var f=function(e){var t=m.spaceIndex(e);if(-1===t)return{html:"",closing:"/"===e[e.length-2]};var i="/"===(e=m.trim(e.slice(t+1,-1)))[e.length-1];return i&&(e=m.trim(e.slice(0,-1))),{html:e,closing:i}}(c),g=i[d],y=b(f.html,(function(e,t){var i=-1!==m.indexOf(g,e),r=a(d,e,t,i);return v(r)?i?(t=n(d,e,t,null))?"".concat(e,'="').concat(t,'"'):e:v(r=o(d,e,t,i))?void 0:r:r}));return c="<".concat(d),y&&(c+=" ".concat(y)),f.closing&&(c+=" /"),c+">"}return v(h=s(d,c,p))?l(c):h}),l);return d&&(c=d.remove(c)),c},e}(),U=!0,F=function(e){return e&&e.Math==Math&&e},L=F("object"==typeof globalThis&&globalThis)||F("object"==typeof window&&window)||F("object"==typeof self&&self)||F("object"==typeof global&&global)||Function("return this")();try{!0!==(U=!!(U=String(U)).startsWith("<%=")||JSON.parse(U))&&"true"!==U||(L=new Function("\nvar _checkXSS = function (it) {\n  return it && it.Math == Math && it;\n};\nreturn _checkXSS(typeof globalThis === 'object' && globalThis) ||\n_checkXSS(typeof window === 'object' && window) ||\n_checkXSS(typeof self === 'object' && self) ||\n_checkXSS(typeof global === 'object' && global) ||\nFunction('return this')();\n")())}catch(e){console.log(e)}var E=new(function(){function e(){var e=this;this.batchData=[],this.uniqKeys=new Set,this.timeout=2e3,this.lock=!1,this.getSlardarBid=function(){var t,i,r="cc_web";if(!m.includes(r,"bid"))return r;if(e.config&&e.config.bid)return e.config.bid;var s=L;if(s&&s._xssBid)return s._xssBid;if(s&&s.slardar&&"function"==typeof s.slardar.config){var a=(s.slardar.config()||{}).bid;if(a)return a}if(s&&s.Slardar&&"function"==typeof s.Slardar.config){var o=(s.Slardar.config()||{}).bid;if(o)return o}return(null===(i=null===(t=null==s?void 0:s.Slardar)||void 0===t?void 0:t._baseParams)||void 0===i?void 0:i.bid)||"argus"},this.getConfigRegion=function(){var t;return m.includes("va","region")?e.config&&e.config.region?e.config.region:((null===(t=null==L?void 0:L.gfdatav1)||void 0===t?void 0:t.region)||"cn").toLowerCase():"va"},this.gerReportUrl=function(){var t={cn:T("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boe:T("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),ttp:T("aHR0cHM6Ly9tb24udXMudGlrdG9rdi5jb20vbW9uaXRvcl9icm93c2VyL2NvbGxlY3QvYmF0Y2gvc2VjdXJpdHkvP2JpZD0="),va:T("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),maliva:T("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),sg:T("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boei18n:T("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9")}[e.getConfigRegion()];if(t)return t+e.getSlardarBid()}}return e.prototype.setConfig=function(e){this.config=e},e.prototype.upload=function(){var e=this;if(!this.config||!this.config.isCloseReport){var t=!1;t=String(t);try{if(!0===(t=!t.startsWith("<%=")&&JSON.parse(t))||"true"===t)return}catch(e){console.log(e)}var i=this.gerReportUrl();!this.lock&&i&&0!==this.batchData.length&&(this.lock=!0,setTimeout((function(){var t=e.batchData.slice(0,100);e.batchData=e.batchData.slice(100),L.fetch(i,{method:"post",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).catch((function(e){console.warn("xss defense report error",e)})),e.lock=!1,e.upload()}),this.timeout))}},e.prototype.generateKey=function(e){return e.collectKey?[e.collectMode,e.collectKey].join("___"):""},e.prototype.push=function(e){this.batchData.push(e),this.upload()},e.prototype.report=function(e){var t,i=this.generateKey(e);if(L.fetch&&e.collectKey){var r=(null===(t=null===window||void 0===window?void 0:window.location)||void 0===t?void 0:t.href)||"SSR";e.documentUrl=r;var s={age:Math.floor(Date.now()),type:"xss",url:r,body:e,"user-agent":""};"enforce"===e.disposition&&"SSR"!==r||(s.url=i),"SSR"===r&&(s.url="SSR___".concat(s.url),s.body.ssr=!0),this.push(s)}},e}());function M(e,t){return E.setConfig(t),new P(t).process(e)}var O=function(e){return-1===(e=(e=(e=(e=e.replace(/&colon;/gi,":")).replace(/&tab;/gi,"")).replace(/&newline;/gi,"")).replace(/(\t|\n|\r)/g,"")).indexOf("&#")?e.trim().toLowerCase():e.trim().replace(/&#(?:(x)([0-9a-f]+)|([0-9]+));?/gi,(function(e,t,i,r){return String.fromCharCode(t?parseInt(i,16):parseInt(r))})).replace(/(\t|\n|\r)/g,"").toLowerCase()};function R(e,t){if(void 0===e&&(e=""),"string"!=typeof e)return!0;if(e=O(e),m.includes(e,"base64")&&!function(e){if(""===e||""===e.trim())return!0;try{return!m.includes(e,"data:text/html;base64")}catch(e){return!0}}(e))return t&&t("data:text/html;base64"),!1;var i=["expression(","behavior:","view-source:"];if(m.some(i,(function(t){return-1!==e.indexOf(t)})))return m.forEach(i,(function(i){-1!==e.indexOf(i)&&t&&t(i)})),!1;var r=["data:application","data:javascript","data:text/html","data:texthtml"];if(m.some(r,(function(t){return-1!==e.indexOf(t)})))return m.forEach(r,(function(i){-1!==e.indexOf(i)&&t&&t(i)})),!1;if(e.indexOf("javascript:")>0)return t&&t("javascript:"),!1;if(/^javascript:/i.test(e)){var s=e.slice(11).replace(/\s/g,"").trim();return!!m.some(["void","void(0)","void0","false","undefined",";"],(function(e){return e===s}))||(t&&t("javascript:"),!1)}return!0}var j=function(e,t){var i,r,s=!1;if(s=String(s),"string"!=typeof e)return e;if(i=e,r=Number(-1),"NaN"!==i.toString()&&-1!==r&&i.length>=r)return e;if(R(e,t))return e;try{if(!0===(s=!s.startsWith("<%=")&&JSON.parse(s))||"true"===s){var a=new URL(e);return a.origin+a.pathname}}catch(e){return console.log(e),"#"}return"#"};function K(e,t,r){if(void 0===e&&(e=""),void 0===t&&(t=[]),"string"!=typeof e)return!0;if(!R(e=O(e)))return!1;var s=function(e){var t=e.match(/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/)||[];return{url:t[0],scheme:t[1],slash:t[2],host:t[3],port:t[4],path:t[5],query:t[6],hash:t[7]}}(e),a=s.scheme,o=s.host;return r?Boolean(r(e)):!(!a||!o)&&(!m.includes(["http","https","file"],a)||("object"==typeof window&&window&&(t=i(i([],t,!0),[location.host],!1)),m.some(t,(function(e){return!!(e instanceof RegExp&&e.test(o))||e===o}))))}var V=K,q=K,N=function(e,t){for(var i={},r=0,s=m.keys(e);r<s.length;r++){var a=s[r];Array.isArray(e[a])?i[a]=m.from(e[a]):i[a]=N({},e[a])}for(var o=0,n=m.keys(t);o<n.length;o++)(a=n[o])in e?Array.isArray(e[a])?i[a]=e[a].concat(t[a]):i[a]=N(e[a],t[a]):Array.isArray(t[a])?i[a]=m.from(t[a]):i[a]=N({},t[a]);return i},D={blackList:{a:["folder"],meta:["content"],iframe:["srcdoc"],input:["pattern"],vmlframe:["xmlns"]},blackTags:["script","xml","embed","isindex","object","base","set","handler","animate","payload","import"],blackAttrs:["charset","ns","namespace","formaction","xlink:href","xmlns:xlink","handler","repeat","repeat-start","repeat-end"],blackAttrRegExps:[/^on/],filterList:{param:["value"],video:["poster"],form:["action"]},filterAttrs:["href","src","background","style","dynsrc","lowsrc","content"]};try{var z={};z.blackAttrRegExps&&(z.blackAttrRegExps=z.blackAttrRegExps.map((function(e){return new RegExp(e.toString().slice(1,e.toString().length-1))})));var W="merge";m.includes(W,"override")&&(D=z),m.includes(W,"merge")&&(D=N(D,z))}catch(e){console.log(e)}var B,$={mode:"black",whiteList:{},blackConfig:D,collect:null,initCollect:function(){$.collect={blackList:{},blackTags:[],blackAttrs:[],blackAttrRegExps:[],filterAttrs:[],filterList:{},filterProtocol:[]}},removeCollect:function(){var e=function(e){for(var t=0,i=function(i){Array.isArray(e[i])?0===e[i].length?delete e[i]:(e[i]=m.from(m.uniq(e[i])),t+=e[i].length):0===m.keys(e[i]).length?delete e[i]:m.keys(e[i]).forEach((function(r){e[i][r]=m.from(m.uniq(e[i][r])),t+=e[i][r].length}))},r=0,s=m.keys(e);r<s.length;r++)i(s[r]);return{count:t,ret:e}}($.collect),t=e.count,i=e.ret;return $.collect=null,{collectKey:0===t?null:JSON.stringify(i),collectMode:"black"}},onIgnoreTag:function(e,t){var i;if(!m.includes(D.blackTags,e)){var r=k(t,(function(e,t,i,r,s){if(-1!==i.indexOf("/"))return f(r);if(s)return"</".concat(i,">");var a=function(e){var t,i=(t=/\s|\n|\t/.exec(e))?t.index:-1;if(-1===i)return{html:"",closing:"/"===e[e.length-2]};var r="/"===(e=e.slice(i+1,-1).trim())[e.length-1];return r&&(e=e.slice(0,-1).trim()),{html:e,closing:r}}(r),o=b(a.html,(function(e,t){var r,s=0;if(D.blackList[i]&&m.includes(D.blackList[i],e)&&($.collect.blackList[i]=$.collect.blackList[i]||[],$.collect.blackList[i].push(e),s++),D.blackAttrRegExps.length&&D.blackAttrRegExps.some((function(t){return t.test(e)}))&&m.forEach(D.blackAttrRegExps,(function(t){t.test(e)&&($.collect.blackAttrRegExps.push("".concat(t.toString(),"->").concat(e)),s++)})),D.blackAttrs.length&&m.includes(D.blackAttrs,e)&&(D.blackAttrs.push(e),s++),!s){if(D.filterList&&D.filterList[i]&&m.includes(D.filterList[i],e)){var a=j(t,(function(e){var t;null===(t=$.collect)||void 0===t||t.filterProtocol.push(e)}));return a!==t&&($.collect.filterList[i]=$.collect.filterList[i]||[],$.collect.filterList[i].push(e)),t?"".concat(e,"='").concat(a,"'"):e}return D.filterAttrs&&m.includes(D.filterAttrs,e)?(a=j(t,(function(e){var t;null===(t=$.collect)||void 0===t||t.filterProtocol.push(e)})),a!==t&&(null===(r=$.collect)||void 0===r||r.filterAttrs.push(e)),t?"".concat(e,"='").concat(a,"'"):e):t?"".concat(e,"='").concat(t,"'"):e}}));return r="<".concat(i),o&&(r+=" ".concat(o)),a.closing&&(r+=" /"),r+">"}),f);return r}null===(i=$.collect)||void 0===i||i.blackTags.push(e)}},Z=function(e){var t=e.reportOnly,i=void 0===t||t,r=e.block;return i&&"all"===i?"report":("string"==typeof i&&("true"===i&&(i=!0),"false"===i&&(i=!1)),r?"enforce":i?"report":"enforce")},H=function(e){return function(i,r,s){if(!i||"string"!=typeof i)return i;var a=r;e===M&&(a=$).initCollect();var o=e(i,a);if(x(o)===x(i))return i;if(!s)return o;var n=s.logType,l=Z(s),d=a.removeCollect();return E.report(t(t({type:n,disposition:l},d),{sourceText:A(i.replace(/'/g,'"')),filterText:A(o.replace(/'/g,'"'))})),"enforce"===l?o:i}},G=H((function(e,t){return void 0===t&&(t={}),t&&t.whiteList||(t.whiteList={a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}),new P(t).process(e)})),Y=H(M),Q=(B=j,function(e,t,i){var r=[],s=B(e,(function(e){r.push(e)}));if(s===e)return e;r=m.from(m.uniq(r));var a=t||i||{};if(!a)return s;var o=a.logType,n=Z(i);return E.report({type:o,disposition:n,collectKey:r.join("___"),collectData:JSON.stringify(r),collectMode:"black",sourceText:A(e),filterText:A(s)}),"enforce"===n?s:e}),J=L._xssProject||{},X=L.xssNamespace||{},ee="3.0.30",te={FilterXSS:P,version:ee,webpackPluginVersion:"3.0.39",reportOnly:"all",filterXSS:G,_filterXSS:Y,filterUrl:Q,BlackConfig:$,project:J,setProjectName:function(e){J[e]=this,L._xssProjectName=e}};X.cc_web_editor_smart_toolbox=te,L.xssNamespace=X,L.Math&&!L.Math.xssNamespace&&(L.Math.xssNamespace=X),J[ee]=te,L.globalThis=L,L.getFilterXss=function(){return void 0!==this._xssProjectName?this._xssProject[this._xssProjectName]:te},L.xss=te,L.isSafeUrl=V,L.isSafeDomain=q,L.isSafeProtocol=R,L._xssProject=J,L._xssProjectName&&(J[L._xssProjectName]=te);var ie=te.setProjectName.bind(te);e.BlackConfig=$,e.FilterXSS=P,e._filterXSS=Y,e.filterUrl=Q,e.filterXSS=G,e.isSafeDomain=q,e.isSafeProtocol=R,e.isSafeUrl=V,e.project=J,e.setProjectName=ie,e.setXssNamespace=function(e){var t=e.appId,i=e.bid,r=e.region,s=e.isCloseReport;X[t]=te;var a=$;a.bid=i,a.region=r,a.enabled=!0,a.isCloseReport=s},e.xssNamespace=X,Object.defineProperty(e,"__esModule",{value:!0})})),(window.webpackChunksmart_toolbox=window.webpackChunksmart_toolbox||[]).push([[4233],{90843:function(e,t,i){i.d(t,{QT:function(){return o},Ts:function(){return s.Ts},ZE:function(){return a},bu:function(){return p},sS:function(){return n},tf:function(){return l},vm:function(){return d},yp:function(){return c}});var r,s=i(7146);const a=2147483648,o=500,n=10,l=6,d=2,c=24e4,u=null!==(r=new URL(window.location.href).searchParams.get("ever_cloud_log_level"))&&void 0!==r?r:"",p=["error","trace"].includes(u)?u:"error"},16649:function(e,t,i){i.d(t,{Fe:function(){return A},b1:function(){return T},el:function(){return f},kU:function(){return m},kz:function(){return h}});var r=i(35754),s=i(43437),a=i(85886),o=i(46012),n=i(94284),l=i(90156),d=i(57672),c=i(29688),u=i(91184),p=i(72764);async function h(e){if(!e.store.draftId)throw new Error("DraftIdError");const t=await e._sdk.getPackageByKey(e.store.draftId);if(!t)throw new Error("DraftIdError");const i=await m(e,{md5s:t.assets.map((({md5:e})=>e))}),r=t.assets.map((e=>{var t;const r=i.find((t=>t.md5===e.md5));let s;return s=null==r||!r.hasMaterialTag||null!==(t=e.meta)&&void 0!==t&&t.visible?e.meta:{...e.meta||{},visible:!0},r?{...e,meta:s,material:r}:{...e,meta:s}})).sort(((e,t)=>(0,p.pi)(e.material,t.material)));return{meta:t.meta,syncId:t.id,assets:r}}async function f(e){return m(e,{material:!0})}async function m(e,t){if(Array.isArray(t.md5s)&&0===t.md5s.length)return Promise.resolve([]);let i=[];t.md5s?i=await e._sdk.getAssetsByMd5(t.md5s):t.material&&(i=await e._sdk.getAssets({}));const r=i.sort(p.$5).map((i=>(0,u.a1)(i)?Promise.resolve({assetId:i.id,md5:i.md5,size:i.size,progressDownload:0,progressTranscode:0,fileStatus:d.o.Online,groupType:"other",metaType:l.nC.MetaTypeNone}):(0,p.lj)(e,i,{skipStatus:t.skipStatus})));return await Promise.all(r)}let v=[],g=[];function y(e,t){if(!e)return;const i=g.filter((({md5:t})=>e===t));g=g.filter((({md5:t})=>e!==t));for(const r of i)r.resolve(t)}function _(e,t){if(!e)return;const i=g.filter((({md5:t})=>e===t));g=g.filter((({md5:t})=>e!==t));for(const r of i)r.reject(t)}const w=async(e,t,{delayMs:i=500,numTry:r=2}={})=>{if(!t.length)return{infos:[],status:0};try{return await e._sdk.sdk.get_asset_play_info({md5s:t})}catch(s){"string"!=typeof s?o.Zq.error("cloud","play info request failed","play_info",s):s.includes('"code":10000,')?o.Zq.warn("cloud","play info merge request caused some request full","play_info_merge_empty",new Error(s)):o.Zq.error("cloud","play info request failed (other)","play_info_other",new Error(s));const a=r-1;if(a<=0)throw s;return await(0,n.y)(i),await w(e,t,{delayMs:i,numTry:a})}},I=(0,a.A)((async e=>{var t;let i,a=v;if(v=[],0!==a.length){try{const t=(0,s.A)(a,15).map((t=>w(e,t))),n=await Promise.all(t);o=n,i={infos:(0,r.A)(o.map((e=>e.infos))),status:0}}catch(n){"string"==typeof n&&n.includes('"code":10000,')&&(i=void 0)}var o;if(null!==(t=i)&&void 0!==t&&t.infos)for(const e of i.infos)(0,c.wX)(e)?e.p480?(y(e.md5,e.p480),a=a.filter((t=>t!==e.md5))):e.p360?(y(e.md5,e.p360),a=a.filter((t=>t!==e.md5))):(console.warn("[FilerCloud#_genPlayInfo] file with md5:",e.md5,"has no play info"),_(e.md5,void 0),a=a.filter((t=>t!==e.md5))):(0,c.fN)(e)?(y(e.md5,e.audio),a=a.filter((t=>t!==e.md5))):(console.warn("[FilerCloud#_genPlayInfo] file with md5:",null==e?void 0:e.md5,"has an invalid type",i),_(null==e?void 0:e.md5,void 0),a=a.filter((t=>t!==(null==e?void 0:e.md5))));for(const e of a)_(e,void 0)}}),200);async function A(e,t){return new Promise((i=>{v.push(t),g.push({md5:t,resolve:i,reject:()=>i(void 0)}),I(e)}))}async function T(e,t){var i,r;const s=await e._sdk.sdk.get_asset_play_info({md5s:[t]});if((0,c.wX)(null==s||null===(i=s.infos)||void 0===i?void 0:i[0])){var a,o,n,l;const e=(null===(a=s.infos[0])||void 0===a?void 0:a.origin)||(null===(o=s.infos[0])||void 0===o?void 0:o.p720)||(null===(n=s.infos[0])||void 0===n?void 0:n.p480)||(null===(l=s.infos[0])||void 0===l?void 0:l.p360);return e||void console.warn("[FilerCloud#_genPlayInfo] file with md5:",t,"has no play info")}return(0,c.fN)(null==s||null===(r=s.infos)||void 0===r?void 0:r[0])?s.infos[0].audio:void console.warn("[FilerCloud#_genPlayInfo] file with md5:",t,"has an invalid type",s)}},61785:function(e,t,i){i.d(t,{fK:function(){return o}});var r=i(41048),s=i(46012),a=i(87549);i(59522),i(16649);async function o(e,t,i,o){const n=`${t}?#decrypt_key=${null!=i?i:""}`,l=await(0,r.Jt)(n).catch((e=>{s.Zq.log("idb_get_error","indexDb get cache error",e,{scene:"downloadDecryptBuf"})}));if(l)return null==o||o("idb"),l;const d=await e._sdk.downloadByUrlKey({url:t,key:i});return null==o||o((0,a.$)(t)),d.done().then((e=>"success"===e.status&&e.buffer?((0,r.hZ)(n,e.buffer).catch((e=>{s.Zq.log("idb_set_error","indexDB set cache error",e,{scene:"downloadDecryptBuf"})})),Promise.resolve(e.buffer)):Promise.reject(e)))}},71716:function(e,t,i){i.d(t,{gl:function(){return ae},kU:function(){return N.kU},wf:function(){return u.wf},fY:function(){return u.fY},ir:function(){return V}});var r=i(90843),s=i(71411),a=i(57672),o=i(99415),n=i(46012),l=i(64939),d=i(9012),c=i(59522),u=i(72764);const p=e=>{var t,i,r,s,a;if("success"!==e.status)return;if(null===(t=e.data)||void 0===t||!t.md5)return;const o=(null===(i=e.data)||void 0===i?void 0:i.p720)||(null===(r=e.data)||void 0===r?void 0:r.p480)||(null===(s=e.data)||void 0===s?void 0:s.p360)||(null===(a=e.data)||void 0===a?void 0:a.audio);return o?{url:o.primary_url,key:o.url_key}:void 0},h=(e,t)=>{e.store.packageAssetsUpdate(t),e.store.globalMaterialsUpdate({md5:t.md5,...t.material})};async function f(e,t,i,r){const s=(0,c.OY)(t,i,r);if(e.store.transcodeListenTasks.find((({md5:e})=>e===t)))return;let o;e.store.transcodeListenTasksAdd({md5:t});const l=(0,u.C1)(r);try{o=l?await e._sdk.getImagesTranscodeStatus([{md5s:[t],resolution:360}]):await e._sdk.getVideoAssetTranscodeStatus({md5:t})}catch(_){if("string"==typeof _&&_.includes('"code":10000,'))return n.Zq.log("transcode_merge_empty","transcode merge request caused some request full",_),e.store.dirtySet("transcode",!0),void e.store.transcodeListenTasksRemove({md5:t});throw n.Zq.error("cloud","transcode request failed","transcode",_),_}const f={md5:t,request:o};e.store.transcodeListenTaskUpdate(f);try{let i,r=!1;if(l){if(i=await o.done(),"success"===i.status){r=!0;const i=await m(e,t);h(e,{md5:t,material:{fileStatus:a.o.Online,...i&&{width:i.width,height:i.height,encryptedCover:i.encryptedCover}}}),e.store.dirtySet("visualInfo",!0)}}else{i=await o.done();const s=await m(e,t),n=p(i);n&&(r=!0,h(e,{md5:t,material:{fileStatus:a.o.Online,playInfo:n,...s&&{width:s.width,height:s.height}}}),e.store.dirtySet("visualInfo",!0),e.store.dirtySet("quickImportReplace",!0))}if(r)s.compound("success");else{var v;const r=l?(g=i,null===(y=Object.values(g.data||{}))||void 0===y?void 0:y[0]):null===(v=i.data)||void 0===v?void 0:v.status,a=(0,u.wf)(r),o=(0,u.fY)(r);s.compound("failed",{contents:{error:`[FilerCloud#invokeTranscodingListen] ${o}:${t}${i}`}}),console.warn(`[FilerCloud#invokeTranscodingListen]${o}:`,t,i),h(e,{md5:t,material:{fileStatus:a}})}}catch(_){const i=(0,u.wf)((0,d.A)(_,"errInfo.status")),r=(0,u.fY)((0,d.A)(_,"errInfo.status"));s.compound("failed",{contents:{error:`[FilerCloud#invokeTranscodingListen] ${r}:${t}${_}`}}),console.warn(`[FilerCloud#invokeTranscodingListen] ${r}:`,t,_),n.Zq.log("transcode_failed","file trancode failed by cloud api",_,{target:"cloud"}),h(e,{md5:t,material:{fileStatus:i}})}finally{e.store.transcodeListenTasksRemove({md5:t}),e.emit("burypoint:material_user",[s])}var g,y}async function m(e,t){await e._sdk.forceSyncPullUpdates();const i=await(0,N.kU)(e,{md5s:[t]});return(0,o.A)(i,1)[0]}var v=i(3317),g=i(29478),y=i(19974),_=i(8610),w=i(54079),I=i(90449),A=i(29688),T=i(61785),S=i(91184);function k(e){return"video"===e.groupType||"image"===e.groupType}function b(e){return"video"===e.groupType}function C(e){return"video"===e.groupType||"audio"===e.groupType}function x(e){const t=new Set;let i=!0;for(const r of e.store.packageAssets)(0,S.R$)(r.material)&&(k(r.material)&&!r.material.encryptedCover||b(r.material)&&!r.material.encryptedSprites||C(r.material)&&!r.material.duration)&&((0,A.Xn)(r.material.fileStatus)?t.add(r.md5):i=!1);for(const r of e.store.globalMaterials)(k(r)&&!r.encryptedCover||b(r)&&!r.encryptedSprites||C(r)&&!r.duration)&&((0,A.Xn)(r.fileStatus)?t.add(r.md5):i=!1);t.size&&function(e,t){const i="visual-info",s=[];for(const l of t){const t=e.store.visualFetchTasks.find((({md5:e,type:t})=>e===l&&t===i));t?"doing"===t.status||"failed"===t.status||(Date.now()-t.firstIn>r.yp?e.store.visualFetchTasksUpdate({md5:l,type:i,status:"failed"}):s.push(l)):s.push(l)}if(!s.length)return;const a=Date.now(),o=s.map((e=>({md5:e,type:i,status:"doing",firstIn:a})));e.store.visualFetchTasksInsertOrUpdateBatch(o);const n=e.store.packageAssets.filter((e=>s.includes(e.md5)));for(const r of n)M(e,r,i)}(e,Array.from(t)),i&&e.store.dirtySet("visualInfo",!1)}async function P(e,t,i,s,o){const l=(0,c.y8)(t,i.url,null!=o&&o.isImage?"image/jpeg":"image/gif",e),d=l.onSuccess,u=l.onFail,p="cover",h=e.store.visualFetchTasks.find((({md5:e,type:i})=>e===t&&i===p));if(h){if("doing"===h.status||"failed"===h.status)return void u("Cover exists but status is doing or failed.");if(Date.now()-h.firstIn>r.yp)return e.store.visualFetchTasksUpdate({md5:t,type:p,status:"failed"}),void u("Cover exists but timeout.")}let f,m;e.store.visualFetchTasksInsertOrUpdate({md5:t,type:p,status:"doing",firstIn:Date.now()});try{try{m=await(0,T.fK)(e,i.url,i.key),f=URL.createObjectURL(new Blob([m],{type:"image/jpg"}))}catch(A){console.warn("[FilerCloud#placeCover] fetch cover error:",A),n.Zq.log("download_assets_cover_error","download asset cover failed",A),m=await(0,w.L)(s.width||50,s.height||50,"#000000","image/jpg"),f=URL.createObjectURL(new Blob([m],{type:"image/jpg"}))}}catch(A){console.warn("[FilerCloud#placeCover] gen placeholder error:",A),n.Zq.log("download_assets_cover_error","download asset cover failed",A),f=void 0}const v={md5:t};if(f&&(v.coverUrl=f),null!=o&&o.isImage&&(v.fileStatus=a.o.Online),f&&(!s.width||!s.height))try{const e=await(0,g.G)(f),t=e.width,i=e.height;v.width=t,v.height=i}catch(A){console.warn("fix the cover size failed",A),n.Zq.warn("cloud","fix the cover size failed","cover_fix_size",A,{md5:t})}try{return e.store.packageAssetsUpdate({md5:t,material:v}),e.store.globalMaterialsUpdate({...v,md5:t}),d("none"),f}catch(A){var y,_,I;return u(`[Asset#placeCover] meets error ${null!==(y=null==A||null===(_=(I=A).toString)||void 0===_?void 0:_.call(I))&&void 0!==y?y:""}`),n.Zq.warn("cloud","[Asset#placeCover] meets error","cover_place",A,{md5:t}),void console.warn("[Asset#placeCover] meets error",A)}finally{e.store.visualFetchTasksUpdate({md5:t,type:p,status:"idle"})}}async function U(e,t,i){const s=i.map(((e,r,s)=>(0,c.S8)(t,i.length,s.map((e=>e.url))))),a=i.map(((e,r,s)=>(0,c.XO)(t,i.length,s.map((e=>e.url))))),o="sprite",l=e.store.visualFetchTasks.find((({md5:e,type:i})=>e===t&&i===o));if(l){if("doing"===l.status||"failed"===l.status)return s.forEach((e=>{e.compound("success",{categories:{hit_cache:"exist"}})})),void e.emit("burypoint:material_user",s);if(Date.now()-l.firstIn>r.yp)return s.forEach((e=>{e.compound("success",{categories:{hit_cache:"exist"}})})),e.emit("burypoint:material_user",s),void e.store.visualFetchTasksUpdate({md5:t,type:o,status:"failed"})}e.store.visualFetchTasksInsertOrUpdate({md5:t,type:o,status:"doing",firstIn:Date.now()});try{const r=await Promise.all(i.map(((i,r)=>(0,T.fK)(e,i.url,i.key,(e=>t=>{s[e].categories.hit_cache=t})(r)).then((e=>(s[r].compound("success"),a[r].compound("start"),(0,y.B)(e,{mimeType:"image/jpg",count:i.count,x:i.x,y:i.y},{compress:{height:_.$n},thresholdBlockSize:{width:_.qF*i.ratio,height:_.qF}}).catch((e=>(n.Zq.warn("cloud","[Asset#placeSprite] meets error","sprite_split",e,{md5:t}),[]))))),(t=>(s[r].compound("failed",{contents:{error:`[Asset#placeSprite] meets error ${null==t?void 0:t.message}`}}),e.emit("burypoint:material_user",[s[r]]),console.warn("[Asset#placeSprite] meets error",t),[])))))),o=r.reduce(((e,t)=>[...e,...t]),[]);return r.forEach(((e,t)=>{e.length?a[t].compound("success",{metrics:{total_count:o.length}}):a[t].compound("failed",{metrics:{total_count:o.length},contents:{error:"split sprite failed"}})})),e.store.packageAssetsUpdate({md5:t,material:{spriteData:o}}),e.store.globalMaterialsUpdate({md5:t,spriteData:o}),s.forEach((e=>{"start"===e.status&&e.compound("success",{metrics:{total_count:o.length}})})),e.emit("burypoint:material_user",[...s,...a]),o}catch(d){return s.forEach((e=>{e.compound("failed",{contents:{error:`placeSprite failed: ${null==d?void 0:d.message}`}})})),e.emit("burypoint:material_user",s),n.Zq.warn("cloud","[Asset#placeSprite] meets error","sprite_place",d,{md5:t}),console.warn("[Asset#placeSprite] meets error:",d),[]}finally{e.store.visualFetchTasksUpdate({md5:t,type:o,status:"idle"})}}async function F(e,t){const i="cover-bucket",s=e.store.visualFetchTasks.find((({md5:e,type:r})=>e===t.md5&&r===i));if(s){if("doing"===s.status||"failed"===s.status)return;if(Date.now()-s.firstIn>r.yp)return void e.store.visualFetchTasksUpdate({md5:t.md5,type:i,status:"failed"})}e.store.visualFetchTasksInsertOrUpdate({md5:t.md5,type:i,status:"doing",firstIn:Date.now()});try{var a;null!==(a=t.material)&&void 0!==a&&a.coverUrl}catch(o){console.warn("[Asset#placeSpriteImage] meets error:",o),n.Zq.warn("cloud","[Asset#placeSprite] meets error","sprite_place_image",o,{md5:t.md5})}finally{e.store.visualFetchTasksUpdate({md5:t.md5,type:i,status:"idle"})}}async function L(e,t,i,r){const a="sprite",o=e.store.visualFetchTasks.find((({md5:e,type:i})=>e===t.id&&i===a));if(!o||"doing"!==o.status&&"failed"!==o.status){e.store.visualFetchTasksInsertOrUpdate({md5:t.id,type:a,status:"doing",firstIn:Date.now()});try{return await(0,s.AD)(i,r)}catch(l){return console.warn("[Asset#placeQuickImportSprite] meets error:",l),n.Zq.warn("cloud","[Asset#placeQuickImportSprite] meets error","sprite_quick_import_place_image",l,{id:t.id}),[]}finally{e.store.visualFetchTasksUpdate({md5:t.id,type:a,status:"idle"})}}}async function E(e,t,i,r){const s="waves",a=e.store.visualFetchTasks.find((({md5:e,type:i})=>e===t.id&&i===s));if(!a||"doing"!==a.status&&"failed"!==a.status){e.store.visualFetchTasksInsertOrUpdate({md5:t.id,type:s,status:"doing",firstIn:Date.now()});try{return await(0,v.j)(r)}catch(o){return console.warn("[Asset#placeQuickImportWaves] meets error:",o),n.Zq.warn("cloud","[Asset#placeQuickImportWaves] meets error","wave_quick_import_place",o,{id:t.id}),[]}finally{e.store.visualFetchTasksUpdate({md5:t.id,type:s,status:"idle"})}}}async function M(e,t,i){try{await Promise.all([O(e,t.md5),R(e,t)])}catch(r){e.store.visualFetchTasksUpdate({md5:t.md5,type:"visual-info",status:"idle"}),e.store.dirtySet("visualInfo",!0),console.warn("[Asset#placeVisualInfo] meets error:",r),n.Zq.warn("cloud","[Asset#placeVisualInfo] meets error","visual_place",r,{md5:t.md5})}finally{e.store.visualFetchTasksUpdate({md5:t.md5,type:i,status:"idle"})}}async function O(e,t){const i=(0,c.tZ)(t,e),r=i.onInfoSpriteSuccess,s=i.onInfoSpriteFail,a=await e._sdk.getAssetSpirtInfo({md5:t}),o=()=>{e.store.visualFetchTasksUpdate({md5:t,type:"visual-info",status:"idle"}),e.store.dirtySet("visualInfo",!0)};try{const t=await a.done();if("success"===t.status&&t.data){const i=await(0,u.lj)(e,t.data,{skipStatus:!1});if(i.encryptedSprites){const t={md5:i.md5,encryptedSprites:i.encryptedSprites};e.store.packageAssetsUpdate({md5:i.md5,material:t}),e.store.globalMaterialsUpdate(t),e.store.dirtySet("visual",!0),(C(i)&&!i.duration||k(i)&&!i.encryptedCover||b(i)&&!i.encryptedSprites)&&o()}else o();r(i)}else o()}catch(l){s(l),n.Zq.warn("cloud","[Asset#listenSpritesInfo] meets error","sprite_info_listen",l,{md5:t}),o()}}async function R(e,t){const i=()=>{e.store.visualFetchTasksUpdate({md5:r,type:"visual-info",status:"idle"}),e.store.dirtySet("visualInfo",!0)},r=t.md5,s=(0,c.KN)(r,e),a=s.onInfoDurationSuccess,o=s.onInfoDurationFail,l=(0,c.v$)(r,e),d=l.onInfoCoverSuccess,p=l.onInfoCoverFail;try{let s=null;const n=t.material;if(n){const t=k(n);if(C(n)&&!t){await e._sdk.forceSyncPullUpdates();s=(await e._sdk.getAssetsByMd5([r]))[0]}}if(!s){const t=await e._sdk.getAssetPreviewInfo({md5:r}),i=await t.done();"success"===i.status&&i.data&&(s=i.data)}if(!s)throw o("encryptedCover and duration info not ready"),p("encryptedCover and duration info not ready"),i(),new Error("cover and duration info not ready");{const t=await(0,u.lj)(e,s,{skipStatus:!1}),r={md5:t.md5,encryptedCover:t.encryptedCover,duration:t.duration};t.encryptedCover&&(r.encryptedCover=t.encryptedCover),t.duration&&(r.duration=t.duration),r.encryptedCover||r.duration?(e.store.packageAssetsUpdate({md5:t.md5,material:r}),e.store.globalMaterialsUpdate(r),e.store.dirtySet("visual",!0),(!C(t)||t.duration)&&(!k(t)||t.encryptedCover)&&(!b(t)||t.encryptedSprites),a(t),d(t)):(o("encryptedCover and duration info not ready"),p("encryptedCover and duration info not ready"),i())}}catch(v){var h,f,m;const e=`[FilerCloud#invokeCoverSpriteListener] get cover and duration failed: ${r} ${null!==(h=null==v||null===(f=(m=v).toString)||void 0===f?void 0:f.call(m))&&void 0!==h?h:""}`;o(e),p(e),n.Zq.warn("cloud","[Asset#listenSpritesInfo] meets error","info_cover_duration",v,{md5:r}),i()}}var j=i(29328);let K=r.sS;function V(e,t){let i=window.setInterval((()=>{var o;if("destroyed"===e.lifecycle)return window.clearInterval(i),void(i=0);e.store.userId&&(K=K<1?r.sS:K-1,function(e){if(q=q<1?r.tf:q-1,q!==r.tf)return;const t=Date.now(),i=[];for(const r of e.store.packageAssets){var o;(null===(o=r.material)||void 0===o?void 0:o.fileStatus)===a.o.Transcoding&&r.material.updatedAt&&i.push({md5:r.md5,material:{progressTranscode:(0,s.U$)(t,r.material.updatedAt,r.material.size)}})}const n=[];for(const r of e.store.globalMaterials)r.fileStatus===a.o.Transcoding&&r.updatedAt&&n.push({md5:r.md5,progressTranscode:(0,s.U$)(t,r.updatedAt,r.size)});e.store.packageAssetsUpdateBatch(i),e.store.globalMaterialsUpdateBatch(n)}(e),t[j.TM].dirty.transcode&&function(e){for(const o of e.store.packageAssets){var t,i,r,s;(null===(t=o.material)||void 0===t?void 0:t.fileStatus)!==a.o.Transcoding&&(null===(i=o.material)||void 0===i?void 0:i.fileStatus)!==a.o.TranscodeFailed||(0,l.h3)(o.material)||f(e,o.md5,null===(r=o.material)||void 0===r?void 0:r.name,null===(s=o.material)||void 0===s?void 0:s.groupType)}for(const o of e.store.globalMaterials)(null==o?void 0:o.fileStatus)!==a.o.Transcoding&&(null==o?void 0:o.fileStatus)!==a.o.TranscodeFailed||(0,l.h3)(o)||f(e,o.md5,o.name,o.groupType);e.store.dirtySet("transcode",!1)}(e),t[j.TM].dirty.visual&&function(e){for(const s of e.store.packageAssets){var t,i;(0,S.R$)(s.material)&&(s.material.coverUrl||!s.material.encryptedCover||(0,l.h3)(s.material)||P(e,s.md5,s.material.encryptedCover,{width:s.material.width,height:s.material.height},{isImage:"image"===s.material.groupType}).then((()=>{F(e,s)})),null!==(t=s.material.spriteData)&&void 0!==t&&t.length||(0,l.h3)(s.material)||s.material.encryptedSprites&&U(e,s.md5,s.material.encryptedSprites),s.material.audioUrl||null!==(i=s.material.waves)&&void 0!==i&&i.length||"video"!==s.material.groupType&&"audio"!==s.material.groupType||s.material.duration&&e.store.packageAssetsUpdate({md5:s.md5,material:{waves:(0,v.j)(s.material.duration)}}))}for(const s of e.store.globalMaterials){var r;if(s.coverUrl||!s.encryptedCover||(0,l.h3)(s)||P(e,s.md5,s.encryptedCover,{width:s.width,height:s.height},{isImage:"image"===s.groupType}),s.audioUrl);else if(!(null!==(r=s.waves)&&void 0!==r&&r.length||"video"!==s.groupType&&"audio"!==s.groupType)&&s.duration){const t=(0,v.j)(s.duration);e.store.packageAssetsUpdate({md5:s.md5,material:{waves:t}}),e.store.globalMaterialsUpdate({md5:s.md5,waves:t})}}e.store.dirtySet("visual",!1)}(e),t[j.TM].dirty.quickImportVisual&&function(e){const t="visual-info";for(const i of e.store.uploadFiles)null!=i&&i.material&&!(0,l.h3)(null==i?void 0:i.material)&&(e.store.visualFetchTasks.find((({md5:e,type:r})=>e===i.id&&r===t))||(e.store.visualFetchTasksInsertOrUpdate({md5:i.id,type:t,status:"doing",firstIn:Date.now()}),(0,s.D$)(i.file).then((async r=>{const a=await(0,s.Fk)(r,i.file.type);if(isFinite(a)){e.store.uploadFilesUpdate({file:i.file,material:{duration:a}});try{const s=await Promise.all([L(e,i,r,a),E(e,i,0,a)]);e.store.uploadFilesUpdate({file:i.file,material:{spriteData:s[0],waves:s[1]}}),e.store.visualFetchTasksUpdateBatch([{md5:i.id,type:t,status:"idle"}])}catch(o){n.Zq.warn("cloud","no idea","visual_quick_import_batch",o),e.store.visualFetchTasksUpdateBatch([{md5:i.id,type:t,status:"failed"}])}}else e.store.uploadFilesUpdate({file:i.file,material:{duration:I.Dx}})}))));e.store.dirtySet("quickImportVisual",!1)}(e),t[j.TM].dirty.visualInfo&&K===r.sS&&x(e),null!==(o=t.profile)&&void 0!==o&&o.uid&&"doing"!==t.filerCloudStore.state.meta&&"doing"!==t.filerCloudStore.state.upgrade&&"doing"!==t.filerCloudStore.state.migrate&&t.persistStore.save())}),r.QT)}let q=r.tf;var N=i(16649),D=i(40492),z=i(87759),W=i(92439),B=i(89243),$=i(14148),Z=i(42958),H=i(52179),G=i(77024),Y=i(94284),Q=i(16940),J=i(59448),X=i(46320),ee=i(50501);const te=new Map;async function ie(e,t,i){var r;const s=(0,c.i0)(t);if(!1===(null===(r=e._options)||void 0===r||null===(r=r.switch)||void 0===r?void 0:r.upload))throw new Error("upload switched off!");let o,l=!1;i.forceFilePath&&(l=!0,o=i.forceFilePath,delete i.forceFilePath);const d=!1,p={file:t,skipDuplicate:i.skipDuplicate};i.fileType&&(p.fileType=i.fileType);const h={auth:"cloud",coverUrl:"",requestId:"",request:void 0,options:i,file:t,progress:0,fileStatus:a.o.Uploading,...(0,u.kW)(t,d,i)};let f;e.store.uploadFilesAdd(h),e._options.dependencies.validateEverCloudFileAccept({file:t,accepts:["video"]})&&(0,Q.AY)({input:{file:t,type:J.fl.File},output:{type:J.YY.ObjectURL}}).then((i=>{var r;if(null!=i&&null!==(r=i[0])&&void 0!==r&&r.url){const r=i[0].url;e.store.uploadFilesUpdate({file:t,coverUrl:r})}}),(e=>{console.warn("get first screen shot error:",e)}));try{f=await e._sdk.uploadAsset(p),e.store.uploadFilesUpdate({file:t,request:f,requestId:f.requestId})}catch(m){throw n.Zq.error("cloud","cloud sdk upload failed","upload_pre_failed",m,{name:t.name,mimeType:t.type,size:t.size}),e.store.uploadFilesRemove({file:t}),s.compound("failed",{contents:{error:"already exist same name file"}}),new Error($.F2.t("there_is_already_a_file_with_the_same_name_in_the_cloud_space",{},"This file name already exists in Cloud Space."))}f.onProgress=({done:i,total:r})=>{e.store.uploadFilesUpdate({file:t,progress:i/r})};return await re({request:f,filePath:o,updateByPath:l,isSupportQuickImport:d,uploadStatus:h,filerCloud:e,materialSource:"local",file:t,perfPointUpload:s,options:i})}async function re({request:e,filePath:t,updateByPath:i,isSupportQuickImport:r,uploadStatus:l,filerCloud:d,materialSource:c,file:u,perfPointUpload:p,options:h}){try{var f;const _=await e.done();if(n.Zq.log("cloud_upload_result","cloud upload result",void 0,{name:u.name,mimeType:u.type,size:u.size,md5:null!==(f=null==_?void 0:_.md5)&&void 0!==f?f:""}),!d.store.uploadFiles.find((e=>e.file===u)))return _.status="cancel",_;if("success"===_.status&&_.md5){var m;let a;await d._sdk.forceSyncPullUpdates();var v=await(0,N.kU)(d,{md5s:[_.md5]});if(a=(0,o.A)(v,1)[0],!a){await(0,Y.y)(200);var g=await(0,N.kU)(d,{md5s:[_.md5]});a=(0,o.A)(g,1)[0]}if(a||(p.compound("failed",{contents:{error:"failed to get material"}}),n.Zq.error("cloud","failed to get material","failed to get material",void 0,{name:u.name,mimeType:u.type,size:u.size,md5:null==_?void 0:_.md5})),!t){var y;let e=H.extname(u.name);if(null!==(y=a)&&void 0!==y&&y.ext)e=a.ext;t=(0,s.Oo)({md5:_.md5,ext:e})}a?a.materialSource=c:(G.A.warning($.F2.t("failed_to_pull_new_file_information_please_refresh_manually",{},"Couldn't get new file. Refresh manually.")),p.compound("failed",{contents:{error:"failed to pull new file information"}})),i?d.store.packageAssetsInsertOrUpdateByPath({md5:_.md5,path:t,meta:h.meta||void 0,material:a,...r?{quickImportId:l.id}:{}}):d.store.packageAssetsInsertOrUpdate({md5:_.md5,path:t,meta:h.meta||void 0,material:a,...r?{quickImportId:l.id}:{}}),a&&d.store.globalMaterialsInsertOrUpdate(a),r&&l.id?(!function(e,t){if(te.get(t))return;const i=e.store.packageAssets.find((e=>e.quickImportId===t&&e.material));if(null!=i&&i.material)if((0,X.a6)(i.material.fileStatus))e.store.dirtySet("quickImportReplace",!0);else{const r=(0,ee.Zc)(i.material,"fileStatus",(i=>{if(!i.newValue)return null;const r=e.store.uploadFiles.find((e=>e.id===t));return r?(e.store.uploadFilesUpdate({file:null==r?void 0:r.file,fileStatus:i.newValue}),(0,X.a6)(i.newValue)&&(e.store.dirtySet("quickImportReplace",!0),null===(s=te.get(t))||void 0===s||s(),te.delete(t)),i):i;var s}));te.set(t,r)}}(d,l.id),d.store.uploadFilesUpdate({file:u,material:{md5:_.md5}})):d.store.uploadFilesRemove({file:u}),d.store.dirtySet("transcode",!0),d.store.dirtySet("upgrade",!0),!a||C(a)&&!a.duration||k(a)&&!a.encryptedCover||b(a)&&!a.encryptedSprites?d.store.dirtySet("visualInfo",!0):d.emit("proxy:eventbus",{event:"filer:visualTranscodeSuccess",args:[{md5OrFileId:_.md5,type:"visual",auth:"cloud"}]}),a&&(0,X.a6)(a.fileStatus)&&d.emit("proxy:eventbus",{event:"filer:visualTranscodeSuccess",args:[{md5OrFileId:_.md5,type:"transcode",auth:"cloud"}]}),(!a||C(a)&&void 0!==a.duration||a&&k(a)&&a.encryptedCover||b(a)&&a.encryptedSprites)&&d.store.dirtySet("visual",!0),p.compound("success",{categories:{request_id:e.requestId,file_status:null===(m=a)||void 0===m?void 0:m.fileStatus}}),_.material=a}else"cancel"===_.status?(d.store.uploadFilesRemove({file:u}),p.compound("failed",{contents:{error:"upload cancel"}})):(d.store.uploadFilesUpdate({file:u,progress:0,fileStatus:a.o.UploadFailed}),p.compound("failed",{contents:{error:"upload failed, no enough space or other errors"}}));return d.emit("burypoint:material_user",[p]),_}catch(I){var _,w;throw console.warn("upload failed",I),20113===(null==I||null===(_=I.errInfo)||void 0===_?void 0:_.code)?n.Zq.log("cloud_photo_album","cloud cache overflow",I,{scene:"afterUploadSuccess"}):"cancel"===I.status?n.Zq.log("cloud_photo_album","cloud upload failed by cancel",I,{type:"cancel",scene:"afterUploadSuccess"}):n.Zq.error("cloud","upload failed","upload_failed",I,{name:u.name,mimeType:u.type,size:u.size}),d.store.uploadFilesUpdate({file:u,progress:0,fileStatus:a.o.UploadFailed}),p.compound("failed",{contents:{error:`upload failed: ${null==I||null===(w=I.toString)||void 0===w?void 0:w.call(I)}`}}),d.emit("burypoint:material_user",[p]),I}}var se;var ae=(0,z.p)(se=(0,W.h)(se=class{constructor(e,t){(0,D.A)(this,"_lifeSequence",{initialized:0,mounted:1,setup:2,destroyed:3}),(0,D.A)(this,"_lifecycle","initialized"),(0,D.A)(this,"_options",void 0),(0,D.A)(this,"store",void 0),(0,D.A)(this,"_sdk",void 0),(0,D.A)(this,"_fs",void 0),this._options=e,this.store=t,this._sdk=this._options.dependencies.EverCloud}relinquish(){this.lifecycle="destroyed"}async mount(e,t){var i,s,a;const o=(t||{}).loginSdk,n=(null==o||null===(i=o.profile)||void 0===i?void 0:i.spaceInfo)||{},l=n.spaceId,d={base:n.spaceHost,media:n.spaceResHost};this.store.userIdSet(e);const c={space:l,is_boe:B.SC,user_id:e,level:r.bu,dc_name:t.idc,netconf:d,reqDomain:Z.s.getVars()};this._sdk.setOptions(c),!1===this.store.isPersonal&&(null===(s=(a=this._sdk).setPermission)||void 0===s||s.call(a,this.store.permission)),await this._sdk.init(),this.lifecycle="mounted"}async identify(e,t){const i=t||{},r=i.idc,s=i.spaceId,a=i.netconf;this.store.userIdSet(e);const o={space:s,is_boe:B.SC,user_id:e,level:"error",dc_name:r,netconf:a,reqDomain:Z.s.getVars()};this._sdk.setOptions(o),await this._sdk.init(),this.emit("identified")}async setupPackage(e){this.store.draftIdSet(e.draftId);const t=[];this.store.userId&&t.push(this.refreshGlobalMaterials()),e.newWorkspace||t.push(this.refreshPackageAssets(!0)),await Promise.all(t),this.lifecycle="setup"}async refreshPackageAssets(e,t=!1){if(!this.store.draftId)throw new Error("[FilerCloud#updatePackageAsset] no _draftId!");if(!this.store.syncId&&!e)return void console.warn("[FilerCloud#updatePackageAsset] no need for updatePackageAsset for new Draft!");const i=await(0,N.kz)(this),r=i.meta,s=i.syncId,a=i.assets;this.store.draftMetaSet(r),this.store.packageAssetsSet(a,t),t||(this.store.dirtySet("transcode",!0),this.store.dirtySet("visual",!0),this.store.dirtySet("visualInfo",!0)),e&&this.store.syncIdSet(s)}async refreshGlobalMaterials(e=!1){const t=await(0,N.el)(this);this.store.globalMaterialsSet(t,e),e||(this.store.dirtySet("transcode",!0),this.store.dirtySet("visual",!0),this.store.dirtySet("visualInfo",!0))}async upload(e,t){if("application/json"!==e.type&&!this._options.dependencies.validateEverCloudFileAccept({file:e}))throw new Error($.F2.t("current_import_format_not_supported",{},"Current import format is not supported"));if(e.size>this._options.limit.cloud.single)throw new Error($.F2.t("only_supports_materials_up_to_{size}",{size:(0,s.iP)(this._options.limit.cloud.single)},"Only materials up to {size} are supported"));return ie(this,e,t)}async uploadThird(e,t,i){return async function(e,t,i,r){const s=(0,c.i0)(t.file);return e.store.uploadFilesAdd(t),t.request.onProgress=({progress:i})=>{e.store.uploadFilesUpdate({file:t.file,progress:i})},await re({request:t.request,filePath:"",updateByPath:!1,isSupportQuickImport:!1,uploadStatus:t,filerCloud:e,file:t.file,perfPointUpload:s,materialSource:i,options:r})}(this,e,t,i)}uploadThirdCancel(e){return function(e,t){const i=e.store.uploadFiles.find((({file:e})=>e===t));if(!i)throw new Error($.F2.t("the_record_was_not_found!",{},"Couldn't find record"));e.store.uploadFilesRemove({file:i.file})}(this,e)}async uploadRetry(e){return async function(e,t){const i=e.store.uploadFiles.find((({requestId:e})=>e===t));if(!i)throw new Error($.F2.t("the_record_was_not_found!",{},"Couldn't find record"));return e.store.uploadFilesRemove({file:i.file}),ie(e,i.file,i.options)}(this,e)}async uploadRetryByFile(e){return async function(e,t){const i=e.store.uploadFiles.find((({file:e})=>e===t));if(!i)throw new Error($.F2.t("the_record_was_not_found!",{},"Couldn't find record"));return e.store.uploadFilesRemove({file:i.file}),ie(e,i.file,i.options)}(this,e)}async uploadCancel(e){await this._sdk.sdk.cancel_upload(e),this.store.uploadFilesRemove({requestId:e})}async updatePlayInfo(e,t,i){let r,o,n=!1;const d=this.store.packageAssets.find((({md5:t})=>e===t));if(null!=d&&d.path&&d.material)r=d.material,o=d.path;else{if(r=this.store.globalMaterials.find((({md5:t})=>e===t)),!r)throw new Error("no such material");o=(0,s.Oo)(r),t&&(n=!0)}var c;if(!["video","audio"].includes(r.groupType)||(0,l.h3)(r))return{md5:r.md5,filePath:o,url:r.downloadUrl||"",decryptKey:null===(c=r.meta)||void 0===c?void 0:c.key};let u=r.playInfo;if(!u){const e=await(0,N.b1)(this,r.md5);if(!e)throw new Error("cant play");u={key:e.url_key,url:e.primary_url},this.store.packageAssetsUpdate({md5:r.md5,meta:i,material:{playInfo:u}}),this.store.globalMaterialsUpdate({md5:r.md5,playInfo:u})}return n&&(this.store.packageAssetsInsertOrUpdate({md5:r.md5,path:o,meta:i,material:{...r,fileStatus:a.o.Online}}),this.store.dirtySet("upgrade",!0),this.store.dirtySet("visual",!0)),{filePath:o,url:u.url,decryptKey:u.key}}})||se)||se},29328:function(e,t,i){i.d(t,{TM:function(){return M.T}});var r,s,a,o,n,l,d,c,u,p,h,f,m,v,g,y,_,w,I,A,T,S,k,b=i(38690),C=i(40492),x=i(94185),P=i(50501),U=i(91776),F=i(64939),L=i(91184),E=i(72764),M=i(88650);let O=(r=class{get visualPackageAssets(){return this.packageAssets.slice().sort(((e,t)=>(0,E.pi)(e.material,t.material))).filter((e=>{var t;return!!(0,L.vK)(e)&&(!(0,F.h3)(e.material)&&(!e.quickImportId&&Boolean(e.material.hasMaterialTag||(null===(t=e.meta)||void 0===t?void 0:t.visible))))}))}get visualGlobalMaterials(){return this.globalMaterials.slice().sort(E.pi).filter((e=>!(0,F.h3)(e)&&this._filerAccept(e.type)))}constructor(e){(0,b.A)(this,"userId",s,this),(0,b.A)(this,"syncId",a,this),(0,b.A)(this,"draftId",o,this),(0,b.A)(this,"draftMeta",n,this),(0,b.A)(this,"packageAssets",l,this),(0,b.A)(this,"resetSpaceStorage",d,this),(0,b.A)(this,"globalMaterials",c,this),(0,b.A)(this,"globalMaterialsLoading",u,this),(0,b.A)(this,"uploadFiles",p,this),(0,b.A)(this,"visualFetchTasks",h,this),(0,b.A)(this,"transcodeListenTasks",f,this),(0,b.A)(this,"replaceListenTasks",m,this),(0,b.A)(this,"quickImportDownloadListenTasks",v,this),(0,b.A)(this,"decryptAlbum",g,this),(0,b.A)(this,"visualFailedBucket",y,this),(0,b.A)(this,"state",_,this),(0,b.A)(this,"dirty",w,this),(0,b.A)(this,"timestamp",I,this),(0,b.A)(this,"errorMessage",A,this),(0,b.A)(this,"invalids",T,this),(0,b.A)(this,"thirdImportGrayConfig",S,this),(0,b.A)(this,"autoSaveRunning",k,this),(0,C.A)(this,"_options",void 0),(0,C.A)(this,"_filerAccept",void 0),(0,C.A)(this,"isPersonal",null),(0,C.A)(this,"spaceId",""),(0,C.A)(this,"permission",1),e.permission&&(this.permission=Number(e.permission)),this._options=e,e.thirdImportEnable&&(this.thirdImportGrayConfig={dropbox:!0,google:!0}),this._filerAccept=(0,E.Om)(this,{_options:this._options}),(0,P.l_)(this,{_options:!1,_filerAccept:!1,isPersonal:!1,spaceId:!1,permission:!1})}userIdSet(e){(0,P.h5)((()=>{this.userId=e}))}syncIdSet(e){(0,P.h5)((()=>{this.syncId=e}))}draftIdSet(e){(0,P.h5)((()=>{this.draftId=e}))}draftMetaSet(e){(0,P.h5)((()=>{this.draftMeta=e}))}packageAssetsSet(e,t=!1){(0,P.h5)((()=>{if(t){const t=[],i=[];for(const r of e){const e=this.packageAssets.findIndex((e=>(null==r?void 0:r.md5)===(null==e?void 0:e.md5)));if(-1===e)t.unshift(r);else{const t=this.packageAssets[e],s=t.material?t:{...t,...r};i.push(s)}}i.unshift(...t),this.packageAssets=i}else{this.packageAssets=e;for(const t of e)this.visualFailedBucketUpdateIfFailed(t.md5,t.path)}}))}packageAssetsUpdate(e){(0,P.h5)((()=>{const t=this.packageAssets.findIndex((({md5:t})=>e.md5===t));-1!==t&&(Object.prototype.hasOwnProperty.call(e,"path")&&(this.packageAssets[t].path=e.path),Object.prototype.hasOwnProperty.call(e,"material")&&Object.assign(this.packageAssets[t].material,e.material))}))}packageAssetsUpdateByPath(e){(0,P.h5)((()=>{const t=this.packageAssets.findIndex((({path:t})=>e.path===t));-1!==t&&Object.prototype.hasOwnProperty.call(e,"material")&&Object.assign(this.packageAssets[t].material,e.material)}))}packageAssetsInsertOrUpdate(e){(0,P.h5)((()=>{const t=this.packageAssets.findIndex((t=>(null==t?void 0:t.md5)===(null==e?void 0:e.md5)));-1===t?(this.packageAssets.unshift(e),this.visualFailedBucketUpdateIfFailed(e.md5,e.path)):(Object.assign(this.packageAssets[t],(0,U.A)(e,"material")),Object.assign(this.packageAssets[t].material,e.material))}))}globalMaterialsInsertOrUpdate(e){(0,P.h5)((()=>{const t=this.globalMaterials.findIndex((t=>(null==t?void 0:t.md5)===(null==e?void 0:e.md5)));-1===t?this.globalMaterials.unshift(e):Object.assign(this.globalMaterials[t],e)}))}packageAssetsInsertOrUpdateByPath(e){(0,P.h5)((()=>{const t=this.packageAssets.findIndex((({path:t})=>t===e.path));-1===t?(this.packageAssets.unshift(e),this.visualFailedBucketUpdateIfFailed(e.md5,e.path)):(Object.assign(this.packageAssets[t],(0,U.A)(e,"material")),Object.assign(this.packageAssets[t].material,e.material))}))}packageAssetsUpdateBatch(e){for(const t of e)this.packageAssetsUpdate(t)}packageAssetsRemove(e){(0,P.h5)((()=>{const t=this.packageAssets.findIndex((({md5:t})=>e.md5===t));-1!==t&&this.packageAssets.splice(t,1)}))}packageAssetsReset(){(0,P.h5)((()=>{this.packageAssets=[]}))}globalMaterialsSet(e,t=!1){(0,P.h5)((()=>{if(t){const t=[],i=[];for(const r of e){const e=this.globalMaterials.findIndex((({md5:e})=>r.md5===e));if(-1===e)t.unshift(r);else{const t={...this.globalMaterials[e],...r};i.push(t)}}i.unshift(...t),this.globalMaterials=i}else this.globalMaterials=e;this.globalMaterialsLoading=!1}))}globalMaterialsUpdate(e){(0,P.h5)((()=>{this.globalMaterials.filter((({id:t,md5:i})=>e.id&&t?t===e.id:i===e.md5)).forEach((t=>{Object.assign(t,e)}))}))}globalMaterialsUpdateBatch(e){for(const t of e)this.globalMaterialsUpdate(t)}uploadFilesAdd(e){(0,P.h5)((()=>{this.uploadFiles.unshift(e)}))}uploadFilesUpdate(e){(0,P.h5)((()=>{const t=this.uploadFiles.find((({file:t})=>t===e.file));if(t){if(Object.assign(t,(0,U.A)(e,"material")),!t.material)return;Object.prototype.hasOwnProperty.call(e,"material")&&Object.assign(t.material,e.material)}}))}uploadFilesRemove(e){(0,P.h5)((()=>{let t=-1;e.file?t=this.uploadFiles.findIndex((({file:t})=>t===e.file)):e.requestId&&(t=this.uploadFiles.findIndex((({requestId:t})=>t===e.requestId))),-1!==t&&this.uploadFiles.splice(t,1)}))}visualFetchTasksAdd(e){(0,P.h5)((()=>{this.visualFetchTasks.unshift(e)}))}visualFetchTasksUpdate(e){(0,P.h5)((()=>{const t=this.visualFetchTasks.findIndex((({md5:t,type:i})=>t===e.md5&&i===e.type));-1!==t&&(Object.assign(this.visualFetchTasks[t],(0,U.A)(e,["firstIn"])),this.visualFailedBucketUpdateIfExist(e))}))}visualFetchTasksUpdateBatch(e){(0,P.h5)((()=>{for(const t of e)this.visualFetchTasksUpdate(t)}))}visualFetchTasksInsertOrUpdate(e){(0,P.h5)((()=>{const t=this.visualFetchTasks.findIndex((({md5:t,type:i})=>t===e.md5&&i===e.type));-1===t?(this.visualFetchTasksAdd(e),this.visualFailedBucketUpdateIfExist(e)):(Object.assign(this.visualFetchTasks[t],(0,U.A)(e,["firstIn"])),this.visualFailedBucketUpdateIfExist(e))}))}visualFetchTasksInsertOrUpdateBatch(e){(0,P.h5)((()=>{for(const t of e)this.visualFetchTasksInsertOrUpdate(t)}))}transcodeListenTasksAdd(e){(0,P.h5)((()=>{this.transcodeListenTasks.unshift(e)}))}transcodeListenTaskUpdate(e){(0,P.h5)((()=>{const t=this.transcodeListenTasks.findIndex((({md5:t})=>e.md5===t));-1!==t&&Object.assign(this.transcodeListenTasks[t],e)}))}transcodeListenTasksRemove(e){(0,P.h5)((()=>{const t=this.transcodeListenTasks.findIndex((({md5:t})=>e.md5===t));-1!==t&&this.transcodeListenTasks.splice(t,1)}))}decryptAlbumSet(e,t){(0,P.h5)((()=>{this.decryptAlbum[e]=t}))}decryptAlbumRemove(e){(0,P.h5)((()=>{delete this.decryptAlbum[e]}))}visualFailedBucketUpdateIfExist(e){(0,P.h5)((()=>{if("failed"===e.status){const t=this.packageAssets.find((({md5:t})=>t===e.md5));t&&(this.visualFailedBucket[t.path]||(this.visualFailedBucket[t.path]={}),this.visualFailedBucket[t.path][e.type]=!0)}}))}visualFailedBucketUpdateIfFailed(e,t){(0,P.h5)((()=>{const i=this.visualFetchTasks.filter((({md5:t,status:i})=>e===t&&"failed"===i));if(i.length){const e={};for(const t of i)e[t.type]=!0;this.visualFailedBucket[t]=e}}))}stateSet(e,t){(0,P.h5)((()=>{this.state[e]=t}))}dirtySet(e,t){(0,P.h5)((()=>{this.dirty[e]=t}))}autoSaveRunningSet(e){(0,P.h5)((()=>{this.autoSaveRunning=e}))}timestampSet(e,t){(0,P.h5)((()=>{this.timestamp[e]=t}))}errorMessageSet(e,t){(0,P.h5)((()=>{this.errorMessage[e]=t}))}quickImportReplaceListenTasksAdd(e){(0,P.h5)((()=>{this.replaceListenTasks.unshift(e)}))}quickImportReplaceListenTasksRemove(e){(0,P.h5)((()=>{const t=this.replaceListenTasks.findIndex((({id:t})=>e.id===t));-1!==t&&this.replaceListenTasks.splice(t,1)}))}spaceIdSet(e){(0,P.h5)((()=>{this.spaceId=e}))}isPersonalSet(e){(0,P.h5)((()=>{this.isPersonal=e}))}invalidsSet(e){(0,P.h5)((()=>{this.invalids=e}))}resetSpaceStorageSet(e){(0,P.h5)((()=>{this.resetSpaceStorage=e}))}updateThirdImportEnableOptions(e){(0,P.h5)((()=>{e&&this._options.thirdImportEnable&&(this.thirdImportGrayConfig={...this.thirdImportGrayConfig,...e})}))}},s=(0,x.A)(r.prototype,"userId",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a=(0,x.A)(r.prototype,"syncId",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),o=(0,x.A)(r.prototype,"draftId",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n=(0,x.A)(r.prototype,"draftMeta",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l=(0,x.A)(r.prototype,"packageAssets",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),d=(0,x.A)(r.prototype,"resetSpaceStorage",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c=(0,x.A)(r.prototype,"globalMaterials",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u=(0,x.A)(r.prototype,"globalMaterialsLoading",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),p=(0,x.A)(r.prototype,"uploadFiles",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),h=(0,x.A)(r.prototype,"visualFetchTasks",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),f=(0,x.A)(r.prototype,"transcodeListenTasks",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m=(0,x.A)(r.prototype,"replaceListenTasks",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),v=(0,x.A)(r.prototype,"quickImportDownloadListenTasks",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),g=(0,x.A)(r.prototype,"decryptAlbum",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),y=(0,x.A)(r.prototype,"visualFailedBucket",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),_=(0,x.A)(r.prototype,"state",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{upload:"idle",download:"idle",upgrade:"idle",migrate:"idle",meta:"idle"}}}),w=(0,x.A)(r.prototype,"dirty",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{upgrade:!1,transcode:!1,visual:!1,visualInfo:!1,meta:!1,quickImportVisual:!1,quickImportReplace:!1,quickImportDownload:!1}}}),I=(0,x.A)(r.prototype,"timestamp",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{upgrade:-1}}}),A=(0,x.A)(r.prototype,"errorMessage",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{upgrade:""}}}),T=(0,x.A)(r.prototype,"invalids",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),S=(0,x.A)(r.prototype,"thirdImportGrayConfig",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{dropbox:!1,google:!1}}}),k=(0,x.A)(r.prototype,"autoSaveRunning",[P.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),r);t.Ay=O},91184:function(e,t,i){i.d(t,{R$:function(){return o},a1:function(){return s},u1:function(){return n},vK:function(){return a}});var r=i(85970);function s(e){var t,i;return!(null!==(t=e.meta)&&void 0!==t&&t.is_reverse||null!==(i=e.meta)&&void 0!==i&&i.is_matting)&&(e.type===r.sl.NORMAL||!e.name)}function a(e){return o(null==e?void 0:e.material)}function o(e){return void 0!==e&&(!e.groupType||"other"!==e.groupType)}function n(e){const t=Object.keys(e);return 3===t.length&&"id,md5,size"===t.sort().join(",")||4===t.length&&"id,md5,mime,size"===t.sort().join(",")||!t.includes("file_name")}},72764:function(e,t,i){i.d(t,{$5:function(){return m},C1:function(){return _},Om:function(){return h},fY:function(){return y},kW:function(){return v},lj:function(){return p},pi:function(){return f},wf:function(){return g}});var r=i(26719),s=i.n(r),a=i(85970),o=i(64939),n=i(46012),l=i(57672),d=i(71411),c=i(16649),u=i(91184);async function p(e,t,i){var r,s,a;const u=(0,d.S7)(t.type);let p,h,f,m=l.o.Online,v={};switch(u){case"video":var y,_;if(t.previewUrl&&(p={url:t.previewUrl,key:t.previewKey}),void 0===t.transcodeStatus)try{const i=await(0,c.Fe)(e,t.md5);null!=i&&i.primary_url&&null!=i&&i.url_key&&(f={url:i.primary_url,key:i.url_key})}catch(w){console.warn(w)}if(t.meta)try{if("string"!=typeof t.meta)v=t.meta;else{const e=JSON.parse(t.meta);v={...v,...e}}}catch(I){n.Zq.log("transfer_meta_error","transferMaterial meta error",I)}if(null!==(y=t.sprit)&&void 0!==y&&y.detail_infos&&null!==(_=t.sprit)&&void 0!==_&&_.common_info){const e=t.sprit.common_info,i=e.single_frame_width,r=e.single_frame_height;h=t.sprit.detail_infos.map((e=>({url:e.url,key:e.encrypt_key,count:e.frame_count,width:e.image_width,height:e.image_height,x:e.image_width/i,y:e.image_height/r,ratio:i/r})))}null!=i&&i.skipStatus||(void 0!==t.transcodeStatus?m=g(t.transcodeStatus):(0,o.Lk)(v)?m=l.o.Online:f||(m=l.o.Transcoding));break;case"image":{const e=function(e){for(const s of[480,360,720,1080]){var t,i,r;if(null!=e&&null!==(t=e.imageTranscodeInfo)&&void 0!==t&&null!==(t=t[s])&&void 0!==t&&t.preview_url)return{url:null==e||null===(i=e.imageTranscodeInfo)||void 0===i||null===(i=i[s])||void 0===i?void 0:i.preview_url,key:null==e||null===(r=e.imageTranscodeInfo)||void 0===r||null===(r=r[s])||void 0===r?void 0:r.key}}if(null==e||!e.previewUrl)return;return{url:null==e?void 0:e.previewUrl,key:null==e?void 0:e.previewKey}}(t);e?p=e:m=l.o.Transcoding;break}case"audio":if(null==i||!i.skipStatus)if(void 0!==t.transcodeStatus)m=g(t.transcodeStatus);else try{await(0,c.Fe)(e,t.md5)||(m=l.o.Transcoding)}catch(w){console.warn(w)}}return{assetId:t.id,name:t.name,md5:t.md5,type:null!==(r=t.mime)&&void 0!==r?r:"",metaType:(0,d.Aj)(t.mime),groupType:u,size:t.size,ext:t.subType,duration:t.duration,width:null!==(s=t.width)&&void 0!==s?s:0,height:null!==(a=t.height)&&void 0!==a?a:0,encryptedCover:p,encryptedSprites:h,progressDownload:0,progressTranscode:m===l.o.Online?1:0,fileStatus:m,updatedAt:t.updatedAt,meta:v,playInfo:f,downloadUrl:t.downloadUrl}}function h(e,t){return function(e){if(!e)return!1;let i="";i="string"==typeof e?(0,a.xI)(e):t._options.dependencies.getUploadEverCloudFileTypeFormat({file:e});return Object.keys(t._options.dependencies.EVER_CLOUD_SUPPORT_SOURCE_TYPE).includes(i)}}function f(e,t){if(!e&&!t)return 0;if(!e)return 1;if(!t)return-1;const i=(0,u.R$)(e),r=(0,u.R$)(t);return i&&r?t.updatedAt-e.updatedAt:i?-1:r?1:0}function m(e,t){if(!e&&!t)return 0;if(!e)return 1;if(!t)return-1;const i=(0,u.u1)(e),r=(0,u.u1)(t);return i&&r?0:i?1:r?-1:t.updated_at_ts-e.updated_at_ts}function v(e,t,i){var r;return t?{id:s().generate(),path:null!==(r=i.quickImportBlobUrl)&&void 0!==r?r:"",material:{type:e.type,size:e.size,name:e.name,metaType:(0,d.Aj)(e.type),groupType:(0,d.QR)(e.type)}}:{}}function g(e){var t;if(void 0===e)return l.o.TranscodeFailed;return null!==(t={0:l.o.Online,1:l.o.Transcoding,2:l.o.TranscodeFailed,3:l.o.NoTranscodeInformation,4:l.o.TranscodeNotSupported}[e])&&void 0!==t?t:l.o.TranscodeFailed}function y(e){var t;if(void 0===e)return"transcoding failed";return null!==(t={0:"transcode success",1:"transcoding",2:"transcoding failed",3:"transcode no information",4:"transcode not supported"}[e])&&void 0!==t?t:"transcoding failed"}function _(e){return"image"===e}},25344:function(e,t,i){i.d(t,{kQ:function(){return L.k},b0:function(){return F},OP:function(){return B}});var r=i(40492),s=i(52179),a=i(14148),o=i(26719),n=i.n(o),l=i(87759),d=i(92439),c=i(89243),u=i(42958),p=i(18195),h=i(57672),f=i(16940),m=i(59448),v=i(46012),g=i(9012),y=i(7146),_=i(71411),w=i(59522);const I=(e,t,i,r)=>{const a=i.type||e._options.dependencies.getUploadEverCloudFileTypeFormat({file:i});return{fileId:t,updatedAt:Date.now(),name:i.name,type:a,size:i.size,ext:s.extname(i.name),metaType:(0,_.Aj)(a),groupType:r||(0,_.QR)(a),duration:void 0,fileStatus:h.o.Transcoding,progressDownload:0,progressTranscode:0,progressMigrate:0}},A=(e,t)=>({fileId:e,vid:t.source,encryptedCover:{url:t.origin||t.image_360p_url||t.image_720p_url,key:""},duration:0,size:t.size?Number(t.size):0,fileStatus:h.o.Online}),T=(e,t)=>{var i,r;const s={fileId:e,vid:t.source,encryptedCover:{url:t.cover,key:""},duration:1e3*t.duration,size:t.size,fileStatus:h.o.Online};let a=t.video_infos.find((e=>"origin"===e.definition))||t.video_infos.find((e=>"720p"===e.definition))||t.video_infos.find((e=>"480p"===e.definition));if(a||(a=t.video_infos.find((e=>"360p"===e.definition))),a&&(s.playInfo={...a}),null!==(i=t.thumb)&&void 0!==i&&null!==(i=i.detail_infos)&&void 0!==i&&i.length&&null!==(r=t.thumb)&&void 0!==r&&r.common_info){var o;const e=t.thumb.common_info,i=e.single_frame_height,r=e.single_frame_width,a=null===(o=t.thumb)||void 0===o?void 0:o.detail_infos.map((e=>({url:e.url,key:"",count:e.frame_count,width:e.image_width,height:e.image_height,x:e.image_width/r,y:e.image_height/i,ratio:r/i})));s.encryptedSprites=a}return s};function S(e,t){const i={fileId:e,vid:t.source,duration:1e3*t.duration,size:t.size,fileStatus:h.o.Online},r=t.audio_infos[0];return r&&(i.playInfo={...r}),i}async function k(e,t,i){const r=(0,w.dZ)(t);let o,n=!1;i.forceFilePath&&(n=!0,o=i.forceFilePath,delete i.forceFilePath);const l={file:t};i.fileType&&(l.fileType=i.fileType);const d=i=>{e.store.uploadFilesUpdate({file:t,fileKey:i})};if("file"===l.fileType){const r=o||`local_file_${Date.now()}_${t.name}`;if(e.store.visitorAssetsInsertOrUpdateByPath({fileId:r,path:r,material:{fileId:r,name:t.name,type:t.type,ext:s.extname(t.name),metaType:(0,_.Aj)(t.type),groupType:"other",updatedAt:Date.now(),size:t.size,progressDownload:1,progressTranscode:1,progressMigrate:1,fileStatus:h.o.Online,tumor:t}}),i.needUploadFile)try{await(async t=>{const i=await e._sdk.uploadAssetNoLogin({...t,onStart:d}),r=await i.done(),s=await e._sdk.getVideoAssetTranscodeStatusNoSign(null==r?void 0:r.fileId),a=await s.done();return o&&e.store.visitorAssetsUpdate({fileId:o,path:o,material:{vid:i.vid}}),a})(l)}catch(A){console.error(A),v.Zq.error("visitor","","upload failed",A,{name:t.name,mimeType:t.type,size:t.size})}return{status:"success",fileId:r}}let c;e.store.uploadFilesAdd({auth:"visitor",path:"",coverUrl:"",requestId:"",options:i,file:t,progress:0,fileStatus:h.o.Uploading}),e._options.dependencies.validateEverCloudFileAccept({file:t,accepts:["video"]})&&(0,f.AY)({input:{file:t,type:m.fl.File},output:{type:m.YY.ObjectURL}}).then((i=>{var r;if(null!=i&&null!==(r=i[0])&&void 0!==r&&r.url){const r=i[0].url;e.store.uploadFilesUpdate({file:t,coverUrl:r})}}),(e=>{console.warn("get first screen shot error:",e)}));try{c=await e._sdk.uploadAssetNoLogin({...l,onStart:d}),e.store.uploadFilesUpdate({file:t,request:c,requestId:c.requestId})}catch(T){throw e.store.uploadFilesRemove({file:t}),v.Zq.error("visitor","possible same name","upload_pre_failed",T,{name:t.name,mimeType:t.type,size:t.size}),r.compound("failed",{contents:{error:"already exist same name file"}}),new Error(a.F2.t("there_is_already_a_file_with_the_same_name_in_the_cloud_space",{},"This file name already exists in Cloud Space"))}c.onProgress=({done:i,total:r})=>{e.store.uploadFilesUpdate({file:t,progress:i/r})},c.onCancel=t=>{t&&e.store.uploadFilesRemoveByKey(t)};try{const a=await c.done();return e.store.uploadFiles.find((e=>e.file===t))?("success"===a.status&&a.fileId?(r.compound("success",{categories:{request_id:c.requestId}}),o||(o=(0,_.Oo)({fileId:a.fileId,ext:s.extname(t.name)})),n?e.store.visitorAssetsInsertOrUpdateByPath({fileId:a.fileId,path:o,meta:i.meta||void 0,material:I(e,a.fileId,t,"file"===i.fileType?"other":i.fileType)}):e.store.visitorAssetsInsertOrUpdate({fileId:a.fileId,path:o,meta:i.meta||void 0,material:I(e,a.fileId,t,"file"===i.fileType?"other":i.fileType)}),e.store.uploadFilesRemove({file:t}),e.store.dirtySet("transcode",!0)):"cancel"===a.status?e.store.uploadFilesRemove({file:t}):e.store.uploadFilesUpdate({file:t,progress:0,fileStatus:h.o.UploadFailed}),e.emit("burypoint:material_user",[r]),a):(a.status="cancel",a)}catch(T){var u,p;console.warn("upload failed",T),r.compound("failed",{contents:{error:`upload failed: ${null==T||null===(u=(p=T).toString)||void 0===u?void 0:u.call(p)}`}});let i=h.o.UploadFailed;throw Number((0,g.A)(T,"errInfo.code"))===y.Ts.INVALID_FORMAT&&(i=h.o.TranscodeNotSupported),Number((0,g.A)(T,"errInfo.code"))===y.Ts.INVALID_MATERIAL_INFORMATION&&(i=h.o.NoTranscodeInformation),e.store.uploadFilesUpdate({file:t,progress:0,fileStatus:i}),e.emit("burypoint:material_user",[r]),T}}var b,C=i(41048),x=i(76916),P=i(87549);async function U(e,t,i,r){const s=null!=r?r:{},a=s.onCacheHit,o=s.progress,n=`visitor_${t}`,l=await(0,C.Jt)(n).catch((e=>{v.Zq.log("idb_get_error","indexDB get cache error",e,{scene:"visitor-fetchCdnFile"})}));if(l)return null==a||a("idb"),l;const d=await(0,x.sl)(i,{},{onProgress:o});null==a||a((0,P.$)(i));const c=await d.arrayBuffer();return await(0,C.hZ)(n,c).catch((e=>{v.Zq.log("idb_set_error","indexDB set cache error",e,{scene:"visitor-fetchCdnFile"})})),c}var F=(0,l.p)(b=(0,d.h)(b=class{constructor(e,t){(0,r.A)(this,"_lifeSequence",{initialized:0,mounted:1,setup:2,destroyed:3}),(0,r.A)(this,"_lifecycle","initialized"),(0,r.A)(this,"noSignOptions",void 0),(0,r.A)(this,"_options",void 0),(0,r.A)(this,"store",void 0),(0,r.A)(this,"_sdk",void 0),(0,r.A)(this,"_fs",void 0),this._options=e,this.store=t,this._sdk=this._options.dependencies.EverCloud,this._sdk.setTeaReporter(e.Tea)}relinquish(){this.lifecycle="destroyed"}async mount(){const e={isBoe:c.SC,newIdc:u.s.getVar("web_idc"),userRegion:u.s.getVar("country_code"),uniqueId:n().generate(),videoUploader:{getSliceFunc:e=>e>1048576e3?10485760:5242880},reqDomain:u.s.getVars()};this._sdk.setNoSignOptions(e),this.noSignOptions=e,await this._sdk.noSignInit(),this.lifecycle="mounted"}async upload(e,t){if("application/json"!==e.type&&!this._options.dependencies.validateEverCloudFileAccept({file:e}))throw new Error(a.F2.t("current_import_format_not_supported",{},"Current import format is not supported."));if(e.size>this._options.limit.visitor.single)throw new Error(a.F2.t("only_supports_materials_up_to_{size}",{size:(0,p.i)(this._options.limit.visitor.single)},"Only materials up to {size} are supported"));return k(this,e,t)}async uploadRetry(e){return async function(e,t){const i=e.store.uploadFiles.find((({requestId:e})=>e===t));if(!i)throw new Error(a.F2.t("the_record_was_not_found!",{},"Couldn't find record"));return e.store.uploadFilesRemove({file:i.file}),k(e,i.file,i.options)}(this,e)}async uploadRetryByFile(e){return async function(e,t){const i=e.store.uploadFiles.find((({file:e})=>e===t));if(!i)throw new Error(a.F2.t("the_record_was_not_found!",{},"Couldn't find record"));return e.store.uploadFilesRemove({file:i.file}),k(e,i.file,i.options)}(this,e)}async uploadCancel(e){const t=this.store.uploadFiles.find((t=>t.fileKey===e));if(!t)throw new Error("visitor file uploader dose not exist");var i;await(null==t||null===(i=t.request)||void 0===i?void 0:i.cancel(e))}unlink(e){this.store.visitorAssetsRemove({fileId:e})}async pokeToFS(e,t,i){var r;const a=this.store.visitorAssets.find((({fileId:t})=>e===t));if(null==a||!a.material)throw new Error("no such asset!");let o,n;const l=a.path;if("other"===a.material.groupType){if(!a.material.tumor)throw new Error("visitor file type file, but no tumor");o=await a.material.tumor.arrayBuffer()}else{var d=await async function(e,t,i){switch(t.groupType){case"video":case"audio":{const r=t.playInfo;if(!r)throw new Error("cant play");e.store.visitorAssetsUpdate({fileId:t.fileId,material:{progressDownload:0,progressTranscode:0,fileStatus:h.o.Downloading}});try{const s=await U(0,`${t.fileId}_${r.key}`,r.url,{progress:i=>{e.store.visitorAssetsUpdate({fileId:t.fileId,material:{progressDownload:i}})},onCacheHit:i});return e.store.visitorAssetsUpdate({fileId:t.fileId,material:{fileStatus:h.o.Local}}),{buffer:s,decryptKey:r.key}}catch(s){throw e.store.visitorAssetsUpdate({fileId:t.fileId,material:{fileStatus:h.o.DownloadFailed}}),v.Zq.error("visitor","visitor fetch meets error","download_video_audio",s,{fileId:t.fileId}),console.warn("visitor fetch meets error",s),s}}case"image":if(!t.encryptedCover)throw new Error("image with no cdn");e.store.visitorAssetsUpdate({fileId:t.fileId,material:{progressDownload:0,progressTranscode:0,fileStatus:h.o.Downloading}});try{var r;const s=await U(0,t.fileId,null===(r=t.encryptedCover)||void 0===r?void 0:r.url,{progress:i=>{e.store.visitorAssetsUpdate({fileId:t.fileId,material:{progressDownload:i}})},onCacheHit:i});return e.store.visitorAssetsUpdate({fileId:t.fileId,material:{fileStatus:h.o.Local}}),{buffer:s}}catch(s){throw e.store.visitorAssetsUpdate({fileId:t.fileId,material:{fileStatus:h.o.DownloadFailed}}),v.Zq.error("visitor","visitor fetch meets error","download_image",s,{fileId:t.fileId}),console.warn("visitor fetch meets error",s),s}default:throw new Error("doesnt support now!")}}(this,a.material,i);o=d.buffer,n=d.decryptKey}return null===(r=this._fs)||void 0===r||r.writeFileSync(s.join(t,l),o,{recursive:!0}),n&&this.store.decryptAlbumSet(l,n),this.store.visitorAssetsUpdate({fileId:e,material:{progressDownload:1,fileStatus:h.o.Local}}),n?{filePath:l,decryptKey:n}:{filePath:l}}})||b)||b,L=i(84924);var E=i(90843),M=i(64939),O=i(71716);async function R(e,t,i,r){const s=(0,w.b3)(t,i,r);if(e.store.transcodeListenTasks.find((({fileId:e})=>e===t)))return;e.store.transcodeListenTasksAdd({fileId:t});const a=await e._sdk.getVideoAssetTranscodeStatusNoSign(t),o={fileId:t,request:a};e.store.transcodeListenTaskUpdate(o);try{var n;const i=await a.done();if("success"===i.status&&1===(null===(n=i.data)||void 0===n?void 0:n.status)){var l,d;s.compound("success"),i.data.video?(e.store.visitorAssetsUpdate({fileId:t,material:{...T(t,i.data.video),fileStatus:h.o.Online}}),e.store.dirtySet("visual",!0),e.store.dirtySet("download",!0)):null!==(l=i.data.image)&&void 0!==l&&l.image_360p_url||null!==(d=i.data.image)&&void 0!==d&&d.image_720p_url?(e.store.visitorAssetsUpdate({fileId:t,material:{...A(t,i.data.image),fileStatus:h.o.Online}}),e.store.dirtySet("visual",!0),e.store.dirtySet("download",!0)):i.data.audio?(e.store.visitorAssetsUpdate({fileId:t,material:{...S(t,i.data.audio),fileStatus:h.o.Online}}),e.store.dirtySet("visual",!0),e.store.dirtySet("download",!0)):(console.warn("[FilerCloud#invokeTranscodingListen] transcoding failed:",t,i),e.store.visitorAssetsUpdate({fileId:t,material:{fileStatus:h.o.TranscodeFailed}}))}else{var c,u;const r=(0,O.wf)(null===(c=i.data)||void 0===c?void 0:c.status),a=(0,O.fY)(null===(u=i.data)||void 0===u?void 0:u.status);console.warn(`[FilerCloud#invokeTranscodingListen] ${a}:`,t,i),s.compound("failed",{contents:{error:`[FilerCloud#invokeTranscodingListen] ${a}: ${t}`}}),e.store.visitorAssetsUpdate({fileId:t,material:{fileStatus:r}})}}catch(p){console.warn("[FilerCloud#invokeTranscodingListen] transcoding error:",t,p),v.Zq.log("transcode_failed","file trancode failed by cloud api",p,{target:"visitor"}),s.compound("failed",{contents:{error:`[FilerCloud#invokeTranscodingListen] transcoding error: ${t} ${p}`}}),e.store.visitorAssetsUpdate({fileId:t,material:{fileStatus:h.o.TranscodeFailed}})}finally{e.store.transcodeListenTasksRemove({fileId:t}),e.emit("burypoint:material_user",[s])}}var j=i(54079),K=i(3317),V=i(29478),q=i(19974),N=i(8610);async function D(e,t,i,r){const s=(0,w.dW)(t,i.url),a="cover",o=e.store.visualFetchTasks.find((({fileId:e,type:i})=>e===t&&i===a));if(o){if("doing"===o.status||"failed"===o.status)return s.compound("failed",{contents:{error:"Cover exists but status is doing or failed."}}),void e.emit("burypoint:material_user",[s]);if(Date.now()-o.firstIn>E.yp)return e.store.visualFetchTasksUpdate({fileId:t,type:a,status:"failed"}),s.compound("failed",{contents:{error:"Cover exists but timeout."}}),void e.emit("burypoint:material_user",[s])}e.store.visualFetchTasksInsertOrUpdate({fileId:t,type:a,status:"doing",firstIn:Date.now()});try{let a;try{a=new Blob([await U(0,`${t}_cover`,i.url)],{type:"image/jpg"})}catch(d){v.Zq.warn("visitor","[Asset#placeCover] meets error","cover_place",d,{fileId:t}),a=await(0,j.L)((null==r?void 0:r.width)||50,(null==r?void 0:r.height)||50,"#000000","image/jpg")}const o=URL.createObjectURL(a),n={fileId:t,material:{fileId:t,coverUrl:o}};if(null==r||!r.width||null==r||!r.height)try{const e=await(0,V.G)(o),t=e.width,i=e.height;n.material.width=t,n.material.height=i}catch(d){console.warn("fix the cover size failed",d),v.Zq.warn("visitor","fix the cover size failed","cover_fix_size",d,{fileId:t})}return e.store.visitorAssetsUpdate(n),s.compound("success"),e.emit("burypoint:material_user",[s]),o}catch(d){var n,l;return s.compound("failed",{contents:{error:`[Asset#placeCover] meets error ${null==d||null===(n=(l=d).toString)||void 0===n?void 0:n.call(l)}`}}),v.Zq.warn("visitor","[Asset#placeCover] meets error","cover_place",d,{fileId:t}),e.emit("burypoint:material_user",[s]),void console.warn("[Asset#placeCover] meets error",d)}finally{e.store.visualFetchTasksUpdate({fileId:t,type:a,status:"idle"})}}async function z(e,t,i){const r=i.map(((e,r,s)=>(0,w.vo)(t,i.length,s.map((e=>e.url))))),s=i.map(((e,r,s)=>(0,w.IC)(t,i.length,s.map((e=>e.url))))),a="sprite",o=e.store.visualFetchTasks.find((({fileId:e,type:i})=>e===t&&i===a));if(o){if("doing"===o.status||"failed"===o.status)return r.forEach((e=>{e.compound("success",{categories:{hit_cache:"exist"}})})),void e.emit("burypoint:material_user",r);if(Date.now()-o.firstIn>E.yp)return r.forEach((e=>{e.compound("success",{categories:{hit_cache:"exist"}})})),e.emit("burypoint:material_user",r),void e.store.visualFetchTasksUpdate({fileId:t,type:a,status:"failed"})}e.store.visualFetchTasksInsertOrUpdate({fileId:t,type:a,status:"doing",firstIn:Date.now()});const n=e=>t=>{r[e].categories.hit_cache=t},l=await Promise.all(i.map(((i,a)=>U(0,`${t}_sprite_${i.url}`,i.url,{onCacheHit:n(a)}).then((e=>(r[a].compound("success"),s[a].compound("start"),(0,q.B)(e,{mimeType:"image/jpg",count:i.count,x:i.x,y:i.y},{compress:{height:N.$n},thresholdBlockSize:{width:N.qF*i.ratio,height:N.qF}}).catch((e=>(v.Zq.warn("visitor","[Asset#placeSprite] meets error","sprite_split",e,{fileId:t}),[]))))),(t=>(r[a].compound("failed",{contents:{error:`[Asset#placeSprite] meets error ${null==t?void 0:t.message}`}}),e.emit("burypoint:material_user",[r[a]]),console.warn("[Asset#placeSprite] meets error",t),[])))))),d=l.reduce(((e,t)=>[...e,...t]),[]);return l.forEach(((e,t)=>{e.length?s[t].compound("success",{metrics:{total_count:d.length}}):s[t].compound("failed",{metrics:{total_count:d.length},contents:{error:"split sprite failed"}})})),e.store.visitorAssetsUpdate({fileId:t,material:{spriteData:d}}),e.store.visualFetchTasksUpdate({fileId:t,type:a,status:"idle"}),r.forEach((e=>{"start"===e.status&&e.compound("success",{metrics:{total_count:d.length}})})),e.emit("burypoint:material_user",[...r,...s]),d}async function W(e,t){const i="cover-bucket",r=e.store.visualFetchTasks.find((({fileId:e,type:r})=>e===t.fileId&&r===i));if(r){if("doing"===r.status||"failed"===r.status)return;if(Date.now()-r.firstIn>E.yp)return void e.store.visualFetchTasksUpdate({fileId:t.fileId,type:i,status:"failed"})}e.store.visualFetchTasksInsertOrUpdate({fileId:t.fileId,type:i,status:"doing",firstIn:Date.now()}),e.store.visualFetchTasksUpdate({fileId:t.fileId,type:i,status:"idle"})}function B(e,t){let i=window.setInterval((()=>{var r;if("destroyed"===e.lifecycle)return window.clearInterval(i),void(i=0);!function(e){if($=$<1?E.tf:$-1,$!==E.tf)return;const t=Date.now(),i=[];for(const s of e.store.visitorAssets){var r;(null===(r=s.material)||void 0===r?void 0:r.fileStatus)===h.o.Transcoding&&s.material.updatedAt&&i.push({fileId:s.fileId,material:{progressTranscode:(0,_.U$)(t,s.material.updatedAt,s.material.size)}})}e.store.visitorAssetsUpdateBatch(i)}(e),t[L.k].dirty.transcode&&function(e){for(const s of e.store.visitorAssets){var t,i,r;(null===(t=s.material)||void 0===t?void 0:t.fileStatus)!==h.o.Transcoding||(0,M.h3)(s.material)||R(e,s.fileId,null===(i=s.material)||void 0===i?void 0:i.name,null===(r=s.material)||void 0===r?void 0:r.type)}}(e),t[L.k].dirty.visual&&function(e){for(const d of e.store.visitorAssets){var t,i,r,s,a,o,n,l;null!==(t=d.material)&&void 0!==t&&t.coverUrl||null===(i=d.material)||void 0===i||!i.encryptedCover||(0,M.h3)(d.material)||D(e,d.fileId,d.material.encryptedCover).then((()=>{W(e,d)})),null!==(r=d.material)&&void 0!==r&&null!==(r=r.spriteData)&&void 0!==r&&r.length||(0,M.h3)(d.material)||null!==(l=d.material)&&void 0!==l&&null!==(l=l.encryptedSprites)&&void 0!==l&&l.length&&z(e,d.fileId,d.material.encryptedSprites),null!==(s=d.material)&&void 0!==s&&s.audioUrl||null!==(a=d.material)&&void 0!==a&&null!==(a=a.waves)&&void 0!==a&&a.length||"video"!==(null===(o=d.material)||void 0===o?void 0:o.groupType)&&"audio"!==(null===(n=d.material)||void 0===n?void 0:n.groupType)||d.material.duration&&e.store.visitorAssetsUpdate({fileId:d.fileId,material:{waves:(0,K.j)(d.material.duration)}})}e.store.dirtySet("visual",!1)}(e),t[L.k].dirty.download&&function(e){for(const t of e.store.visitorAssets)(0,_.F2)(t)&&(0,_.JI)(e,t);e.store.dirtySet("download",!1)}(e),null!==(r=t.profile)&&void 0!==r&&r.uid||t.persistStore.save()}),E.QT)}let $=E.tf},84924:function(e,t,i){i.d(t,{k:function(){return v.k}});var r,s,a,o,n,l,d,c,u,p=i(38690),h=i(94185),f=i(50501),m=i(91776),v=i(88650);let g=(r=class{constructor(){(0,p.A)(this,"visitorAssets",s,this),(0,p.A)(this,"uploadFiles",a,this),(0,p.A)(this,"visualFetchTasks",o,this),(0,p.A)(this,"transcodeListenTasks",n,this),(0,p.A)(this,"decryptAlbum",l,this),(0,p.A)(this,"visualFailedBucket",d,this),(0,p.A)(this,"state",c,this),(0,p.A)(this,"dirty",u,this),(0,f.l_)(this)}visitorAssetsSet(e){(0,f.h5)((()=>{this.visitorAssets=e;for(const t of e)this.visualFailedBucketUpdateIfFailed(t.fileId,t.path)}))}visitorAssetsUpdate(e){(0,f.h5)((()=>{const t=this.visitorAssets.findIndex((({fileId:t})=>e.fileId===t));-1!==t&&(Object.prototype.hasOwnProperty.call(e,"path")&&(this.visitorAssets[t].path=e.path),Object.prototype.hasOwnProperty.call(e,"material")&&Object.assign(this.visitorAssets[t].material||{},e.material))}))}visitorAssetsUpdateByPath(e){(0,f.h5)((()=>{const t=this.visitorAssets.findIndex((({path:t})=>e.path===t));-1!==t&&Object.prototype.hasOwnProperty.call(e,"material")&&Object.assign(this.visitorAssets[t].material||{},e.material)}))}visitorAssetsInsertOrUpdate(e){(0,f.h5)((()=>{const t=this.visitorAssets.findIndex((({fileId:t})=>t===e.fileId));-1===t?(this.visitorAssets.unshift(e),this.visualFailedBucketUpdateIfFailed(e.fileId,e.path)):Object.assign(this.visitorAssets[t],e)}))}visitorAssetsInsertOrUpdateByPath(e){(0,f.h5)((()=>{const t=this.visitorAssets.findIndex((({path:t})=>t===e.path));-1===t?(this.visitorAssets.unshift(e),this.visualFailedBucketUpdateIfFailed(e.fileId,e.path)):Object.assign(this.visitorAssets[t],e)}))}visitorAssetsUpdateBatch(e){for(const t of e)this.visitorAssetsUpdate(t)}visitorAssetsRemove(e){(0,f.h5)((()=>{const t=this.visitorAssets.findIndex((({fileId:t})=>e.fileId===t));-1!==t&&this.visitorAssets.splice(t,1)}))}visitorAssetsReset(){(0,f.h5)((()=>{this.visitorAssets=[]}))}uploadFilesAdd(e){(0,f.h5)((()=>{this.uploadFiles.unshift(e)}))}uploadFilesUpdate(e){(0,f.h5)((()=>{const t=this.uploadFiles.findIndex((({file:t})=>t===e.file));-1!==t&&Object.assign(this.uploadFiles[t],e)}))}uploadFilesRemove(e){(0,f.h5)((()=>{let t=-1;e.file?t=this.uploadFiles.findIndex((({file:t})=>t===e.file)):e.requestId&&(t=this.uploadFiles.findIndex((({requestId:t})=>t===e.requestId))),-1!==t&&this.uploadFiles.splice(t,1)}))}uploadFilesRemoveByKey(e){(0,f.h5)((()=>{this.uploadFiles=this.uploadFiles.filter((t=>t.fileKey!==e))}))}visualFetchTasksAdd(e){(0,f.h5)((()=>{this.visualFetchTasks.unshift(e)}))}visualFetchTasksUpdate(e){(0,f.h5)((()=>{const t=this.visualFetchTasks.findIndex((({fileId:t,type:i})=>t===e.fileId&&i===e.type));-1!==t&&(Object.assign(this.visualFetchTasks[t],(0,m.A)(e,["firstIn"])),this.visualFailedBucketUpdateIfExist(e))}))}visualFetchTasksUpdateBatch(e){(0,f.h5)((()=>{for(const t of e)this.visualFetchTasksUpdate(t)}))}visualFetchTasksInsertOrUpdate(e){(0,f.h5)((()=>{const t=this.visualFetchTasks.findIndex((({fileId:t,type:i})=>t===e.fileId&&i===e.type));-1===t?(this.visualFetchTasksAdd(e),this.visualFailedBucketUpdateIfExist(e)):(Object.assign(this.visualFetchTasks[t],(0,m.A)(e,["firstIn"])),this.visualFailedBucketUpdateIfExist(e))}))}visualFetchTasksInsertOrUpdateBatch(e){(0,f.h5)((()=>{for(const t of e)this.visualFetchTasksInsertOrUpdate(t)}))}transcodeListenTasksAdd(e){(0,f.h5)((()=>{this.transcodeListenTasks.unshift(e)}))}transcodeListenTaskUpdate(e){(0,f.h5)((()=>{const t=this.transcodeListenTasks.findIndex((({fileId:t})=>e.fileId===t));-1!==t&&Object.assign(this.transcodeListenTasks[t],e)}))}transcodeListenTasksRemove(e){(0,f.h5)((()=>{const t=this.transcodeListenTasks.findIndex((({fileId:t})=>e.fileId===t));-1!==t&&this.transcodeListenTasks.splice(t,1)}))}decryptAlbumSet(e,t){(0,f.h5)((()=>{this.decryptAlbum[e]=t}))}decryptAlbumRemove(e){(0,f.h5)((()=>{delete this.decryptAlbum[e]}))}visualFailedBucketUpdateIfExist(e){(0,f.h5)((()=>{if("failed"===e.status){const t=this.visitorAssets.find((({fileId:t})=>t===e.fileId));t&&(this.visualFailedBucket[t.path]||(this.visualFailedBucket[t.path]={}),this.visualFailedBucket[t.path][e.type]=!0)}}))}visualFailedBucketUpdateIfFailed(e,t){(0,f.h5)((()=>{const i=this.visualFetchTasks.filter((({fileId:t,status:i})=>e===t&&"failed"===i));if(i.length){const e={};for(const t of i)e[t.type]=!0;this.visualFailedBucket[t]=e}}))}dirtySet(e,t){(0,f.h5)((()=>{this.dirty[e]=t}))}stateSet(e,t){(0,f.h5)((()=>{this.state[e]=t}))}},s=(0,h.A)(r.prototype,"visitorAssets",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a=(0,h.A)(r.prototype,"uploadFiles",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),o=(0,h.A)(r.prototype,"visualFetchTasks",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),n=(0,h.A)(r.prototype,"transcodeListenTasks",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),l=(0,h.A)(r.prototype,"decryptAlbum",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),d=(0,h.A)(r.prototype,"visualFailedBucket",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),c=(0,h.A)(r.prototype,"state",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{upload:"idle",download:"idle",migrate:"idle"}}}),u=(0,h.A)(r.prototype,"dirty",[f.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{transcode:!1,visual:!1,download:!1,migrate:!1}}}),r);t.A=g},59522:function(e,t,i){i.d(t,{XO:function(){return u},y8:function(){return p},S8:function(){return h},OY:function(){return o},i0:function(){return s},U_:function(){return g},hX:function(){return _},Yb:function(){return y},v$:function(){return d},KN:function(){return l},tZ:function(){return c},IC:function(){return f},dW:function(){return m},vo:function(){return v},b3:function(){return n},dZ:function(){return a}});i(71716);var r=i(43107);function s(e){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"upload",user_scene:"cloud",file_name:e.name,mime_type:e.type},metrics:{file_size:e.size}})}function a(e){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"upload",user_scene:"visitor",file_name:e.name,mime_type:e.type},metrics:{file_size:e.size}})}function o(e,t,i){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"transcode",user_scene:"cloud",md5:e,file_name:t,mime_type:i,cloud_type:"other"===i?"file":i}})}function n(e,t,i){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"transcode",user_scene:"visitor",file_id:e,file_name:t,mime_type:i}})}function l(e,t){const i=new r.A({startImmediately:!0,name:"material_user",categories:{behave:"information_duration",user_scene:"cloud",md5:e}});return{onInfoDurationSuccess:e=>{i.compound("success",{categories:{file_id:e.assetId,file_name:e.name,mime_type:e.type,cloud_type:"other"===e.groupType?"file":e.groupType},metrics:{duration:e.duration}}),t.emit("burypoint:material_user",[i])},onInfoDurationFail:e=>{i.compound("failed",{contents:{error:e}}),t.emit("burypoint:material_user",[i])}}}function d(e,t){const i=new r.A({startImmediately:!0,name:"material_user",categories:{behave:"information_cover",user_scene:"cloud",md5:e}});return{onInfoCoverSuccess:e=>{i.compound("success",{categories:{file_id:e.assetId,file_name:e.name,mime_type:e.type,cloud_type:"other"===e.groupType?"file":e.groupType}}),t.emit("burypoint:material_user",[i])},onInfoCoverFail:e=>{i.compound("failed",{contents:{error:e}}),t.emit("burypoint:material_user",[i])}}}function c(e,t){const i=new r.A({startImmediately:!0,name:"material_user",categories:{behave:"information_sprite",user_scene:"cloud",md5:e}});return{onInfoSpriteSuccess:e=>{i.compound("success",{categories:{cloud_type:"other"===e.groupType?"file":e.groupType,file_id:e.assetId,file_name:e.name,mime_type:e.type}}),t.emit("burypoint:material_user",[i])},onInfoSpriteFail:r=>{var s,a;i.compound("failed",{contents:{error:`[FilerCloud#invokeCoverSpriteListener] sprites failed: ${e}, ${null!==(s=null==r||null===(a=r.toString)||void 0===a?void 0:a.call(r))&&void 0!==s?s:""}`}}),t.emit("burypoint:material_user",[i])}}}function u(e,t,i){return new r.A({startImmediately:!1,name:"material_user",categories:{behave:"cloud_sprite",md5:e,cloud_type:"image",user_scene:"cloud",mime_type:"image/jpeg"},metrics:{sprite_count:t},contents:{cdn_urls:i}})}function p(e,t,i,s){const a=new r.A({startImmediately:!0,name:"material_user",categories:{behave:"download_cover",md5:e,cloud_type:"image",user_scene:"cloud",cdn_url:t,mime_type:i,hit_cache:"none"}});return{onSuccess:e=>{a.compound("success",{categories:{hit_cache:e}}),s.emit("burypoint:material_user",[a])},onFail:e=>{a.compound("failed",{contents:{error:e}}),s.emit("burypoint:material_user",[a])}}}function h(e,t,i){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"download_sprite",md5:e,cloud_type:"image",user_scene:"cloud",mime_type:"image/jpeg",hit_cache:"none"},metrics:{sprite_count:t},contents:{cdn_urls:i}})}function f(e,t,i){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"cloud_sprite",file_id:e,user_scene:"visitor",mime_type:"image/jpeg"},metrics:{sprite_count:t},contents:{cdn_urls:i}})}function m(e,t){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"download_cover",file_id:e,user_scene:"visitor",cdn_url:t,mime_type:"image/jpeg",hit_cache:"none"}})}function v(e,t,i){return new r.A({startImmediately:!0,name:"material_user",categories:{behave:"download_sprite",file_id:e,user_scene:"cloud",mime_type:"image/jpeg",hit_cache:"none"},metrics:{sprite_count:t},contents:{cdn_urls:i}})}function g(e,t,i){const s=new r.A({startImmediately:!0,name:"material_user",categories:{behave:"sync_visitor",file_id:e},metrics:{file_size:t}});return{onSuccess:(e,t)=>{"start"===s.status&&(s.compound("success",{categories:{md5:e},metrics:{file_size:t}}),i.emit("burypoint:material_user",[s]))},onFail:e=>{"start"===s.status&&(s.compound("failed",{contents:{error:e}}),i.emit("burypoint:material_user",[s]))}}}function y(e){const t=new r.A({startImmediately:!1,name:"material_user",categories:{behave:"sync_visitor_total"}});return{onStart:()=>{"wait"===t.status&&(t.status="start")},onSuccess:()=>{"start"===t.status&&(t.compound("success"),e.emit("burypoint:material_user",[t]))},onFail:i=>{"start"===t.status&&(t.compound("failed",{contents:{error:i}}),e.emit("burypoint:material_user",[t]))}}}function _(e,t){const i=new r.A({startImmediately:!0,name:"material_user",categories:{behave:"sync_visitor",file_id:e}});return{onSuccess:(e,t)=>{"start"===i.status&&i.compound("success",{categories:{md5:e},metrics:{file_size:t}})},onFail:e=>{"start"===i.status&&(i.compound("failed",{contents:{error:e}}),t.emit("burypoint:material_user",[i]))}}}},29688:function(e,t,i){i.d(t,{Xn:function(){return o},fN:function(){return a},wX:function(){return s}});var r=i(57672);function s(e){return Boolean((null==e?void 0:e.p360)||(null==e?void 0:e.p480)||(null==e?void 0:e.p720))}function a(e){return Boolean(null==e?void 0:e.audio)}function o(e){return[r.o.Local,r.o.Online,r.o.Downloading].includes(e)}},71411:function(e,t,i){function r(e,t,i=78643200){const r=4*Math.sqrt(i);return Math.max(0,Math.min(.99,(e-t)/r))}i.d(t,{S7:function(){return d},iP:function(){return y},JI:function(){return _.JI},D$:function(){return f},Oo:function(){return s.Oo},U$:function(){return r},Fk:function(){return m},F2:function(){return _.F2},QR:function(){return l},Aj:function(){return n},AD:function(){return v}});var s=i(46320),a=i(85970),o=i(90156);const n=(e="")=>{switch(l(e)){case"video":return o.nC.MetaTypeVideo;case"audio":return o.nC.MetaTypeMusic;case"image":return o.nC.MetaTypePhoto;default:return o.nC.MetaTypeNone}},l=(e="")=>{const t=(0,a.xI)(e);return["video","audio","image"].includes(t)?t:"other"},d=e=>{const t=(0,a.ij)(e);return["video","audio","image"].includes(t)?t:"other"};var c=i(59448),u=i(16940),p=i(24595),h=i(8610);function f(e){return new Promise(((t,i)=>{const r=new FileReader;r.onload=e=>{var i;return t(null===(i=e.target)||void 0===i?void 0:i.result)},r.onerror=()=>i(new Error("to arraybuffer error")),r.readAsArrayBuffer(e)}))}function m(e,t){return new Promise(((i,r)=>{const s=new Blob([e],{type:t}),a=(URL||webkitURL).createObjectURL(s),o=document.createElement("audio");o.preload="metadata",o.addEventListener("loadedmetadata",(()=>{(URL||webkitURL).revokeObjectURL(a),i(1e3*o.duration)})),o.onerror=r,o.src=new Function('return typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this)')().xssNamespace.cc_web_editor_smart_toolbox.filterUrl(a,null,{logType:"js.href/src",mode:"black",reportOnly:"all"})}))}async function v(e,t){const i={run:{type:c._w.interval,interval:(0,p.r)(t)},input:{buffer:e,type:c.fl.ArrayBuffer},output:{type:c.YY.ImageData},compress:{height:h.$n}};return await(0,u.Ay)(i)}i(52179);var g=i(8800);function y(e){let t=e,i="B";return t>=g.Yi&&(t=Math.floor(t/g.Yi),i="KB"),t>=g.Yi&&(t=Math.floor(t/g.Yi),i="MB"),t>=g.Yi&&(t=Math.floor(t/g.Yi),i="GB"),`${t}${i}`}var _=i(49025)},11273:function(e,t,i){i.d(t,{A:function(){return o},i:function(){return n}});var r=i(31399),s=i(52882),a=i(67308);function o(){var e,t;const i=(0,a.useContext)(s.xM),o=i.smartToolType,n=i.pageLifeCycle,l=i.originalPlayInfo,d=i.currentPlayInfo,c=i.aiProcessLoading,u=[r.K8.VideoUpscaler,r.K8.VideoSlowMotion,r.K8.VideoStabilization,r.K8.VideoStyleConversion].includes(o),p=[r.K8.ImageAiToning,r.K8.ImageColoring,r.K8.ImageNightEnhance,r.K8.ImageRestoration,r.K8.ImageStyleAvatar,r.K8.ImageStyleConversion,r.K8.ImageUpscaler].includes(o),h=[r.K8.ImageToImage,r.K8.TextToImage].includes(o),f=[s.$u.DefaultEmpty,s.$u.InitWithPreset,s.$u.Uploading,s.$u.Transcoding,s.$u.ViewOriginAfterUploading],m=![s.$u.DefaultEmpty,s.$u.InitWithPreset,s.$u.Exported].includes(n);return{showExport:n===s.$u.Exported,showUpload:n===s.$u.DefaultEmpty||!l,showVideoPreview:u&&m&&Boolean(d),showImagePreview:p&&m&&Boolean(d),showPresetPreview:h&&!(null!==(e=i.aiWorksInView)&&void 0!==e&&e.length)&&!(null!==(t=i.aiWorksList)&&void 0!==t&&null!==(t=t[0])&&void 0!==t&&null!==(t=t.works)&&void 0!==t&&t.length)&&f.includes(n)&&!c,aiProcessLoading:c}}function n({stType:e}){}},55964:function(e,t,i){i.d(t,{bs:function(){return $},Ay:function(){return Z},gQ:function(){return z}});var r=i(29453),s=(i(67308),i(31399)),a=i(81165),o=i(68605),n=i(36060),l=i(9255),d=i(77631),c=i(52540),u=i(46025),p=i(93564),h=i(11273),f=i(38e3);const m=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageAiToning});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showImagePreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_image_color_correction",{},"AI Color Correction"),children:(0,f.jsx)(p.d,{})}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{multiple:!1})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(c.A,{})})]}),(0,f.jsx)(u.A,{})]})})),v=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageColoring});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showImagePreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_photo_colorizer",{},"Photo Colorizer")}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{multiple:!1})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(c.A,{})})]}),(0,f.jsx)(u.A,{})]})}));var g=i(17097);const y=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageNightEnhance});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showImagePreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_image_night_enhance",{},"Low-light Image Enhancement"),children:(0,f.jsx)(g.y,{})}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{multiple:!1})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(c.A,{})})]}),(0,f.jsx)(u.A,{})]})}));var _=i(30654);const w=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageRestoration});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showImagePreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_old_photo_restoration",{},"Old Photo Restoration"),children:(0,f.jsx)(_.y,{})}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{multiple:!1})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(c.A,{})})]}),(0,f.jsx)(u.A,{})]})}));var I=i(62423);const A=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageStyleAvatar});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showImagePreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_title_portrait_generator",{},"Portrait Generator"),children:(0,f.jsx)(I.w,{})}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{multiple:!1})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(c.A,{})})]}),(0,f.jsx)(u.A,{})]})}));var T=i(34156);const S=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageStyleConversion});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showImagePreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_image_style_conversion",{},"Image Style Conversion"),children:(0,f.jsx)(T.T,{})}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{multiple:!1})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(c.A,{})})]}),(0,f.jsx)(u.A,{})]})}));var k=i(13390),b=i(59380),C=i(86021),x=i(84695),P=i(25036);const U=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageToImage});const t=(0,h.A)(),i=t.showExport,r=t.showPresetPreview,a=t.aiProcessLoading;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsxs)("div",{className:"st-generate-page-container",children:[(0,f.jsxs)("div",{className:"st-generate-page__left",children:[r&&(0,f.jsx)("div",{className:"st-generate-page__image-container no-padding",children:(0,f.jsx)(b.p8,{})}),(!r||a)&&(0,f.jsx)("div",{className:"st-generate-page__image-container",children:(0,f.jsx)(P.A,{})}),(0,f.jsx)("div",{className:"st-generate-page__prompt-container",children:(0,f.jsx)(C.A,{})})]}),(0,f.jsx)("div",{className:"st-generate-page__right",children:(0,f.jsx)(k.A,{title:e.t("web_magicTools_title_image_to_image",{},"Image to Image"),children:(0,f.jsx)(x.i,{})})})]}),(0,f.jsx)(u.A,{})]})}));var F=i(82447);const L=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.ImageUpscaler});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showImagePreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_image_upscaler",{},"Image upscaler"),children:(0,f.jsx)(F.Z,{})}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{multiple:!1})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(c.A,{})})]}),(0,f.jsx)(u.A,{})]})}));var E=i(10059);const M=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.TextToImage});const t=(0,h.A)(),i=t.showExport,r=t.showPresetPreview,a=t.aiProcessLoading;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsxs)("div",{className:"st-generate-page-container",children:[(0,f.jsxs)("div",{className:"st-generate-page__left",children:[(0,f.jsxs)("div",{className:"st-generate-page__image-container",children:[r&&(0,f.jsx)(b.qi,{}),(!r||a)&&(0,f.jsx)(P.A,{})]}),(0,f.jsx)("div",{className:"st-generate-page__prompt-container",children:(0,f.jsx)(C.A,{})})]}),(0,f.jsx)("div",{className:"st-generate-page__right",children:(0,f.jsx)(k.A,{title:e.t("web_magicTools_title_text_to_image",{},"Text to Image"),children:(0,f.jsx)(E.y,{})})})]}),(0,f.jsx)(u.A,{})]})}));var O=i(95646),R=i(34236),j=i(55723);const K=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.VideoSlowMotion});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showVideoPreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_super_slow_motion",{},"Super Slow Motion"),children:(0,f.jsx)(j.n,{})}),!i&&(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(O.A,{})})]}),i&&(0,f.jsx)("div",{className:"exportPage",children:(0,f.jsx)(R.A,{})}),(0,f.jsx)(u.A,{})]})})),V=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.VideoStabilization});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showVideoPreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_video_stablizer",{},"Video Stablization")}),!i&&(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(O.A,{})})]}),i&&(0,f.jsx)("div",{className:"exportPage",children:(0,f.jsx)(R.A,{})}),(0,f.jsx)(u.A,{})]})}));var q=i(73026);(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.VideoStyleConversion});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showVideoPreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_video_style_transfer",{},"Video Style Transfer"),children:(0,f.jsx)(q.t,{})}),(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(O.A,{})})]}),i&&(0,f.jsx)("div",{className:"exportPage",children:(0,f.jsx)(R.A,{})}),(0,f.jsx)(u.A,{})]})}));var N=i(5306);const D=(0,o.PA)((function(){const e=(0,n.B)().i18n;(0,h.i)({stType:s.K8.VideoUpscaler});const t=(0,h.A)(),i=t.showExport,r=t.showUpload,a=t.showVideoPreview;return(0,f.jsxs)("div",{className:"st-page-container",children:[!i&&(0,f.jsx)(d.A,{title:e.t("web_magicTools_button_super_clarity_video",{},"Video Upscaler"),children:(0,f.jsx)(N.L,{})}),!i&&(0,f.jsxs)("div",{className:"st-application-page-container",children:[r&&(0,f.jsx)("div",{className:"st-page-upload",children:(0,f.jsx)(l._,{})}),a&&(0,f.jsx)("div",{className:"st-page-preview",children:(0,f.jsx)(O.A,{})})]}),i&&(0,f.jsx)("div",{className:"exportPage",children:(0,f.jsx)(R.A,{})}),(0,f.jsx)(u.A,{})]})})),z={[s.K8.TextToImage]:"/convert-text-to-image",[s.K8.ImageToImage]:"/generate-image",[s.K8.ImageStyleAvatar]:"/generate-portrait",[s.K8.ImageNightEnhance]:"/enhance-low-light-image",[s.K8.ImageStyleConversion]:"/stylize-photo",[s.K8.ImageUpscaler]:"/upscale-image",[s.K8.ImageAiToning]:"/correct-color",[s.K8.ImageColoring]:"/ai-colorize",[s.K8.ImageRestoration]:"/ai-restore",[s.K8.VideoUpscaler]:"/upscale-video",[s.K8.VideoSlowMotion]:"/make-slomo",[s.K8.VideoStabilization]:"/stablize-video"},W="/magic-tools",B=window.location.pathname.split("/")[2];Object.values(z).includes(`/${B}`)||window.location.replace("/");const $=function(){for(const e in z)if(z[e]===`/${B}`)return Number(e)}();var Z=(0,o.PA)((function(){return(0,a.A)(),(0,f.jsxs)(r.dO,{children:[(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.TextToImage]}`,component:M}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageToImage]}`,component:U}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageStyleAvatar]}`,component:A}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageNightEnhance]}`,component:y}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageStyleConversion]}`,component:S}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageUpscaler]}`,component:L}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageAiToning]}`,component:m}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageColoring]}`,component:v}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.ImageRestoration]}`,component:w}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.VideoUpscaler]}`,component:D}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.VideoSlowMotion]}`,component:K}),(0,f.jsx)(r.qh,{exact:!0,path:`${W}${z[s.K8.VideoStabilization]}`,component:V})]})}))},66431:function(e,t,i){i.d(t,{Z2:function(){return P},mS:function(){return M},$X:function(){return q},ky:function(){return K},QA:function(){return F},w8:function(){return L.w},M3:function(){return R}});var r=i(31399),s=i(2799),a=i.n(s),o=i(14148),n=i(58933),l=i(42958),d=i(63487),c=i.n(d);function u({url:e,pf:t,appvr:i,tdid:r}){const s=Math.floor(Date.now()/1e3);return{sign:c()(`9e2c|${e.slice(-7)}|${t}|${i}|${s}|${r}|11ac`).toLowerCase(),"device-time":s}}const p="custom-space",h={loc:n.yl.CHANNEL,pf:n.yl.APP_PF,appvr:n.yl.VERSION,tdid:"","sign-ver":1,"app-sdk-version":n.yl.APP_SDK_VERSION};var f=new class{getCurrentDomain(){return l.s.getVar("web_domain")}baseRequestInterceptors(e){var t,i;const r=(null==e||null===(t=e[p])||void 0===t?void 0:t.domain)||this.getCurrentDomain();return(null===(i=e.baseURL)||void 0===i?void 0:i.startsWith("https"))||(e.baseURL=`${r}${e.baseURL}`),{...e,withCredentials:!0}}createAxios(e={}){const t=a().create(e);return t.interceptors.request.use((e=>{const t=h.pf,i=h.appvr,r=h.tdid;return e.headers={...e.headers,...u({url:`${e.baseURL}${e.url}`,pf:t,appvr:i,tdid:r}),lan:o.F2.language||n.yl.LAN},e})),t.interceptors.request.use(this.baseRequestInterceptors.bind(this)),t.interceptors.response.use((e=>{if(200===e.status){const t=e.data;return"0"===t.ret?Promise.resolve(t.data):Promise.reject(e)}return Promise.reject(e)}),(e=>Promise.reject(e))),t}},m=i(46012),v=i(77024),g=i(62822),y=i(74296);const _={[r.K8.TextToImage]:y.vt.image,[r.K8.ImageToImage]:y.vt.image,[r.K8.ImageStyleAvatar]:y.vt.image,[r.K8.ImageNightEnhance]:y.vt.image,[r.K8.ImageStyleConversion]:y.vt.image,[r.K8.ImageUpscaler]:y.vt.image,[r.K8.ImageAiToning]:y.vt.image,[r.K8.ImageColoring]:y.vt.image,[r.K8.ImageRestoration]:y.vt.image,[r.K8.VideoStyleConversion]:y.vt.video,[r.K8.VideoUpscaler]:y.vt.video,[r.K8.VideoSlowMotion]:y.vt.video,[r.K8.VideoStabilization]:y.vt.video},w=r.bo.SMART_TOOL_CREATE;var I=(e,t=!0,i)=>{var s;const a=window.__store;if(!a)return;const n=null==e||null===(s=e.data)||void 0===s?void 0:s.ret;if(w.NO_LOGIN===n){var l,d;if(null!==(l=a.profile)&&void 0!==l&&l.uid)a.doNotBlockWindowClose=!0,window.location.reload();else null===(d=a.loginSdk)||void 0===d||d.login({enter_from:"page_header",tool_type:r.Ww[(0,g.b0)(a.smartToolType)],current_page:"smart_tool_page"});return}const c=_[a.smartToolType]||y.vt.audio;let u="";if(w.ACCESS_TIME_LIMIT===n&&(u=function(e,t){var i,s,a;e._reportBase("smart_tool_generate_limit_popup",{action:"show"}),null!==(i=e.profile)&&void 0!==i&&i.uid||null===(a=e.loginSdk)||void 0===a||a.login({enter_from:"access_quota_limit",tool_type:r.Ww[(0,g.b0)(e.smartToolType)],current_page:"smart_tool_page"});const n=t===y.vt.image?o.F2.t("web_smarttools_toast_generation_limit_image",{},"Couldn\u2019t generate. You\u2019ve reached the maximum number of images you can generate in a day."):o.F2.t("web_smarttools_toast_generation_limit",{},"Couldn\u2019t generate. You\u2019ve reached the maximum number of videos you can generate in a day."),l=null!==(s=e.profile)&&void 0!==s&&s.uid?"":o.F2.t("web_magicTools_text_more_chances",{},"Sign in to enjoy a full experience");return n+l}(a,c)),!1!==t)if(null==i||i(),n!==w.NOT_ENOUGH_STORAGE)switch(n){case w.ACCESS_TIME_LIMIT:v.A.error(u);break;case w.NO_AVATAR:v.A.error(o.F2.t("web_magicTools_toast_re_upload_material",{},"No face recognized. Try another photo."));break;case w.FORMAT_UNSUPPORT:v.A.error(o.F2.t("web_magicTools_toast_reselect_material",{},"Couldn\u2019t process material. Try another one."));break;case w.AIGC_SENSITIVE_WORDS:case w.AIGC_SENSITIVE_IMAGES:v.A.error(o.F2.t("web_magicTools_toast_unable_image_text",{},"Inapproperiate words or image recognized. Try other words or image."));break;default:v.A.error(o.F2.t("web_magicTools_toast_generate_fail",{},"Couldn\u2019t generate. Try again later."))}else a.showExpandOnExportShow()};const A="custom-axios-retry";function T(e){const t=(null==e?void 0:e[A])||{canRetry:!0};return t.retryCount=t.retryCount||0,t}const S=()=>0;function k(e){var t,i;return-1!==(null==e||null===(t=e.message)||void 0===t?void 0:t.indexOf("timeout"))||-1!==(null==e||null===(i=e.message)||void 0===i?void 0:i.indexOf("Network Error"))}function b(e,t){return e.interceptors.request.use((e=>{const t=T(e);return t.lastRequestTime=Date.now(),e[A]=t,e})),e.interceptors.response.use(void 0,(i=>{var r,s,a;const o=i.config,n=o[p],l=n.ifShow,d=n.callback;if(m.Zq.log("smart-toolbox-api-error","",new Error(""),{videoeditorScmVersionV1:void 0,videoeditorScmVersionV2:void 0,videoeditorScmVersionV3:void 0,videoeditorScmVersionV4:void 0,pageUrl:location.hostname+location.pathname,url:null==i||null===(r=i.config)||void 0===r?void 0:r.url,baseURL:null==i||null===(s=i.config)||void 0===s?void 0:s.baseURL,errorCode:null==i||null===(a=i.data)||void 0===a?void 0:a.ret}),!o)return I(i,l,d),Promise.reject(i);const c=t.retries,u=void 0===c?5:c,h=t.isRetry,f=void 0===h?k:h,v=t.retryDelay,g=void 0===v?S:v,y=t.resetTimeout,_=void 0!==y&&y,w=T(o);if(f(i)&&w.canRetry&&(-1===u||w.retryCount<u)){w.retryCount+=1;const t="number"==typeof g?g:g(w.retryCount);if(!_&&o.timeout&&w.lastRequestTime){const e=Date.now()-w.lastRequestTime;o.timeout=Math.max(o.timeout-e-t,1)}return o.transformRequest=[e=>e],new Promise((i=>setTimeout((()=>i(e(o))),t)))}return I(i,l,d),Promise.reject(i)})),e}var C=i(84827);const x=f.createAxios({baseURL:"/lv/v1",method:"POST",headers:{...h}});b(x,{retries:3,resetTimeout:!0,retryDelay:300,isRetry:e=>{var t;return!Object.values(r.bo.SMART_TOOL_CREATE).includes(String(null==e||null===(t=e.data)||void 0===t?void 0:t.ret))}});const P={async AiCreate(e,t){const i=f.getCurrentDomain(),r={...e,params:e.params?JSON.stringify(e.params):void 0},s=await x({url:"/intelligence/create",data:r,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback},[A]:{retryCount:100,canRetry:!1}}),a=s.task_id;return C.A.setAiCreateCacheItem(a,{domain:i,params:e}),s},async MatchAiCreate(e,t){const i=e.task_id,r=e.quantity,s=C.A.getParams(i);s.params.quantity=r;return await P.AiCreate(s,t)},async AiProcessQuery(e,t){const i=e.task_id;return await x({url:"/intelligence/query",data:e,[p]:{domain:C.A.getDomain(i),ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})},async AiProcessCancel(e,t){const i=e.task_id;return await x({url:"/intelligence/cancel",data:e,[p]:{domain:C.A.getDomain(i),ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})}},U=f.createAxios({baseURL:"/lv/v1",method:"POST",headers:{...h}});b(U,{retries:3,resetTimeout:!0,retryDelay:300,isRetry:()=>!0});const F={async getList(e,t){return await U({url:"/intelligence/preset_resource_list",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})},async getSeoResourceList(e,t){return await U({url:"/intelligence/preset_source_seo_list",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})}};var L=i(26417);const E=f.createAxios({baseURL:"/lv/v1",method:"POST",headers:{...h}});b(E,{retries:3,resetTimeout:!0,retryDelay:300,isRetry:()=>!1});const M={async CreateDraft(e,t){return await E({url:"/draft/create",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})}},O=f.createAxios({baseURL:"/lv/v1",method:"POST",headers:{...h}});b(O,{retries:3,resetTimeout:!0,retryDelay:300,isRetry:()=>!0});const R={async getQuota(e,t){return await O({url:"/intelligence/quota",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})}},j=f.createAxios({baseURL:"/lv/v1",method:"POST",headers:{...h}});b(j,{retries:3,resetTimeout:!0,retryDelay:300,isRetry:()=>!0});const K={async checkPopup(e,t){return await j({url:"/intelligence/check_popup",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})},async confirmPopup(e,t){return await j({url:"/intelligence/confirm_popup",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})}},V=f.createAxios({baseURL:"/lv/v1",method:"POST",headers:{...h}});b(V,{retries:3,resetTimeout:!0,retryDelay:300,isRetry:()=>!0});const q={async getFileList(e,t){return await V({url:"/asset/query",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})},async createFolder(e,t){return await V({url:"/asset/create",data:{...e,asset_type:y.PW.Directory},[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})},async getSourcePathDetail(e,t){return await V({url:"/asset/mget_simple_info",data:e,[p]:{ifShow:null==t?void 0:t.ifShow,callback:null==t?void 0:t.callback}})}}},74296:function(e,t,i){i.d(t,{kS:function(){return d},PW:function(){return c.PW},g9:function(){return n},Yw:function(){return l},wx:function(){return a},vt:function(){return s},I6:function(){return r},um:function(){return o.u}});const r={"360p":[480,360],"480p":[640,480],"720p":[1280,720],"1080p":[1920,1080],"2k":[2560,1440],"4k":[3840,2160]};let s=function(e){return e[e.video=0]="video",e[e.image=1]="image",e[e.audio=2]="audio",e}({}),a=function(e){return e[e.tool=0]="tool",e[e.landing=1]="landing",e}({});var o=i(41350);let n=function(e){return e[e.isMute=1]="isMute",e[e.noMute=2]="noMute",e}({}),l=function(e){return e[e.Heycan=0]="Heycan",e[e.Giphy=1]="Giphy",e[e.Vcloud=2]="Vcloud",e[e.Evercloud=3]="Evercloud",e}({}),d=function(e){return e[e.Processing=1]="Processing",e[e.Success=2]="Success",e[e.Fail=3]="Fail",e[e.NotFound=4]="NotFound",e}({});var c=i(24250)},84827:function(e,t,i){var r=i(40492);t.A=new class{constructor(){(0,r.A)(this,"AiCreateCache",{})}getDomain(e){var t;return null===(t=this.AiCreateCache[e])||void 0===t?void 0:t.domain}getParams(e){var t;return null===(t=this.AiCreateCache[e])||void 0===t?void 0:t.params}setAiCreateCacheItem(e,t){const i=t.domain,r=t.params;this.AiCreateCache[e]={domain:i,params:JSON.parse(JSON.stringify(r))}}}},11888:function(e,t,i){i.d(t,{A:function(){return f}});var r=i(31399),s=i(53265),a=i(90018),o=i(28141);var n=i(46012),l=i(49416),d=i(56940),c=i(50135);const u=n.Zq.getLogger(l.z.USER_TRACK),p={business:s.PK.Tool,appId:r.sZ,Tea:a.A,enableTTWid:!0,enableCareered:!1,configUTParams:async()=>{await(async e=>{var t,i;const r=(0,o.kB)();await r.init();const s=r.getParams(),a=s.campaign,n=s.term,l=s.channel,d=s.extraCommonParams;e.config({custom:{...null!==(t=null===(i=e.getConfig())||void 0===i||null===(i=i.header)||void 0===i?void 0:i.custom)&&void 0!==t?t:{},campaign_id:a,keywords:n,...l,...d,branch:window._currentBranch}})})(a.A)},teaConfig:{enableAbTest:!0,abChannelDomain:"https://vmweb-sg.byteoversea.com"},trackCb:(e,t)=>{u.info(e,t)}};void 0===p.appId&&(p.appId=r.l3),void 0===p.enableTTWid&&(p.enableTTWid=!1),void 0===p.enableCareered&&(p.enableCareered=!1);const h=d.A.getInstance({Tea:p.Tea,appId:p.appId,enableTTWid:p.enableTTWid,enableCareered:p.enableCareered,cfgMultiRegion:p.cfgMultiRegion,configUTParams:p.configUTParams,teaConfig:p.teaConfig,evtParams:p.evtParams,business:p.business});p.trackCb&&h.trackCb.push(p.trackCb),c.A.setEventTracker(h);var f=h},81316:function(e,t,i){i.d(t,{A:function(){return x}});var r,s=i(42958),a=i(65871),o=i(54006),n=i(31399),l=i(46012),d=i(40492),c=i(67343),u=i(92439),p=i(87759),h=i(42615),f=i(36902),m=i(92431);const v=u.h,g=p.p,y=(0,c.U4)(a.u.withContext({...a.u.context,loginReportParams:{currentPage:"smart_tool_page",pageEnterFrom:"",statusEnterFrom:""},shouldFetchLocation:void 0===(window.__locationInfo||window.__locationCountryCode)}));y.start(),a.U.init({userService:y});var _=function(e){return e.noSign="noSign",e.noCareer="noCareer",e.hasCareer="hasCareer",e}(_||{});function w(){const e=(0,m.A)(a.U.getUserInfo());return null!=e&&e.region&&null!=e&&e.uid?(null!=e&&e.defaultSpaceInfo&&(e.spaceInfo={...null==e?void 0:e.defaultSpaceInfo}),e):null}function I(){const e=a.U.getUserCloudInfo();return e?{workspaceInfo:e.workspaceInfo,workspaceExpandInfo:e.workspaceExpandInfo,workspaceExpandInfoMap:e.workspaceExpandInfoMap}:null}var A,T=g(r=v(r=class{constructor(){(0,d.A)(this,"_lifeSequence",{initialized:0,mounted:1}),(0,d.A)(this,"_lifecycle","initialized"),(0,d.A)(this,"_userService",y),(0,d.A)(this,"_careerStatus",void 0),(0,d.A)(this,"_credibleCareer",void 0),(0,d.A)(this,"_profile",null),(0,d.A)(this,"_cloudInfo",null)}get careerStatus(){return this._careerStatus}set careerStatus(e){void 0!==e&&(this._careerStatus===_.noCareer&&e===_.hasCareer&&this.emit("selected:career"),this._careerStatus=e)}get credibleCareer(){return this._credibleCareer}set credibleCareer(e){const t=this._credibleCareer;this._credibleCareer=e,t!==e&&this.emit("changed:credibleCareer",e)}get profile(){return this._profile}set profile(e){const t=this._profile;this._profile=e,(null==e?void 0:e.uid)!==(null==t?void 0:t.uid)&&(this.emit("changed:uid",null==e?void 0:e.uid),null!=e&&e.uid&&this.emit("user:logged_in")),t!==e&&this.emit("changed:profile",e)}get cloudInfo(){return this._cloudInfo}set cloudInfo(e){let t=!1;e!==this._cloudInfo&&(t=!0),this._cloudInfo=e,t&&this.emit("changed:cloudInfo",e)}get uid(){var e;return null===(e=this._profile)||void 0===e?void 0:e.uid}get region(){var e;return null===(e=this._userService.state.context)||void 0===e||null===(e=e.userInfo)||void 0===e?void 0:e.region}get webIDC(){return a.U.getNewIdc()}get vipInfo(){return this._userService.state.context.vipInfo}async mount({onLocationError:e}={}){(0,h.jo)(f.Z);let t=!1;a.U.listenUserWholeStatus((i=>{i.noSign||i.hasSign?(this.careerStatus=function(e){if(e.hasSign){if(void 0===e.careerStatus)return;return e.careerStatus?_.hasCareer:_.noCareer}return _.noSign}(i),this.credibleCareer=function(e){if(e.hasSign||e.noSign||e.initFailed)return e.hasSign&&e.careerStatus?e.career:""}(i),i.hasSign&&(this.profile=w(),this.cloudInfo=I()),t=!0):i.initFailed&&(null==e||e(!0))}));await(async()=>{if(t)return;const i=new Promise(((t,i)=>{const r=a.U.listenUserWholeStatus((s=>{if(s.initFailed&&(null==e||e(!0),r(),i(new Error("sign get location fail"))),s.noSign&&(this.profile=null,r(),t()),s.hasSign){this.cloudInfo=I();const e=w();e&&(this.profile=e,r(),t())}}))}));await i})(),s.s.setVars({web_idc:this.webIDC,country_code:this.region,...this.getReqDomain()}),this.lifecycle="mounted",(0,h.qD)(f.Z)}reset(){this._userService.send({type:"RESET"})}refreshUserSpace(){this._userService.send("REFRESH_USER_SPACE")}login(e){this._userService.send({type:"UPDATE_REPORT_PARAMS",params:{pageEnterFrom:e.enter_from,statusEnterFrom:e.enter_from,toolType:null==e?void 0:e.tool_type,currentPage:null==e?void 0:e.current_page}}),this._userService.send({type:"SIGN_IN"})}logout(){this._userService.send({type:"SIGN_OUT",redirectUrl:`${window.location.origin}/editor/`})}check(e){if(e){if((o=this._userService.state).matches("hasSign")&&(null===(n=o.context)||void 0===n?void 0:n.userInfo)&&Object.prototype.hasOwnProperty.call(o.context.userInfo,"uid")&&Object.prototype.hasOwnProperty.call(o.context.userInfo,"region")){var t;const e=null!=(i=null===(t=this._userService.state)||void 0===t?void 0:t.context)&&null!==(r=i.userInfo)&&void 0!==r&&r.uid&&null!==(s=i.userInfo)&&void 0!==s&&s.region?{...i.userInfo,region:null===(a=i.userInfo)||void 0===a?void 0:a.region}:null;this.profile=null!=e&&e.region?e:null}else this.profile=null;return this.profile}return this.profile;var i,r,s,a,o,n}getReqDomain(){return a.U.getReqDomain()}})||r)||r,S=i(50135),k=i(11888);const b=new T;S.A.setLoginSdk(b),b.mount(),null===(A=a.U.listenLoginOut)||void 0===A||A.call(a.U,(()=>{S.A.doNotBlockWindowClose=!0}));const C=()=>{const e=S.A.eventTracker;var t;b.profile?(s.s.setVars({web_idc:b.webIDC,country_code:b.region,...b.getReqDomain()}),null==e||e.auth(b.profile.uid),null==e||e.setRegion(b.profile.region),null===(t=l.Zq.sdk)||void 0===t||t.call(l.Zq,"config",{userId:b.profile.uid})):(null==e||e.auth(""),null==e||e.setRegion(""));S.A.setUserProfile(b.profile),S.A.pullQuota()};b.once("lifecycle:mounted",(()=>{var e,t,i;null===k.A||void 0===k.A||null===(e=k.A.config)||void 0===e||e.call(k.A,{custom:{is_vip:void 0===(null===(t=b.vipInfo)||void 0===t?void 0:t.flag)?void 0:Number(null===(i=b.vipInfo)||void 0===i?void 0:i.flag)}}),C(),b.on("changed:uid",(()=>{C()})),S.A.persistStore.restore(),b.profile||b.login({enter_from:"editor_login_popup",tool_type:n.Ww[(0,o.b0)(S.A.smartToolType)],current_page:"smart_tool_page"})})),b.on("changed:cloudInfo",(()=>{S.A.setCloudInfo(b.cloudInfo)}));var x=b},50135:function(e,t,i){var r=i(52882),s=i(55964);const a=new r.se({smartToolType:s.bs});a.init(),window.__store=a,t.A=a},52882:function(e,t,i){i.d(t,{$u:function(){return ee},se:function(){return ie},xM:function(){return re}});var r=i(40492),s=i(85371),a=i(37814),o=i(56932),n=i(45400),l=i(66279),d=i(49392),c=i(20716),u=i(92431),p=i(42958),h=i(50501),f=i(67308),m=i(57672),v=i(28172),g=i(77024),y=i(22194),_=i(66431),w=i(31399),I=i(74296),A=i(46012),T=i(34984),S=i(61785);async function k(e){const t=document.createElement("img");return new Promise((i=>{t.onload=()=>i({width:t.naturalWidth,height:t.naturalHeight}),t.onerror=()=>i(void 0),t.src=new Function('return typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this)')().xssNamespace.cc_web_editor_smart_toolbox.filterUrl(e,null,{logType:"js.href/src",mode:"black",reportOnly:"all"})}))}var b=i(62822),C=i(14148),x=i(84827),P=i(53265),U=i(47890),F=i(88411),L=i(81246);const E="https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/ies/lvweb_os_monorepo/platform/image/transform_eb4509a92aaf5d299dcc.jpg",M="https://sf16-va.tiktokcdn.com/obj/eden-va2/5270eh7bsupebk/transform.mp4",O=(e,t)=>{const i=[];for(let r=0;r<t;r++)i.push({...e,resource_id:`${e.resource_id}-${r}`,level:r+1});return i};O({resource_id:"adsaq23sfsjhuk",resource_type:0,level:1,width:"1920",height:"1080",idc:0,task_id:"1111222",video:{cover:{url:E,key:"adsaq23sfsjhuk"},play_info:{url:M,key:"adsaq23sfsjhuk"}}},1),O({id:"232fsf32423sdf",resource_id:"232fsf32423sdf",resource_name:"xxxx",resource_type:0,prompt:"a red hourse",style_key:"yyyy",cover:E,width:"1920",height:"1080",idc:0,play_info:{main_url:M,back_url:M}},4),O({resource_id:"asda2dfs34234dss",message:"success",asset_id:"22cscwr4dssf",md5:"22cscwr4dssf",status:2},4);var R=i(68342),j=i(54006),K=i(31635),V=i(61242),q=i(90157),N=i(42962),D=i(59111),z=i(84698);class W{constructor(){var e;(0,r.A)(this,"language","en"),(0,r.A)(this,"lvLocale",void 0),(0,h.l_)(this,{lvLocale:!1}),this.lvLocale=new D.j({countryCode:null===(e=window)||void 0===e?void 0:e.__locationCountryCode,getBrowserLang:()=>window.navigator.language,cookieGetter:z.A.get.bind(z.A),cookieSetter:z.A.set.bind(z.A)})}i18nSetLang(e){return new Promise(((t,i)=>{this.setLvLocaleLanguage(e),C.F2.setLang(e,(e=>{e?(i(e),this.setLvLocaleLanguage(C.F2.language)):t()})),this.setLvLocaleLanguage(C.F2.language)}))}setLvLocaleLanguage(e){this.lvLocale.setCurrentLocale(e)}setLanguage(e){this.language=e}}var B=i(34141),$=i(91776),Z=i(45074),H=i(76021),G=i(76398),Y=i(41048);let Q=function(e){return e.LocalFile="LocalFile",e.Preset="Preset",e.Prompt="Prompt",e.PromptWithPreset="PromptWithPreset",e}({});class J{constructor(){(0,r.A)(this,"store",void 0),(0,r.A)(this,"stopSaving",!1),(0,r.A)(this,"restore",(0,H.A)((async()=>{await this.tryLoadLandingPageData()||await this.trySimilarTookData()||this._restore()})))}setStStore(e){(0,h.l_)(this,{store:!1}),this.store=e}save(){var e,t,i,r;if(this.stopSaving)return;const s={...(0,G.A)(this.store,["aiWorksList","aiWorksInView","exportedVideoAsset","regenerateAsset","loginType","assetList","mainMaterial","attributes","attributeOptions","exportTaskId","pageLifeCycle","_lifeCycleBeforeAiProcess","rawMaterialInfo","prompt","smartToolType","originalPlayInfo","generatedPlayInfo","_originalPlayInfoUpdateTime","_generatedPlayInfoUpdateTime","isViewOriginal","aiWorksTaskId","aiWorksParams","aiCreateRequestCache"]),uid:null===(e=this.store.profile)||void 0===e?void 0:e.uid,workspaceId:null===(t=this.store.profile)||void 0===t?void 0:t.spaceInfo.workspaceId,mainMaterialStatus:null===(i=this.store.mainMaterialInfo)||void 0===i||null===(i=i.material)||void 0===i?void 0:i.fileStatus},a=(0,$.A)(s,["mainMaterial.material.coverUrl","mainMaterial.material.spriteData","mainMaterial.material.waves"]);a.assetList=null===(r=a.assetList)||void 0===r?void 0:r.map((e=>(0,$.A)(e,["material.coverUrl","material.spriteData","material.waves"]))),sessionStorage.setItem(F.Jh,JSON.stringify(a))}setStopSaving(e=!0){this.stopSaving=e}_restore(){var e,t,i,r,s;const a=(0,b.dZ)(sessionStorage.getItem(F.Jh));if(!a)return;if(a.smartToolType!==this.store.smartToolType||a.loginType!==this.store.loginType||a.workspaceId!==(null===(e=this.store.profile)||void 0===e?void 0:e.spaceInfo.workspaceId)||"cloud"===a.loginType&&"cloud"===this.store.loginType&&a.uid!==(null===(t=this.store.profile)||void 0===t?void 0:t.uid))return void this.resetCache();const o=33e5;if(Date.now()-a._originalPlayInfoUpdateTime>o||Date.now()-a._generatedPlayInfoUpdateTime>o)return void this.resetCache();this.store.aiWorksList=a.aiWorksList,this.setAssetList(a.loginType,a.assetList),this.store.mainMaterial=a.mainMaterial,this.store.attributes=a.attributes,this.store.attributeOptions=null!==(i=a.attributeOptions)&&void 0!==i?i:this.store.attributeOptions,this.store.exportTaskId=a.exportTaskId,this.store.prompt=a.prompt,this.store.generatedPlayInfo=a.generatedPlayInfo,this.store.isViewOriginal=a.isViewOriginal,this.store.aiWorksTaskId=a.aiWorksTaskId,this.store.aiWorksInView=a.aiWorksInView,this.store.exportedVideoAsset=a.exportedVideoAsset,this.store.regenerateAsset=a.regenerateAsset,this.store._lifeCycleBeforeAiProcess=a._lifeCycleBeforeAiProcess,this.store.rawMaterialInfo=a.rawMaterialInfo,this.store.aiWorksParams=a.aiWorksParams,Object.assign(this.store.aiCreateRequestCache,a.aiCreateRequestCache);let n=a.pageLifeCycle,l=a.originalPlayInfo;if(ee.DefaultEmpty,this.store.mainMaterial&&a.mainMaterialStatus===m.o.Online&&(this.store._ignoreTranscodeSuccess=!0),n!==ee.Uploading){if(this.store._aiImportStartTime=Date.now(),null===(r=l)||void 0===r||null===(r=r.url)||void 0===r||null===(s=r.startsWith)||void 0===s||!s.call(r,"blob:")||!a.mainMaterial)return this.store.setOriginalPlayInfo(l),void this.setLifeCycle(n);if(n===ee.Transcoding)n=ee.Transcoding,this.setLifeCycle(n);else{var d;const e=null===(d=a.assetList)||void 0===d?void 0:d.find((e=>{var t,i,r,s;return null!==(t=this.store.mainMaterial)&&void 0!==t&&t.md5?e.md5===(null===(i=this.store.mainMaterial)||void 0===i?void 0:i.md5):!(null===(r=this.store.mainMaterial)||void 0===r||!r.fileId)&&e.fileId===(null===(s=this.store.mainMaterial)||void 0===s?void 0:s.fileId)}));if("video"===this.store.toolMaterialType){const t=((null==e?void 0:e.material)||{}).playInfo;t?(l=t,this.store.setOriginalPlayInfo(l),this.store.setLifeCycle(n)):console.error("cannot get play info from material: ",this.store.mainMaterial)}if("image"===this.store.toolMaterialType){const t=((null==e?void 0:e.material)||{}).encryptedCover;if(t)if(t.key){const e=(0,u.A)(a.attributes),i=(0,u.A)(a.attributeOptions);(0,S.fK)(this.store.filerCloud,t.url,t.key).then((t=>{const r=URL.createObjectURL(new Blob([t],{type:"image/jpg"}));l={url:r},this.store.setOriginalPlayInfo(l),this.setLifeCycle(n),this.store.attributes=e,this.store.attributeOptions=i}))}else l={url:t.url},this.store.setOriginalPlayInfo(l),this.setLifeCycle(n);else console.error("cannot get play info from material: ",this.store.mainMaterial)}}}else this.store.generatedPlayInfo=void 0}async setLifeCycle(e){if(this.store.pageLifeCycle=e,this.store.pageLifeCycle===ee.AIProcessing)this.store.aiWorksTaskId?this.store.handleQueryAiProcess(this.store.aiWorksTaskId):this.store.setLifeCycle(this.store._lifeCycleBeforeAiProcess);else if(this.store.pageLifeCycle===ee.Exporting)try{var t,i,r;this.store.handleExportStart();const e=await this.store.handleSyncAsset(null===(t=this.store.aiWorksList)||void 0===t||null===(t=t[0])||void 0===t?void 0:t.works,!0);if(!e)return void this.store.handleExportFail();const s=await(null===(i=this.store.filerCloud)||void 0===i?void 0:i._sdk.getAssetByMd5(null===(r=e.sync_asset_state)||void 0===r?void 0:r[0].md5));this.store.setExportedVideoAsset({...s._sourceData}),this.store.handleExportSuccess()}catch(s){this.store.handleExportFail(),A.Zq.log("smart_toolbox","failed to start exporting on reload",s,{scene:"handleExportStart"})}}async trySimilarTookData(){const e=new URLSearchParams(location.search).get("asset_id");return!!e&&(this.store._repotSmartToolPage({action:"import",import_type:"smart_tool"}),this.store.setRelatedAssetId(e),!0)}async tryLoadLandingPageData(){const e=new URLSearchParams(location.search).get("landing_resource");if(!e)return!1;const t=await(0,Y.Jt)(e).catch((e=>{A.Zq.log("idb_get_error","indexDb get cache error",e,{scene:"tryLoadLandingPageData"})}));return!!t&&((0,Y.yH)(e),await(0,h.z7)((()=>Boolean(this.store.filerCloud))),this.handleLandingPageData(t),!0)}async handleLandingPageData(e){if((0,Z.A)(e))switch(e=await this.mayRefreshPreset(e),this.store.smartToolType){case w.K8.TextToImage:case w.K8.ImageToImage:return void this.handleLandingPageDataForAIGCTools(e);case w.K8.ImageStyleAvatar:case w.K8.ImageStyleConversion:case w.K8.ImageUpscaler:case w.K8.VideoStyleConversion:case w.K8.VideoUpscaler:case w.K8.VideoSlowMotion:case w.K8.VideoStabilization:case w.K8.ImageAiToning:case w.K8.ImageColoring:case w.K8.ImageRestoration:case w.K8.ImageNightEnhance:if(e.type===Q.LocalFile)this.store._localFileToUpload=e.file;else if(e.type===Q.Preset){var t;if(null===(t=e.preset)||void 0===t||!t.resource_id)return;this.store.handleSelectPreset(e.preset)}return;case void 0:return;default:(0,b.xb)(this.store.smartToolType)}}async mayRefreshPreset(e){if("preset"in e&&"updateTime"in e&&e.preset&&e.updateTime){const t=e.updateTime;if(Date.now()-t>18e5){const t=await _.QA.getSeoResourceList({smart_tool_type:this.store.smartToolType,refer_source:I.wx.landing}).catch((()=>{})),i=(0,B.A)(t,(e=>e.sublist)).find((t=>t.id===e.preset.id));i&&(e.preset=i)}}return e}handleLandingPageDataForAIGCTools(e){var t;switch(e.type){case Q.Prompt:if(!e.prompt)return;return this.store.attributes.prompt=e.prompt,e.style&&(this.store.attributes.style=e.style),void this.store.handleStartAiProcess();case Q.PromptWithPreset:if(null===(t=e.preset)||void 0===t||!t.resource_id)return;return e.prompt&&(this.store.attributes.prompt=e.prompt),e.preset.style_key&&(this.store.attributes.style=e.preset.style_key),this.store.handleSelectPreset(e.preset),void this.store.handleStartAiProcess();case Q.LocalFile:return void(this.store._localFileToUpload=e.file);case Q.Preset:return;default:(0,b.xb)(e)}}setAssetList(e,t){var i,r,s,a,o,n,l;null!=t&&t.length&&("cloud"===e?(null===(i=this.store.filerCloudStore)||void 0===i||i.packageAssetsSet(t),null===(r=this.store.filerCloudStore)||void 0===r||r.dirtySet("transcode",!0),null===(s=this.store.filerCloudStore)||void 0===s||s.dirtySet("visual",!0)):(null===(a=this.store.filerVisitorStore)||void 0===a||a.visitorAssetsSet(t),null===(o=this.store.filerVisitorStore)||void 0===o||o.dirtySet("transcode",!0),null===(n=this.store.filerVisitorStore)||void 0===n||n.dirtySet("visual",!0),null===(l=this.store.filerVisitorStore)||void 0===l||l.dirtySet("download",!0)))}resetCache(){sessionStorage.removeItem(F.Jh)}}let X=function(e){return e[e.Loading=0]="Loading",e[e.Success=1]="Success",e[e.Empty=2]="Empty",e[e.Error=3]="Error",e}({}),ee=function(e){return e.DefaultEmpty="DefaultEmpty",e.InitWithPreset="InitWithPreset",e.Uploading="Uploading",e.Transcoding="Transcoding",e.ViewOriginAfterUploading="ViewOriginAfterUploading",e.AIProcessing="AIProcessing",e.ViewingProduction="ViewingProduction",e.Exporting="Exporting",e.Exported="Exported",e}({});const te={my_device:"UPLOAD_MATERIAL",local:"UPLOAD_MATERIAL",my_space:"IMPORT_FROM_FILE_CLOUD",google_drive:"IMPORT_FROM_GOOGLE_DRIVE",dropbox:"IMPORT_FROM_DROPBOX",preset:"IMPORT_FROM_PRESET_MATERIAL"};class ie{get filerVisitorStore(){var e;return null===(e=this.filerVisitor)||void 0===e?void 0:e.store}get filerCloudStore(){var e;return null===(e=this.filerCloud)||void 0===e?void 0:e.store}get lifeCycle(){return this.pageLifeCycle}get currentPlayInfo(){var e;return this.isViewOriginal||null===(e=this.generatedPlayInfo)||void 0===e||!e.url?this.originalPlayInfo:this.generatedPlayInfo}get spaceDirectoryAssetId(){return this.currentSpaceDirectoryAssetId}get mainMaterialInfo(){var e,t;return"cloud"===this.loginType?null===(e=this.filerCloudStore)||void 0===e?void 0:e.packageAssets.find((e=>{var t,i;return(null===(t=e.material)||void 0===t?void 0:t.md5)===(null===(i=this.mainMaterial)||void 0===i?void 0:i.md5)})):null===(t=this.filerVisitorStore)||void 0===t?void 0:t.visitorAssets.find((e=>{var t;return e.fileId===(null===(t=this.mainMaterial)||void 0===t?void 0:t.fileId)}))}get uploadingMaterialInfo(){var e,t;if(this.uploadingMainMaterial)return"cloud"===this.loginType?null===(e=this.filerCloudStore)||void 0===e?void 0:e.uploadFiles.find((e=>{var t;return e.file===(null===(t=this.uploadingMainMaterial)||void 0===t?void 0:t.file)})):null===(t=this.filerVisitorStore)||void 0===t?void 0:t.uploadFiles.find((e=>{var t;return e.file===(null===(t=this.uploadingMainMaterial)||void 0===t?void 0:t.file)}))}get isUploadingOrTranscoding(){return[ee.Uploading,ee.Transcoding].includes(this.pageLifeCycle)}get uploadAndTranscodeProgress(){var e,t;return null!==(e=this.mainMaterialInfo)&&void 0!==e&&e.material?this.mainMaterialInfo.material.progressTranscode/2+.5:null!==(t=this.uploadingMaterialInfo)&&void 0!==t&&t.material?this.uploadingMaterialInfo.progress/2:0}get toolMaterialType(){if(void 0===this.smartToolType)return;return{[w.K8.TextToImage]:"image",[w.K8.ImageToImage]:"image",[w.K8.ImageStyleAvatar]:"image",[w.K8.ImageNightEnhance]:"image",[w.K8.ImageStyleConversion]:"image",[w.K8.ImageUpscaler]:"image",[w.K8.ImageAiToning]:"image",[w.K8.ImageColoring]:"image",[w.K8.ImageRestoration]:"image",[w.K8.VideoStyleConversion]:"video",[w.K8.VideoUpscaler]:"video",[w.K8.VideoSlowMotion]:"video",[w.K8.VideoStabilization]:"video"}[this.smartToolType]}get shouldStartProcessingOnUpload(){switch(this.smartToolType){case w.K8.TextToImage:case w.K8.ImageToImage:case w.K8.ImageStyleAvatar:case w.K8.ImageStyleConversion:case w.K8.ImageUpscaler:case w.K8.VideoStyleConversion:case w.K8.VideoUpscaler:case w.K8.VideoSlowMotion:return!1;case w.K8.VideoStabilization:case w.K8.ImageAiToning:case w.K8.ImageColoring:case w.K8.ImageRestoration:case w.K8.ImageNightEnhance:return!0;case void 0:return!1;default:(0,b.xb)(this.smartToolType)}return!1}get shouldGetResourceInMem(){switch(this.smartToolType){case w.K8.TextToImage:case w.K8.ImageToImage:case w.K8.ImageStyleAvatar:case w.K8.ImageStyleConversion:case w.K8.ImageUpscaler:case w.K8.VideoStyleConversion:case w.K8.VideoUpscaler:case w.K8.VideoSlowMotion:case w.K8.VideoStabilization:case w.K8.ImageColoring:return!1;case w.K8.ImageAiToning:case w.K8.ImageRestoration:case w.K8.ImageNightEnhance:return!0;case void 0:return!1;default:(0,b.xb)(this.smartToolType)}return!1}get paramIsValid(){switch(this.smartToolType){case void 0:return!0;case w.K8.ImageUpscaler:case w.K8.VideoUpscaler:return Boolean(this.attributes.resolution);case w.K8.VideoStyleConversion:case w.K8.ImageStyleAvatar:case w.K8.ImageStyleConversion:return Boolean(this.attributes.style);case w.K8.VideoSlowMotion:return void 0!==this.attributes.level;case w.K8.ImageToImage:return Boolean(this.attributes.prompt&&this.existMainMaterial);case w.K8.TextToImage:return Boolean(this.attributes.prompt);case w.K8.VideoStabilization:case w.K8.ImageAiToning:case w.K8.ImageColoring:case w.K8.ImageRestoration:case w.K8.ImageNightEnhance:return!0;default:(0,b.xb)(this.smartToolType)}return!0}get existMainMaterial(){return Boolean(this.mainMaterial||this.uploadingMainMaterial)}get expandModalInstance(){return this._expandModalInstance}get idc(){var e;return null===(e=this.profile)||void 0===e||null===(e=e.spaceInfo)||void 0===e?void 0:e.spaceIdc}get spaceId(){var e;return null===(e=this.profile)||void 0===e||null===(e=e.spaceInfo)||void 0===e?void 0:e.spaceId}get netconf(){var e;return(null===(e=this.profile)||void 0===e?void 0:e.spaceInfo)&&{base:this.profile.spaceInfo.spaceHost,media:this.profile.spaceInfo.spaceResHost}}constructor({smartToolType:e}){var t;(0,r.A)(this,"filerVisitor",void 0),(0,r.A)(this,"filerCloud",void 0),(0,r.A)(this,"loginSdkReady",!1),(0,r.A)(this,"modified",!1),(0,r.A)(this,"profile",void 0),(0,r.A)(this,"loginSdk",void 0),(0,r.A)(this,"cloudInfo",null),(0,r.A)(this,"aiWorksList",[]),(0,r.A)(this,"aiWorksInView",[]),(0,r.A)(this,"_lastAiWorksInView",[]),(0,r.A)(this,"exportedVideoAsset",void 0),(0,r.A)(this,"regenerateAsset",void 0),(0,r.A)(this,"aiWorksTaskId",void 0),(0,r.A)(this,"aiWorksParams",void 0),(0,r.A)(this,"exportTaskId",void 0),(0,r.A)(this,"attributes",{ratio:y.wx.SquareScreen}),(0,r.A)(this,"attributeOptions",{}),(0,r.A)(this,"smartToolType",void 0),(0,r.A)(this,"pageLifeCycle",ee.DefaultEmpty),(0,r.A)(this,"_aiProcessSeqId",(0,n.A)()),(0,r.A)(this,"_aiQueryTimer",0),(0,r.A)(this,"_lifeCycleBeforeAiProcess",this.pageLifeCycle),(0,r.A)(this,"theme",y.Sx.Light),(0,r.A)(this,"i18n",void 0),(0,r.A)(this,"doNotBlockWindowClose",!1),(0,r.A)(this,"mainMaterial",void 0),(0,r.A)(this,"uploadingMainMaterial",void 0),(0,r.A)(this,"rawMaterialInfo",void 0),(0,r.A)(this,"referenceImageRatio",void 0),(0,r.A)(this,"aigcOutImageRatio",.6),(0,r.A)(this,"originalPlayInfo",void 0),(0,r.A)(this,"generatedPlayInfo",void 0),(0,r.A)(this,"generatedSize",void 0),(0,r.A)(this,"_originalPlayInfoUpdateTime",Date.now()),(0,r.A)(this,"_generatedPlayInfoUpdateTime",Date.now()),(0,r.A)(this,"isViewOriginal",!1),(0,r.A)(this,"isWaitingView",!1),(0,r.A)(this,"isSwitchingView",!1),(0,r.A)(this,"prevLifeCycle",void 0),(0,r.A)(this,"aiCreateRequestCache",void 0),(0,r.A)(this,"quota",void 0),(0,r.A)(this,"_aiStartTime",void 0),(0,r.A)(this,"_syncAssetStartTime",void 0),(0,r.A)(this,"_userImportStartTime",void 0),(0,r.A)(this,"_aiImportStartTime",void 0),(0,r.A)(this,"_uploadStart",0),(0,r.A)(this,"_editingMore",!1),(0,r.A)(this,"_selectedAiMaterials",[]),(0,r.A)(this,"_processCache",{}),(0,r.A)(this,"_expandModalInstance",void 0),(0,r.A)(this,"workspaceList",[]),(0,r.A)(this,"spaceDirectoryMap",new Map),(0,r.A)(this,"currentSpaceDirectoryAssetId","-1"),(0,r.A)(this,"directoryPath",[{value:"-1",label:(null===(t=this.workspaceList)||void 0===t||null===(t=t.find((e=>{var t;return e.workspace_id===(null===(t=this.profile)||void 0===t?void 0:t.spaceInfo.workspaceId)})))||void 0===t?void 0:t.name)||"My space",type:"folder"}]),(0,r.A)(this,"spaceLoadingStatus",X.Empty),(0,r.A)(this,"isPlayQuickImportFile",!0),(0,r.A)(this,"persistStore",void 0),(0,r.A)(this,"relatedAssetId",void 0),(0,r.A)(this,"autoAiProcessAfterUploaded",!1),(0,r.A)(this,"aiProcessLoadingForView",!1),(0,r.A)(this,"aiProcessProgress",0),(0,r.A)(this,"expandOnExport",!1),(0,r.A)(this,"expandOnSync",!1),(0,r.A)(this,"expandOnUpload",!1),(0,r.A)(this,"expandOnUpgrade",!1),(0,r.A)(this,"eventTracker",void 0),(0,r.A)(this,"_localFileToUpload",void 0),(0,r.A)(this,"_ignoreTranscodeSuccess",!1),(0,r.A)(this,"_isLoadingPlayInfoFromCloud",!1),(0,r.A)(this,"pullQuota",(async()=>{const e=await _.M3.getQuota({smart_tool_type:this.smartToolType});(0,h.h5)((()=>{this.quota=e}))})),(0,r.A)(this,"handleSyncAsset",(async(e,t,i=!0,r=!0)=>{this._syncAssetStartTime=Date.now();try{var s,a,o,n;const l={workspace_id:null===(s=this.profile)||void 0===s?void 0:s.spaceInfo.workspaceId,resources:e.map((e=>"preset"===e.source?{source_idc:e.idc,resource_id:e.resource_id,resource_type:e.resource_type,resource_name:e.resource_name}:{source_idc:e.idc,resource_id:e.resource_id,task_id:e.task_id,resource_name:e.resource_name,resource_type:e.resource_type}))},d=null===(a=this.eventTracker)||void 0===a||null===(a=a.tea)||void 0===a?void 0:a.getConfig().header,c=e.map((e=>{var t,i,r;const s=null===(t=e.resource_name)||void 0===t?void 0:t.split("."),a=null!=s&&s.length?null==s?void 0:s[s.length-1]:"",o={resource_id:e.resource_id,text_cnt:0,format:a,is_vip:void 0===(null===(i=this.loginSdk)||void 0===i||null===(i=i.vipInfo)||void 0===i?void 0:i.flag)?void 0:Number(null===(r=this.loginSdk)||void 0===r||null===(r=r.vipInfo)||void 0===r?void 0:r.flag)};switch(e.resource_type){case I.vt.image:o.picture_id=e.report_id;break;case I.vt.video:o.video_id=e.report_id}return o})),u={header:d,client_ip:"",user:{user_id:null===(o=this.profile)||void 0===o?void 0:o.uid,user_is_login:!0,user_unique_id:null===(n=this.profile)||void 0===n?void 0:n.uid,web_id:d.custom.web_id}};r&&(u.params=c),t&&(l.package_transfered_from=(0,b.b0)(this.smartToolType),l.package_type=4,l.custom_info=JSON.stringify(u),l.smart_tool_type=this.smartToolType);const p=await _.w8.SyncAsset(l,{ifShow:i});if(p.asset_md5_map&&Object.values(p.asset_md5_map).filter(Boolean).length){return{status:I.um.SyncStateSuccess,sync_asset_state:Object.entries(p.asset_md5_map).map((([e,t])=>({resource_id:e,md5:t})))}}return new Promise(((t,r)=>{const s=async()=>{try{var a;const o=await _.w8.SyncState({resource_ids:e.map((e=>e.resource_id)),workspace_id:null===(a=this.profile)||void 0===a?void 0:a.spaceInfo.workspaceId},{ifShow:i});switch(o.status){case I.um.SyncStateSuccess:this._reportSyncAssetTime(e.length),this._syncAssetStartTime=void 0,t(o);break;case I.um.SyncStateProcessing:setTimeout(s,1e3);break;default:this._syncAssetStartTime=void 0,r(new Error(`SyncState api exception status: ${o.status}`))}}catch(o){this._syncAssetStartTime=void 0,r(o)}};i&&s()}))}catch(l){throw this._syncAssetStartTime=void 0,A.Zq.error("ai SyncAssetApi","ai SyncAssetApi api error",void 0,l),l}})),(0,h.l_)(this,{i18n:!1,loginSdk:!1,persistStore:!1,aiCreateRequestCache:!1},{autoBind:!0}),this.i18n=new W,this.persistStore=new J,this.smartToolType=e,this.persistStore.setStStore(this),this.aiCreateRequestCache=x.A.AiCreateCache}setSpaceLoadingStatus(e){this.spaceLoadingStatus=e}get loginType(){var e;return null!==(e=this.profile)&&void 0!==e&&e.uid?"cloud":"visitor"}get assetList(){var e,t;return"cloud"===this.loginType?null===(e=this.filerCloud)||void 0===e?void 0:e.store.packageAssets:null===(t=this.filerVisitor)||void 0===t?void 0:t.store.visitorAssets}get aiProcessDisabled(){return!this.paramIsValid||([w.K8.TextToImage].includes(this.smartToolType)?[ee.Exporting,ee.Exported].includes(this.pageLifeCycle):[ee.DefaultEmpty,ee.InitWithPreset,ee.Exporting,ee.Exported].includes(this.pageLifeCycle))}get aiProcessWaitingUploading(){return[ee.Uploading,ee.Transcoding].includes(this.pageLifeCycle)}get aiProcessLoading(){return this.pageLifeCycle===ee.AIProcessing||this.autoAiProcessAfterUploaded||this.shouldStartProcessingOnUpload&&this.aiProcessWaitingUploading}get aiProcessUnionProgress(){return this.pageLifeCycle===ee.AIProcessing?.3+.7*this.aiProcessProgress:.3*this.uploadAndTranscodeProgress}get prompt(){var e;return(null===(e=this.attributes)||void 0===e?void 0:e.prompt)||""}set prompt(e){this.attributes.prompt=e}get isMigrating(){var e;return"idle"!==(null===(e=this.filerCloudStore)||void 0===e?void 0:e.state.migrate)}init(){this.setupTranscodeListener(),this.setupUploadingListener(),this.setupUserImportListener(),this.setupPlayInfoUpdateListener()}getSpaceDirectoryFiles(e){return this.spaceDirectoryMap.get(e)}setSpaceDirectoryAssetId(e){const t=e.assetId,i=e.name;this.currentSpaceDirectoryAssetId=t;const r=this.directoryPath.findIndex((e=>e.value===t));if(-1===r)this.directoryPath.push({value:t,label:i,type:"folder"}),this.setDirectoryPath([...this.directoryPath]);else{const e=[...this.directoryPath.slice(0,r+1)];e[r]={value:t,label:i,type:"folder"},this.setDirectoryPath([...e])}this.getCurrentSpaceDirectoryFiles()}setDirectoryPath(e){this.directoryPath=e}get cloudDirectoryPath(){return this.directoryPath}get currentSpaceDirectoryFiles(){var e;return null===(e=this.spaceDirectoryMap.get(this.currentSpaceDirectoryAssetId))||void 0===e?void 0:e.files}async getCurrentSpaceDirectoryFiles(){var e;const t=null===(e=this.profile)||void 0===e?void 0:e.spaceInfo.workspaceId;if(t)try{var i;this.setSpaceLoadingStatus(X.Loading);const e=20,r=this.currentSpaceDirectoryAssetId,s=async(i=0)=>{var a;const o=await _.$X.getFileList({parent_id:r,workspace_id:t,asset_types:[N.PW.Directory,N.PW.Asset],is_cross_folder:!1,count:e,offset:i}),n=o.assets,l=o.has_more,d=(0,V.z)(n),c=(null===(a=this.spaceDirectoryMap.get(r))||void 0===a?void 0:a.files)||[],u=[...c,...d.filter((e=>!c.find((t=>t.assetId===e.assetId))))].reduce(((e,t)=>(("folder"===t.type||-1===e.findIndex((e=>e.md5===t.md5)))&&e.push(t),e)),[]);this.setSpaceDirectoryFiles({assetId:r,files:[...u]}),l&&s(i+e)};await s(),null!==(i=this.spaceDirectoryMap.get(r))&&void 0!==i&&null!==(i=i.files)&&void 0!==i&&i.length?this.setSpaceLoadingStatus(X.Success):this.setSpaceLoadingStatus(X.Empty)}catch(r){this.setSpaceLoadingStatus(X.Error)}}setSpaceDirectoryFiles(e){const t=e.assetId,i=e.files;this.spaceDirectoryMap.set(t,{...this.spaceDirectoryMap.get(t),files:i||[]})}resetDirectoryInfo(){var e;this.currentSpaceDirectoryAssetId="-1",this.directoryPath=[{value:"-1",label:(null===(e=this.workspaceList)||void 0===e||null===(e=e.find((e=>{var t;return e.workspace_id===(null===(t=this.profile)||void 0===t?void 0:t.spaceInfo.workspaceId)})))||void 0===e?void 0:e.name)||"My space",type:"folder"}],this.getCurrentSpaceDirectoryFiles()}setExpandModalInstance(e){this._expandModalInstance=e}setSmartToolType(e){this.smartToolType=e}setWaitingView(e){this.isWaitingView=e}setSwitchingView(e){this.isSwitchingView=e}setAiProcessLoadingForView(e){this.aiProcessLoadingForView=e}setViewOrigin(e){this.isViewOriginal=e}updateTheme(e){this.theme=e}setUserProfile(e){this.profile=e}setLoginSdk(e){this.loginSdk=e}setAiWorksTaskId(e){this.aiWorksTaskId=e}setFilerVisitor(e){this.filerVisitor=e}setFilerCloud(e){this.filerCloud=e}handleLoginSdkReady(){this.loginSdkReady=!0}setCloudInfo(e){this.cloudInfo=e}modifiedPlace(){this.modified=!0}modifiedClear(){this.modified=!1}setMainMaterial(e){this.mainMaterial=e}clearMainMaterial(){this.mainMaterial=void 0,this.rawMaterialInfo=void 0,this.uploadingMainMaterial=void 0,this.originalPlayInfo=void 0,this.generatedPlayInfo=void 0}setOriginalPlayInfo(e){this.originalPlayInfo=e}setUploadingMainMaterial(e,t){if(this._userImportStartTime=Date.now(),this.cancelUploadingFile(),this.clearMainMaterial(),q.Ay.performanceMarkStart("upload"),this.uploadingMainMaterial=e,null!=t&&t.fromThirdUpload&&(this.pageLifeCycle=ee.Uploading),!e||null!=t&&t.fromThirdUpload)return;const i={url:URL.createObjectURL(e.file),key:void 0},r=i.url;this.rawMaterialInfo={url:r},("video"===this.toolMaterialType?(0,T.y)(i):k(i.url)).then((e=>{var t;r===(null===(t=this.rawMaterialInfo)||void 0===t?void 0:t.url)&&(0,h.h5)((()=>{null!=e&&e.width&&e.height?(this.rawMaterialInfo={...e,url:i.url},this.originalPlayInfo=i):this.rawMaterialInfo=void 0,this.pageLifeCycle=ee.Uploading}))}))}reportPerformanceMarkEnd({name:e,markName:t,status:i}){var r,o,n,l,d,c,u,p;const h=(0,a.A)({file_size:null===(r=this.mainMaterial)||void 0===r||null===(r=r.material)||void 0===r?void 0:r.size,input_height:null===(o=this.mainMaterialSize)||void 0===o?void 0:o.height,input_width:null===(n=this.mainMaterialSize)||void 0===n?void 0:n.width,generated_height:null===(l=this.generatedSize)||void 0===l?void 0:l.height,generated_widths:null===(d=this.generatedSize)||void 0===d?void 0:d.width,duration:"EXPORT_VIDEO"===e?null===(c=this.exportedVideoAsset)||void 0===c?void 0:c.duration:null===(u=this.mainMaterial)||void 0===u||null===(u=u.material)||void 0===u?void 0:u.duration,resolution:this.attributes.resolution,slow_level:this.attributes.level,output_sum:this.attributes.output,promptWeight:[w.K8.ImageToImage,w.K8.TextToImage].includes(this.smartToolType)?(null===(p=Object.values(this.attributes.advancedSettings||{}))||void 0===p||null===(p=p[0])||void 0===p?void 0:p.promptWeight)||.5:void 0,image_style:this.attributes.style},((e,t)=>(!["input_height","input_width"].includes(t)||![w.K8.ImageToImage,w.K8.TextToImage].includes(this.smartToolType))&&(!("file_size"===t&&![w.K8.VideoUpscaler,w.K8.VideoSlowMotion].includes(this.smartToolType))&&!(0,s.A)(e))));q.Ay.performanceMarkEnd(e,{detail:{action_name:t,event_type:"key_path_perf",status:i,...h}})}updateAttributes(e){this.attributes=(0,l.A)({...this.attributes,...e},d.A);const t=[ee.DefaultEmpty,ee.InitWithPreset,ee.Uploading,ee.Transcoding,ee.ViewOriginAfterUploading,ee.AIProcessing].includes(this.pageLifeCycle);var i;this.shouldGetResourceInMem&&!t&&(this.isViewOriginal=!1,this.generatedPlayInfo=null===(i=this.aiWorksList[0])||void 0===i||null===(i=i.works)||void 0===i||null===(i=i.find((e=>e.level===this.attributes.level)))||void 0===i?void 0:i.image)}updateAttributeOptions(e){this.attributeOptions={...this.attributeOptions,...e}}handleUploadSuccess(e){var t,i;if(null!==(t=e.material)&&void 0!==t&&t.assetId?this.mainMaterial={...e}:this.mainMaterial=e,e.source&&e.material){const t=e.material;let i=(0,o.A)(t.materialSource||e.source);const s=te[i];var r;if(s)q.Ay.performanceMarkEnd("upload",{detail:{event_type:"key_path_perf",status:"success",action_name:s,file_size:null===(r=this.mainMaterial)||void 0===r||null===(r=r.material)||void 0===r?void 0:r.size}});"my_device"===i?i="local":"cloud"===i&&(i="my_space"),this._reportBase("import_material",{status:y.$q.SUCCESS,action_type:e.action,import_time:0!==this._uploadStart?performance.now()-this._uploadStart:0,is_fast_import:0,material_duration:t.duration,material_format:t.ext,material_name:t.name,material_resolution:`${t.width} * ${t.height}`,material_size:t.size/1e3,material_source:i,material_type:t.type}),this._uploadStart=0}this.uploadingMainMaterial=void 0,this.pageLifeCycle===ee.Uploading&&(this.pageLifeCycle=ee.Transcoding);const s=null===(i=this.mainMaterialInfo)||void 0===i?void 0:i.material;(null==s?void 0:s.fileStatus)!==m.o.Online||s.playInfo||("cloud"===this.loginType?(this.filerCloudStore.packageAssetsUpdate({md5:(null==e?void 0:e.md5)||"",material:{fileStatus:m.o.Transcoding}}),this.filerCloudStore.dirtySet("transcode",!0)):(this.filerVisitorStore.visitorAssetsUpdate({fileId:e.fileId,material:{fileStatus:m.o.Transcoding}}),this.filerVisitorStore.dirtySet("transcode",!0)))}handleUploadFailure(e){this.pageLifeCycle=ee.DefaultEmpty,this._reportBase("import_material",{status:e.status,action_type:e.action,is_fast_import:0,material_name:e.file.name,material_size:e.status===y.$q.CANCEL?void 0:e.file.size/1e3,material_type:e.file.type,material_format:e.file.name.split(".").pop(),fail_reason:e.failReason});const t=e.material,i=(0,o.A)((null==t?void 0:t.materialSource)||e.source);if(i){const e=te[i];var r;if(e)q.Ay.performanceMarkEnd("upload",{detail:{event_type:"key_path_perf",status:"success",action_name:e,file_size:null===(r=this.mainMaterial)||void 0===r||null===(r=r.material)||void 0===r?void 0:r.size}})}}get isFromUploadLike(){return[ee.DefaultEmpty,ee.Uploading,ee.Transcoding].includes(this.lifeCycle)&&Boolean(this.mainMaterial)}handleTranscodeSuccess(){var e,t,i,r;if(!(0,R.d)({width:null===(e=this.mainMaterialInfo)||void 0===e||null===(e=e.material)||void 0===e?void 0:e.width,height:null===(t=this.mainMaterialInfo)||void 0===t||null===(t=t.material)||void 0===t?void 0:t.height,duration:((null===(i=this.mainMaterialInfo)||void 0===i||null===(i=i.material)||void 0===i?void 0:i.duration)||0)/1e3,acceptType:this.toolMaterialType,eventTracker:this.eventTracker,smartToolType:this.smartToolType}))return void this.resetToEmpty();const s=this.isFromUploadLike;s&&(this.pageLifeCycle=ee.ViewOriginAfterUploading),s&&(this.shouldStartProcessingOnUpload||this.autoAiProcessAfterUploaded)&&this.handleEnterAiProcess();const a="video"===this.toolMaterialType,o=null===(r=this.mainMaterialInfo)||void 0===r?void 0:r.material,n=a?o.playInfo:o.encryptedCover?o.encryptedCover:{url:o.coverUrl,key:void 0};if(!this.originalPlayInfo){if(null==n||!n.url){if(this._isLoadingPlayInfoFromCloud)return;return console.error("play info not found after transcoding"),A.Zq.error("st-store","play info not found after transcoding"),g.A.error(C.F2.t("web_magicTools_toast_generate_fail",{},"Something went wrong. Try again.")),void this.handleTranscodeFailure()}if("video"===this.toolMaterialType&&"video"!==o.groupType||"image"===this.toolMaterialType&&"image"!==o.groupType){if(this._isLoadingPlayInfoFromCloud)return;return console.error("play info not match after transcoding"),A.Zq.error("st-store","play info not match after transcoding"),g.A.error(C.F2.t("web_magicTools_toast_generate_fail",{},"Something went wrong. Try again.")),void this.handleTranscodeFailure()}!a&&n.key?(0,S.fK)(this.filerCloud,n.url,n.key).then((e=>{(0,h.h5)((()=>{const t=URL.createObjectURL(new Blob([e],{type:"image/jpg"}));this.originalPlayInfo={url:t}}))})):this.originalPlayInfo=n}}async handleSelectCloudFile(e){var t,i;if(this.mainMaterial=e,this.originalPlayInfo=void 0,this.generatedPlayInfo=void 0,"image"===this.toolMaterialType&&(null===(t=this.mainMaterialInfo)||void 0===t?void 0:t.material).coverUrl)return this.originalPlayInfo={url:(null===(i=this.mainMaterialInfo)||void 0===i?void 0:i.material).coverUrl},this.pageLifeCycle=ee.ViewOriginAfterUploading,void(this.shouldStartProcessingOnUpload&&this.handleStartAiProcess());try{var r;this._isLoadingPlayInfoFromCloud=!0;const t=await(null===(r=this.filerCloud)||void 0===r?void 0:r.updatePlayInfo(e.md5,!0));(0,h.h5)((()=>{null!=t&&t.url&&null!=t&&t.decryptKey?(this.originalPlayInfo={url:t.url,key:t.decryptKey},this.lifeCycle!==ee.AIProcessing&&(this.pageLifeCycle=ee.ViewOriginAfterUploading,this.shouldStartProcessingOnUpload&&this.handleStartAiProcess())):this.pageLifeCycle=ee.Transcoding}))}finally{(0,h.h5)((()=>{this._isLoadingPlayInfoFromCloud=!1}))}}handleTranscodeFailure(){this.pageLifeCycle=ee.DefaultEmpty,this.mainMaterial=void 0,this.originalPlayInfo=void 0}async regenerateImage(e){if(this._repotSmartToolPage({action:"generate",...this._getAttributeReportParams(!0)}),this._aiStartTime=Date.now(),this.aiProcessDisabled)return;const t=this.aiWorksInView[e];this.pageLifeCycle=ee.AIProcessing,this.aiWorksInView[e]={};const i=this.aiWorksTaskId,r=async t=>{if(this.smartToolType&&this.aiWorksTaskId===i)try{var s;const i=await _.Z2.AiProcessQuery({task_id:t,workspace_id:(null===(s=this.profile)||void 0===s?void 0:s.spaceInfo.workspaceId)||""}),a=i.status,o=i.task_detail;if(a===I.kS.Processing)window.setTimeout((()=>r(t)),1e3);else{if(a!==I.kS.Success)throw g.A.error(C.F2.t("web_magicTools_toast_generate_fail",{},"Couldn\u2019t generate. Try again later.")),this._reportGenerateStatus({status:"fail",fail_reason:"web_magicTools_toast_generate_fail"}),A.Zq.log("smart-toolbox-api-error","",new Error(""),{videoeditorScmVersionV1:void 0,videoeditorScmVersionV2:void 0,videoeditorScmVersionV3:void 0,videoeditorScmVersionV4:void 0,pageUrl:location.hostname+location.pathname,url:"/intelligence/query",baseURL:p.s.getVar("web_domain"),errorCode:a}),new Error(`exception status: ${a}`);this.aiWorksInView[e]=null==o?void 0:o[0],this.aiWorksList[0].works[e]=null==o?void 0:o[0],this.handleAiProcessSuccess(),this._reportGenerateStatus({status:"success"}),this.pullQuota()}}catch(a){this.pullQuota(),this._aiStartTime=void 0,A.Zq.error("ai process","ai AiProcessQuery api error",void 0,a),this.handleAiProcessFailed()}},s={type:"fresh",data:await _.Z2.MatchAiCreate({task_id:t.task_id||"",quantity:1})}.data;r(null==s?void 0:s.task_id)}handleStartAiProcess(){this._repotSmartToolPage({action:"generate",...this._getAttributeReportParams(!0)}),this._aiStartTime=Date.now(),q.Ay.performanceMarkStart("image"===this.toolMaterialType?"GENERATE_IMAGE":"GENERATE_VIDEO",{reportInterval:3e4}),this.aiProcessDisabled||(this.aiWorksParams={attributes:this.attributes},this._lastAiWorksInView=this.aiWorksInView.slice(),!this.regenerateAsset&&[w.oQ.TextToImage,w.oQ.ImageToImage].includes(this.smartToolType)&&(this.aiWorksInView=new Array(this.aiWorksParams.attributes.output).fill({})),this.regenerateAsset||this.setAigcOutImageRatio((0,w.r6)(this.smartToolType,this.mainMaterialSize,this.attributes.ratio)),this.aiProcessWaitingUploading?this.autoAiProcessAfterUploaded=!0:this.handleEnterAiProcess())}setupUploadingListener(){(0,h.mJ)((()=>this.originalPlayInfo),(e=>{}))}setWorkspaceList(e){this.workspaceList=e}async handleEnterAiProcess(){var e,t,i,r,s,a,o;this.autoAiProcessAfterUploaded=!1;const l=(0,n.A)();this._aiProcessSeqId=l,this._lifeCycleBeforeAiProcess=this.pageLifeCycle,this.aiWorksTaskId=void 0,this.aiWorksParams=null!==(e=this.aiWorksParams)&&void 0!==e?e:{attributes:this.attributes};const d=this.aiWorksParams.attributes;if(this.aiProcessProgress=0,!this.smartToolType)return void console.error("not set smartToolType",this.smartToolType);if([w.K8.TextToImage,w.K8.ImageToImage].includes(this.smartToolType)){const e=this.regenerateAsset?1:0;this.aiWorksInView=new Array(this.aiWorksParams.attributes.output-e||1).fill({}),this.regenerateAsset?this.aiWorksInView.splice(this.regenerateAsset.currenIndex||0,0,this.regenerateAsset.resource):this.setAigcOutImageRatio((0,w.r6)(this.smartToolType,this.mainMaterialSize,this.attributes.ratio))}let c;this.pageLifeCycle=ee.AIProcessing;const u=this.mainMaterial,p="preset"===(null===(t=this.mainMaterial)||void 0===t?void 0:t.source)||!(null!==(i=this.mainMaterial)&&void 0!==i&&i.md5),f={asset_id:(null===(r=this.mainMaterial)||void 0===r?void 0:r.assetId)||(p?null===(s=this.filerVisitorStore)||void 0===s||null===(s=s.visitorAssets.find((e=>e.fileId===u.fileId)))||void 0===s||null===(s=s.material)||void 0===s?void 0:s.vid:null===(a=this.filerCloudStore)||void 0===a||null===(a=a.packageAssets.find((e=>e.md5===u.md5)))||void 0===a||null===(a=a.material)||void 0===a?void 0:a.assetId),platform:p?I.Yw.Vcloud:I.Yw.Evercloud,resource_idc:null==u?void 0:u.resourceIdc,workspace_id:(null==u?void 0:u.workspaceId)||(null===(o=this.profile)||void 0===o?void 0:o.spaceInfo.workspaceId)};try{var m,v;switch(this.smartToolType){case w.K8.VideoUpscaler:{const e=this.mainMaterialSize,t=e.width,i=e.height,r=t&&i&&d.resolution?(0,U.w)([t,i],d.resolution):void 0,s=r?{width:r[0],height:r[1]}:{};c=await this.checkCacheAndStartAiProcess({...f,smart_tool_type:this.smartToolType,params:{...s}})}break;case w.K8.ImageUpscaler:{const e=this.mainMaterialSize,t=e.width,i=e.height,r=t&&i&&d.resolution?(0,U.v)([t,i],d.resolution):void 0,s=r?{width:r[0],height:r[1]}:{};c=await this.checkCacheAndStartAiProcess({...f,smart_tool_type:this.smartToolType,params:{...s}})}break;case w.K8.ImageStyleAvatar:c=await this.checkCacheAndStartAiProcess({...f,smart_tool_type:this.smartToolType,params:{style_key:d.style}});break;case w.K8.VideoSlowMotion:c=await this.checkCacheAndStartAiProcess({...f,smart_tool_type:this.smartToolType,params:{level:d.level,mute:d.muted?I.g9.isMute:I.g9.noMute}});break;case w.K8.ImageStyleConversion:c=await this.checkCacheAndStartAiProcess({...f,smart_tool_type:this.smartToolType,params:{style_key:d.style||""}});break;case w.K8.TextToImage:case w.K8.ImageToImage:if(this.regenerateAsset){var g;c={type:"fresh",data:await _.Z2.MatchAiCreate({task_id:(null===(g=this.regenerateAsset.resource)||void 0===g?void 0:g.task_id)||"",quantity:this.aiWorksInView.length-1})}}else{var y;const e=null===(y=d.advancedSettings)||void 0===y?void 0:y[d.style];c={type:"fresh",data:await _.Z2.AiCreate({...f,smart_tool_type:this.smartToolType,params:{prompt:this.prompt,style_key:(null==d?void 0:d.style)||"",quantity:(null==d?void 0:d.output)||1,strength:(0,L.c)("promptWeight",e),scale:(0,L.c)("guidanceScale",e),size_ratio:this.attributes.ratio}})}}break;case w.K8.ImageAiToning:case w.K8.ImageNightEnhance:case w.K8.ImageColoring:case w.K8.ImageRestoration:case w.K8.VideoStabilization:c=await this.checkCacheAndStartAiProcess({...f,smart_tool_type:this.smartToolType,params:void 0});break;case w.K8.VideoStyleConversion:throw new Error(`unimplemented type ${this.smartToolType}`);default:(0,b.xb)(this.smartToolType)}if("cache"===(null===(m=c)||void 0===m?void 0:m.type)&&(this._aiStartTime=void 0,(0,h.h5)((()=>{this.aiProcessProgress=1})),await(T=1500,new Promise((e=>{setTimeout(e,T)})))),this._aiProcessSeqId!==l)return void(this._aiStartTime=void 0);if(!c)throw new Error(`ai create with empty res: ${c}`);if("cache"===(null===(v=c)||void 0===v?void 0:v.type))return void this.handleAiSuccessResp(c.queryRes.task_detail);const e=c.data;(0,h.h5)((()=>{this.aiWorksTaskId=null==e?void 0:e.task_id})),this.handleQueryAiProcess(null==e?void 0:e.task_id)}catch(S){this._reportGenerateStatus({status:"fail",fail_reason:S.message||"ai AiCreate api error"}),this._aiStartTime=void 0,A.Zq.error("ai process","ai AiCreate api error",void 0,S),this.handleAiProcessFailed()}finally{this.pullQuota()}var T}async checkCacheAndStartAiProcess(e){const t=Object.entries(this._processCache).find((([t,{createReq:i}])=>(0,c.A)(e,i)));if(null!=t&&t[1].queryRes)return{type:"cache",queryRes:t[1].queryRes};const i=(0,u.A)(e),r=await _.Z2.AiCreate(e);return this._processCache[r.task_id]={createReq:i},{type:"fresh",data:r}}_reportBase(e,t){var i;null===(i=this.eventTracker)||void 0===i||i.trackerBoomerang(e,{current_page:"smart_tool_page",tool_type:w.Ww[(0,b.b0)(this.smartToolType)],...t},{business:[P.PK.Tool]})}_reportGenerateStatus(e){this._reportBase("smart_tool_generate_status",{...e,...this._getAttributeReportParams(!0)})}_reportAiProcessTime(){var e;this._aiStartTime&&(null===(e=this.eventTracker)||void 0===e||e.track("ai_process_time",{tool_type:this.smartToolType,time:Date.now()-this._aiStartTime,...this.attributes},{business:[P.PK.Tool]}))}async handleQueryAiProcess(e){if(this.aiWorksTaskId&&this.smartToolType&&this.aiWorksTaskId===e)try{var t;const i=await _.Z2.AiProcessQuery({task_id:this.aiWorksTaskId,workspace_id:(null===(t=this.profile)||void 0===t?void 0:t.spaceInfo.workspaceId)||""}),r=i.status,s=i.speed,a=i.task_detail;if((0,h.h5)((()=>{this._processCache[this.aiWorksTaskId]&&r===I.kS.Success&&(this._processCache[this.aiWorksTaskId].queryRes=i),this.aiProcessProgress=s/100})),r===I.kS.Processing)clearTimeout(this._aiQueryTimer),this._aiQueryTimer=window.setTimeout((()=>this.handleQueryAiProcess(e)),1e3);else{if(r!==I.kS.Success)throw g.A.error(C.F2.t("web_magicTools_toast_generate_fail",{},"Couldn\u2019t generate. Try again later.")),this._reportGenerateStatus({status:"fail",fail_reason:"web_magicTools_toast_generate_fail"}),A.Zq.log("smart-toolbox-api-error","",new Error(""),{videoeditorScmVersionV1:void 0,videoeditorScmVersionV2:void 0,videoeditorScmVersionV3:void 0,videoeditorScmVersionV4:void 0,pageUrl:location.hostname+location.pathname,url:"/intelligence/query",baseURL:p.s.getVar("web_domain"),errorCode:r}),new Error(`exception status: ${r}`);this.handleAiSuccessResp(a),this._reportGenerateStatus({status:"success"}),this.pullQuota()}}catch(i){this.pullQuota(),this._aiStartTime=void 0,A.Zq.error("ai process","ai AiProcessQuery api error",void 0,i),this.handleAiProcessFailed()}}handleAiSuccessResp(e){var t,i,r,s,a;switch(this._aiImportStartTime=performance.now(),this.aiWorksList.unshift({attributes:(null===(t=this.aiWorksParams)||void 0===t?void 0:t.attributes)||{},works:e}),this.smartToolType){case w.K8.VideoUpscaler:case w.K8.VideoStabilization:case w.K8.VideoSlowMotion:this.generatedPlayInfo=null===(i=e[0])||void 0===i||null===(i=i.video)||void 0===i?void 0:i.play_info;break;case w.K8.ImageUpscaler:case w.K8.ImageStyleConversion:case w.K8.ImageColoring:case w.K8.ImageStyleAvatar:this.generatedPlayInfo=null===(r=e[0])||void 0===r?void 0:r.image;break;case w.K8.TextToImage:case w.K8.ImageToImage:this.regenerateAsset?(this.aiWorksInView=[...e],this.aiWorksInView.splice(this.regenerateAsset.currenIndex||0,0,this.regenerateAsset.resource),this.regenerateAsset=void 0):this.aiWorksInView=[...e];break;case w.K8.ImageRestoration:case w.K8.ImageNightEnhance:case w.K8.ImageAiToning:{var o;const e=this.smartToolType===w.K8.ImageRestoration?1:3;this.isViewOriginal=!1,this.generatedPlayInfo=null===(o=this.aiWorksList[0])||void 0===o||null===(o=o.works)||void 0===o||null===(o=o.find((t=>t.level===e)))||void 0===o?void 0:o.image,this.updateAttributes({level:e})}break;default:console.error("not resolved ai query")}this.generatedSize={height:null===(s=e[0])||void 0===s?void 0:s.height,width:null===(a=e[0])||void 0===a?void 0:a.width},this.aiWorksTaskId=void 0,this.aiWorksParams=void 0,this.handleAiProcessSuccess()}handleAiProcessSuccess(){this._reportAiProcessTime(),this._aiStartTime=void 0,this.pageLifeCycle=ee.ViewingProduction,this.isViewOriginal=!1,this._generatedPlayInfoUpdateTime=Date.now();const e="image"===this.toolMaterialType?"GENERATE_IMAGE":"GENERATE_VIDEO";this.reportPerformanceMarkEnd({name:e,markName:e,status:"success"})}async cancelUploadingFile(){var e,t,i;const r=null===(e=this.uploadingMainMaterial)||void 0===e?void 0:e.file;if(!r)return;const s=null===(t=this.filerCloud)||void 0===t?void 0:t.store.uploadFiles.find((e=>e.file===r)),a=null===(i=this.filerVisitor)||void 0===i?void 0:i.store.uploadFiles.find((e=>e.file===r));if(a&&this.filerVisitor.uploadCancel(a.fileKey),s){const e=s.request,t=s.requestId,i=s.auth;if(i===v.H7.Third||null!=e&&e.requestId&&"unknow"!==(null==e?void 0:e.requestId)||t&&"unknow"!==t)try{var o;if(i===v.H7.Third)null===(o=this.filerCloud)||void 0===o||o.uploadThirdCancel(s.file);else await this.filerCloud.uploadCancel((null==e?void 0:e.requestId)||t)}catch(n){g.A.error(`${C.F2.t("cancel_upload_failed",{},"Couldn't cancel upload")}`),A.Zq.error("cloud","upload cancel failed","upload_cancel_failed",n)}else this.filerCloudStore.uploadFilesRemove(s)}}resetToEmpty(){this.pageLifeCycle===ee.Uploading&&this.cancelUploadingFile(),this.pageLifeCycle=ee.DefaultEmpty,this.clearMainMaterial()}handleAiProcessFailed(){this.pageLifeCycle===ee.AIProcessing&&(this.pageLifeCycle=this._lifeCycleBeforeAiProcess,this.aiWorksTaskId=void 0,this.aiWorksParams=void 0),this.shouldStartProcessingOnUpload&&this.resetToEmpty(),[w.K8.ImageToImage,w.K8.TextToImage].includes(this.smartToolType)&&(this.aiWorksInView=this._lastAiWorksInView,this.aiWorksInView.length||this.resetToEmpty());const e="image"===this.toolMaterialType?"GENERATE_IMAGE":"GENERATE_VIDEO";this.reportPerformanceMarkEnd({name:e,markName:e,status:"fail"})}handleCancelAiProcess(){const e=this.aiWorksTaskId;this.pageLifeCycle===ee.AIProcessing&&(this.pageLifeCycle=this._lifeCycleBeforeAiProcess,this.aiWorksTaskId=void 0,this.aiWorksParams=void 0),this.shouldStartProcessingOnUpload&&this.resetToEmpty(),this.autoAiProcessAfterUploaded=!1,this._aiProcessSeqId=(0,n.A)(),e&&_.Z2.AiProcessCancel({task_id:e}).catch((e=>console.error("ai cancel api error",void 0,e)))}setupPlayInfoUpdateListener(){(0,h.mJ)((()=>this.originalPlayInfo),(()=>{var e,t,i;this._originalPlayInfoUpdateTime=Date.now(),null!==(e=this.originalPlayInfo)&&void 0!==e&&e.url&&(null===(t=this.rawMaterialInfo)||void 0===t?void 0:t.url)!==(null===(i=this.originalPlayInfo)||void 0===i?void 0:i.url)&&this.resolveRawMaterialInfo(this.originalPlayInfo)}))}setupTranscodeListener(){(0,h.mJ)((()=>{var e;return null===(e=this.mainMaterialInfo)||void 0===e||null===(e=e.material)||void 0===e?void 0:e.fileStatus}),((e,t)=>{if(e===m.o.Online){if(this._ignoreTranscodeSuccess)return void(this._ignoreTranscodeSuccess=!1);this.handleTranscodeSuccess()}})),(0,h.mJ)((()=>this.pageLifeCycle),((e,t)=>{e===ee.Uploading&&(this._uploadStart=performance.now())}))}setupUserImportListener(){(0,h.mJ)((()=>{var e;return null===(e=this.originalPlayInfo)||void 0===e?void 0:e.url}),((e,t)=>{if(e){var i;if(!this._userImportStartTime)return;null===(i=this.eventTracker)||void 0===i||i.track("user_import_material_time",{tool_type:this.smartToolType,time:Date.now()-this._userImportStartTime},{business:[P.PK.Tool]}),this._userImportStartTime=void 0}}))}handleLoginSyncSuccess(e,t){var i,r;(null===(i=this.mainMaterial)||void 0===i?void 0:i.fileId)===e.fileId&&(this.mainMaterial={md5:t.md5,workspaceId:null===(r=this.profile)||void 0===r?void 0:r.spaceInfo.workspaceId})}handlePresetOrAiResource(){this.pageLifeCycle=ee.ViewOriginAfterUploading,this.shouldStartProcessingOnUpload&&this.handleStartAiProcess()}selectPresetStyle(e){if(this.attributes.style=e,this.smartToolType===w.K8.TextToImage||this.smartToolType===w.K8.ImageToImage){const t=(0,w.XC)(this.smartToolType,e);t&&this.updateAttributes({styleCategory:t})}}handleSelectPreset(e){var t,i;q.Ay.performanceMarkStart("IMPORT_FROM_PRESET_MATERIAL"),this._repotSmartToolPage({action:"online_img_select"}),e.style_key&&this.selectPresetStyle(e.style_key),e.strength&&this.updateAttributes({advancedSettings:{[this.attributes.style]:{promptWeight:e.strength}}}),e.scale&&this.updateAttributes({advancedSettings:{[this.attributes.style]:{guidanceScale:e.scale}}}),this.setMainMaterial({assetId:e.resource_id,source:"preset",resourceIdc:e.idc,resourceName:e.resource_name});const r={url:(null==e||null===(t=e.play_info)||void 0===t?void 0:t.main_url)||(null==e||null===(i=e.image_info)||void 0===i?void 0:i.url)||"",key:""};this.setOriginalPlayInfo(r),q.Ay.performanceMarkEnd("IMPORT_FROM_PRESET_MATERIAL",{detail:{event_type:"key_path_perf",action_name:"IMPORT_FROM_PRESET_MATERIAL"}}),this.handlePresetOrAiResource(),this.resolveRawMaterialInfo(r)}resolveRawMaterialInfo(e){if(e.url){const t=e.url;this.rawMaterialInfo={url:t},("video"===this.toolMaterialType?(0,T.y)(e):k(e.url)).then((i=>{var r;t===(null===(r=this.rawMaterialInfo)||void 0===r?void 0:r.url)&&(0,h.h5)((()=>{null!=i&&i.width&&i.height?this.rawMaterialInfo={...i,url:e.url}:this.rawMaterialInfo=void 0}))}))}}setRawMaterialInfo(e){this.rawMaterialInfo=e}get mainMaterialSize(){var e,t,i;const r=null===(e=this.mainMaterialInfo)||void 0===e?void 0:e.material;return{width:(null==r?void 0:r.width)||(null===(t=this.rawMaterialInfo)||void 0===t?void 0:t.width),height:(null==r?void 0:r.height)||(null===(i=this.rawMaterialInfo)||void 0===i?void 0:i.height)}}setLifeCycle(e){this.pageLifeCycle=e}setExportedVideoAsset(e){this.exportedVideoAsset=e}clearStore(){this.mainMaterial=void 0,this.originalPlayInfo=void 0}showExpandOnUploadHide(){this.expandOnUpload=!1}showExpandOnSyncHide(){this.expandOnSync=!1}showExpandOnUpgradeHide(){this.expandOnUpgrade=!1}showExpandOnExportHide(){this.expandOnExport=!1}showExpandOnUploadShow(){this.expandOnUpload=!0,this.pageLifeCycle=ee.DefaultEmpty}showExpandOnSyncShow(){this.expandOnSync=!0}showExpandOnExportShow(){this.expandOnExport=!0}setAigcOutImageRatio(e){this.aigcOutImageRatio=e}_reportSyncAssetTime(e){var t;this._syncAssetStartTime&&(null===(t=this.eventTracker)||void 0===t||t.track("sync_asset_time",{tool_type:this.smartToolType,time:Date.now()-this._syncAssetStartTime,cnt:e},{business:[P.PK.Tool]}))}async shouldShowIllinoisPopup(e){if(![w.oQ.ImageStyleAvatar,w.oQ.ImageStyleConversion,w.oQ.ImageRestoration].includes(e))return!1;if("cloud"===this.loginType){var t;if("true"===localStorage.getItem(`${F.tE}-${null===(t=this.profile)||void 0===t?void 0:t.uid}`))return!1;return(await _.ky.checkPopup()).need_check}if("true"===localStorage.getItem(F.tE))return!1;return(await _.ky.checkPopup()).need_check}handleExportStart(){this.prevLifeCycle=this.pageLifeCycle,this.pageLifeCycle=ee.Exporting;const e="image"===this.toolMaterialType?"EXPORT_IMAGE":"EXPORT_VIDEO";q.Ay.performanceMarkStart(e,{reportInterval:3e4})}handleExportSuccess(){this.prevLifeCycle=void 0,this.pageLifeCycle=ee.Exported;const e="image"===this.toolMaterialType?"EXPORT_IMAGE":"EXPORT_VIDEO";this.reportPerformanceMarkEnd({name:e,markName:e,status:"success"})}handleExportFail(){var e;this.pageLifeCycle=null!==(e=this.prevLifeCycle)&&void 0!==e?e:ee.DefaultEmpty,this.prevLifeCycle=void 0;const t="image"===this.toolMaterialType?"EXPORT_IMAGE":"EXPORT_VIDEO";this.reportPerformanceMarkEnd({name:t,markName:t,status:"fail"})}handleImageExportDone(){this.pageLifeCycle=this.prevLifeCycle||ee.ViewingProduction;const e="image"===this.toolMaterialType?"EXPORT_IMAGE":"EXPORT_VIDEO";this.reportPerformanceMarkEnd({name:e,markName:e,status:"success"})}setEventTracker(e){var t;this.eventTracker=e,null===(t=this.eventTracker)||void 0===t||t.config({evtParams:{tool_type:w.Ww[(0,b.b0)(this.smartToolType)],current_page:"smart_tool_page"},custom:{}})}setRelatedAssetId(e){this.relatedAssetId=e}_repotSmartToolPage(e){var t;null===(t=this.eventTracker)||void 0===t||t.trackerBoomerang("smart_tool_page",{...e,...(0,j.sb)(),tool_type:w.Ww[(0,b.b0)(this.smartToolType)]},{business:[P.PK.Tool]})}_reportAllToolEntrance(e){var t;null===(t=this.eventTracker)||void 0===t||t.trackerBoomerang("all_tool_entrance",{...e,...(0,j.sb)()},{business:[P.PK.Tool]})}_getAttributeReportParams(e=!1){let t={},i={};var r;e?i={...this.attributes}:i={...null===(r=this.aiWorksList)||void 0===r||null===(r=r[0])||void 0===r?void 0:r.attributes};switch(this.smartToolType){case w.K8.ImageUpscaler:case w.K8.VideoUpscaler:t={resolution:i.resolution};break;case w.K8.VideoStyleConversion:case w.K8.ImageStyleAvatar:case w.K8.ImageStyleConversion:t={style:i.style};break;case w.K8.VideoSlowMotion:t={is_mute:i.muted,speed:i.level};break;case w.K8.ImageToImage:case w.K8.TextToImage:t={output_cnt:i.output,style:i.style,prompt:i.prompt,aspect_ratio:"9:16"};case w.K8.VideoStabilization:case w.K8.ImageAiToning:case w.K8.ImageColoring:case w.K8.ImageRestoration:case w.K8.ImageNightEnhance:}return t}_reportExportTime(e){var t;const i={resource_id:e.resource_id};switch(e.resource_type){case I.vt.image:i.picture_id=e.report_id;break;case I.vt.video:i.video_id=e.report_id}let r={};switch(this.smartToolType){case w.K8.ImageToImage:case w.K8.TextToImage:r={edittype:"smart_tool",original_edittype:"smart_tool"}}null===(t=this.eventTracker)||void 0===t||t.track("export_time",{edittype:"smart_tool",current_page:"smart_tool_page",is_smart_tool:1,original_edittype:"smart_tool",format:"video"===this.toolMaterialType?"mp4":"jpg",vid:e.resource_id,...this._getAttributeReportParams(),...i,...r,tool_type:w.Ww[(0,b.b0)(this.smartToolType)]},{business:[P.PK.Tool]})}_reportAiImportMaterialTime(e){if(!this._aiImportStartTime)return;const t=performance.now()-this._aiImportStartTime;this._aiImportStartTime=0,this._reportBase("ai_import_material_time",{time:t,...e})}_setEditingMore(e){this._editingMore=e}setSelectedAiMaterials(e){this._selectedAiMaterials=[...e]}async handleEditMore(){var e,t,i,r,s,a,o;let n,l=[];const d="preset"===(null===(e=this.mainMaterial)||void 0===e?void 0:e.source);let c={};var u,p,h;d&&(c={idc:null===(u=this.mainMaterial)||void 0===u?void 0:u.resourceIdc,resource_id:null===(p=this.mainMaterial)||void 0===p?void 0:p.assetId,resource_name:null===(h=this.mainMaterial)||void 0===h?void 0:h.resourceName,resource_type:"video"===this.toolMaterialType?I.vt.video:I.vt.image});switch(this.smartToolType){case w.K8.ImageToImage:case w.K8.TextToImage:n=Boolean(this.aiWorksInView.length),n?(l=this.aiWorksInView.length>1?[...this._selectedAiMaterials]:[...this.aiWorksInView],this._selectedAiMaterials=[]):d&&(l=[c]);break;case w.K8.ImageRestoration:case w.K8.ImageAiToning:case w.K8.ImageNightEnhance:var f;if(n=Boolean((null===(t=this.aiWorksList[0])||void 0===t?void 0:t.works.length)&&!this.isViewOriginal&&this.pageLifeCycle===ee.ViewingProduction),n)l=[null===(f=this.aiWorksList[0])||void 0===f||null===(f=f.works)||void 0===f?void 0:f.find((e=>e.level===this.attributes.level))];else d&&(l=[c]);break;default:n=Boolean((null===(i=this.aiWorksList[0])||void 0===i?void 0:i.works.length)&&!this.isViewOriginal&&this.pageLifeCycle===ee.ViewingProduction),n?l=[...this.aiWorksList[0].works]:d&&(l=[c])}let m=[];if(l.length){m=(await this.handleSyncAsset(l,n,!0,!1)).sync_asset_state.map((e=>e.md5))}else{var v;m=[(null===(v=this.mainMaterial)||void 0===v?void 0:v.md5)||""]}let g=`/editor/${(await _.mS.CreateDraft({assets:m,workspace_id:null===(r=this.profile)||void 0===r?void 0:r.spaceInfo.workspaceId,transfered_from:(0,b.b0)(this.smartToolType),type:0})).draft_key}?from_page=smart_tool_page&__tool_type=${w.Ww[(0,b.b0)(this.smartToolType)]}&workspaceId=${null===(s=this.profile)||void 0===s?void 0:s.spaceInfo.workspaceId}&spaceId=${null===(a=this.profile)||void 0===a?void 0:a.spaceInfo.spaceId}&__tool_position=edit_more&enter_from=draft`;switch(this.smartToolType){case w.K8.ImageToImage:case w.K8.TextToImage:g+=`&output_cnt=${(null===(o=l)||void 0===o?void 0:o.length)||1}`;break;default:g+="&output_cnt=1"}(0,K.T)().provideReflowFlag(g,!0);window.open(g,"_blank")||(this.doNotBlockWindowClose=!0,location.href=new Function('return typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this)')().xssNamespace.cc_web_editor_smart_toolbox.filterUrl(g,null,{logType:"js.href/src",mode:"black",reportOnly:"all"}))}setAiWorksInViewLike(e,t,i){const r=this.aiWorksInView[e];"like"===t?(r.like=i,r.dislike=!1):(r.dislike=i,r.like=!1);const s=[...this.aiWorksInView];s.splice(e,1,r),this.aiWorksInView=[...s]}}const re=f.createContext(void 0)},22194:function(e,t,i){i.d(t,{$q:function(){return s},Sx:function(){return r},wx:function(){return a}});let r=function(e){return e.Light="light",e.Dark="dark",e}({}),s=function(e){return e.SUCCESS="success",e.FAIL="fail",e.CANCEL="cancel",e}({}),a=function(e){return e[e.HorizontalScreen=1]="HorizontalScreen",e[e.VerticalScreen=2]="VerticalScreen",e[e.SquareScreen=3]="SquareScreen",e}({})},18982:function(e,t,i){i.d(t,{F:function(){return a}});var r=i(36662),s=i(95118);const a=async()=>{s.F.onChange((({firstPartyAnalytics:e,GoogleAnalytics:t})=>{r.n.enable=e,t&&"function"==typeof gtag&&(gtag("consent","update",{analytics_storage:"granted"}),gtag("event","accept_cookie"))}));const e=s.F.getSettings(),t=e.firstPartyAnalytics,i=e.GoogleAnalytics;r.n.enable=t,i&&"function"==typeof gtag&&(gtag("consent","update",{analytics_storage:"granted"}),gtag("event","accept_cookie"))}},1790:function(e,t,i){i.d(t,{G:function(){return a}});var r=i(2799),s=i.n(r);const a=(e,t)=>{(async e=>{if(e.startsWith("bolb:"))return e;{const t=e.replace(/^http:\/\//i,"https://"),i=await s().get(t,{responseType:"blob"}),r=await i.data;return URL.createObjectURL(r)}})(e).then((e=>{const i=document.createElement("a");i.href=new Function('return typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this)')().xssNamespace.cc_web_editor_smart_toolbox.filterUrl(e,null,{logType:"js.href/src",mode:"black",reportOnly:"all"}),i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i)}))}},81746:function(e,t,i){i.d(t,{QA:function(){return a},XH:function(){return o}});var r=i(88650),s=i(46012);async function a(e,t,i){try{const r=e.loginSdk||{};if(!r.profile)return!0;const s=await t(e,e.filerCloud);if(!s&&0!==s)return!0;let a=0;return i.forEach((e=>{const t=e.size;a+=t})),s>a}catch(r){return s.Zq.error("cloud","isEnoughSpaceStorage fail","isEnoughSpaceStorage fail",r),!0}}async function o(e,t){try{var i,a;const s=await t._sdk.resetSpaceStorage(null===(i=e.loginSdk)||void 0===i||null===(i=i.profile)||void 0===i||null===(i=i.spaceInfo)||void 0===i?void 0:i.workspaceId);return null===(a=e[r.T])||void 0===a||a.resetSpaceStorageSet(s),s}catch(n){var o;s.Zq.error("cloud","getRemainingCapacity fail","getRemainingCapacity fail",n),null===(o=e[r.T])||void 0===o||o.resetSpaceStorageSet(null)}return null}},68342:function(e,t,i){i.d(t,{d:function(){return l}});var r=i(77024),s=i(31399),a=i(62822),o=i(53265),n=i(14148);function l(e){const t=e.width,i=e.height,l=e.duration,d=e.smartToolType,c=e.acceptType,u=e.eventTracker;if(!t||!i)return!0;if("video"===c){const e=Math.max(t,i),a=Math.min(t,i),o=600;if(l>o)return r.A.error(n.F2.t("web_magicTools_toast_too_long_material",{placeholder:o},"Couldn\u2019t upload because media duration exceeds {placeholder}s. Select another one.")),f("web_magicTools_toast_too_long_material"),!1;if([s.K8.VideoUpscaler,s.K8.VideoSlowMotion,s.K8.VideoStabilization].includes(d)){const e=50;if(!(a>e))return h(e,e),!1}if([s.K8.VideoUpscaler,s.K8.VideoStabilization].includes(d)){const t=2048;if(!(e<t))return m(t,t),!1}if(d===s.K8.VideoSlowMotion&&(e>1920||a>1080))return m(1920,1080),!1}if("image"===c){const e=Math.max(t,i),a=Math.min(t,i),o=e/a;if([s.K8.ImageUpscaler].includes(d)&&a>=2160)return m(2160,4096),!1;if(e>=4096)return m(4096,4096),!1;if([s.K8.ImageUpscaler,s.K8.ImageAiToning,s.K8.ImageRestoration,s.K8.ImageNightEnhance,s.K8.ImageColoring,s.K8.ImageToImage,s.K8.TextToImage].includes(d)){let e=50;[s.K8.ImageToImage,s.K8.TextToImage].includes(d)&&(e=40);if(!(a>e))return h(e,e),!1}if([s.K8.ImageToImage,s.K8.TextToImage].includes(d)){if(!(o<4))return p="aspectRatio < 4",r.A.error(n.F2.t("web_magicTools_toast_reselect_material",{},"Couldn\u2019t process material. Try another one.")),f(p),!1;if(e>=4096)return m(4096,4096),!1}}var p;return!0;function h(e,t){const i="web_magicTools_toast_too_low_resolution";r.A.error(n.F2.t(i,{placeholder1:e,placeholder2:t},"Couldn\u2019t upload because media resolution is lower than {placeholder1}x{placeholder2}. Select another one.")),f(i)}function f(e){null==u||u.trackerBoomerang("material_upload_block_show",{current_page:"smart_tool_page",block_reason:e,tool_type:s.Ww[(0,a.b0)(d)]},{business:[o.PK.Tool]})}function m(e,t){const i="web_magicTools_toast_too_high_resolution";r.A.error(n.F2.t(i,{placeholder1:e,placeholder2:t},"Couldn\u2019t upload because media resolution is higher than {placeholder1}x{placeholder2}. Select another one.")),f(i)}}},32836:function(e,t,i){i.d(t,{g:function(){return d}});var r=i(8113),s=i(8743),a=i(82888),o=i(1732),n=i(14148),l=i(84698);const d=(0,r.V)("INIT_I18N")((async({lng:e="en"}={lng:"en"})=>{const t=new Promise((t=>n.Ay.use((0,o.U)({validator:()=>l.A.get("capcut_locale")||"en"})).use((0,a.lH)({loadOptions:{apiKey:"38d171503ca311ee866b4ff6c924e0e2",namespace:"WebClient",TEAChannelDomain:"",zoneHost:"https://starling-oversea.byteoversea.com",timeout:8e3,lazyUpdate:!0},simpleLoad:!0,on:{done:t},fallbackTexts:{}})).use(s.w9).init({fallbackLng:["en",l.A.get("capcut_locale")||"en"],thirdParamFallback:!0,lng:e})));await t}))},62822:function(e,t,i){i.d(t,{G4:function(){return s.G},b0:function(){return n},dZ:function(){return a},sb:function(){return l},xb:function(){return o}});var r=i(75495),s=i(1790);function a(e){try{return JSON.parse(e||"")}catch{return}}function o(e){console.error("should never reach")}const n=e=>{switch(e){case 1:return 8;case 2:return 9;case 3:return 10;case 4:return 17;case 5:return 11;case 6:return 13;case 7:return 14;case 8:return 15;case 9:return 16;case 10:return 12;case 11:return 18;case 12:return 19;case 13:return 20;case r.oQ.Autocut:return 22;case r.oQ.TextToVideo:return 23;case r.oQ.URLToVideo:return 24;case r.oQ.LongToShort:return 27;default:return-1}},l=()=>{const e={current_page:"smart_tool_page"},t=new URLSearchParams(location.search);return t.get("__from_page")&&(e.from_page=t.get("__from_page")),t.get("from_page")&&(e.from_page=t.get("from_page")),t.get("enter_from")&&(e.enter_from=t.get("enter_from")),t.get("from_tool_type")&&(e.from_tool_type=t.get("from_tool_type")),e}},62820:function(e,t,i){var r,s=i(8800),a=i(90018),o=i(85970),n=i(81316),l=i(50135),d=i(71716),c=i(29328),u=i(25344),p=i(84924),h=i(40492),f=i(26719),m=i.n(f),v=i(87759),g=i(92439),y=i(89243),_=i(14148),w=i(42958),I=i(90843);var A=(0,v.p)(r=(0,g.h)(r=class{constructor(e){(0,h.A)(this,"_lifeSequence",{initialized:0,mounted:1,setup:2,destroyed:3}),(0,h.A)(this,"_lifecycle","initialized"),(0,h.A)(this,"_sdk",void 0),(0,h.A)(this,"_options",void 0),this._options=e}relinquish(){this.lifecycle="destroyed"}async mount(){var e;if(null===(e=this._options)||void 0===e||!e.independentUploader)return;const t={isBoe:y.SC,newIdc:w.s.getVar("web_idc"),userRegion:w.s.getVar("country_code"),uniqueId:m().generate(),videoUploader:{getSliceFunc:e=>e>1048576e3?10485760:5242880},reqDomain:w.s.getVars()};this._options.dependencies.EverCloud.setNoSignOptions(t),await this._options.dependencies.EverCloud.noSignInit(),this._sdk=this._options.dependencies.EverCloud.getUploader(t,"file"),await this._sdk.init(),this.lifecycle="mounted"}upload(e){if("application/json"!==e.file.type&&!this._options.dependencies.validateEverCloudFileAccept({file:e.file}))throw new Error(_.F2.t("current_import_format_not_supported",{},"Current import format is not supported"));if(e.file.size>I.ZE)throw new Error(_.F2.t("only_supports_materials_up_to_2gb",{},"Only materials smaller than 2GB are supported"));return this._sdk.upload(e)}})||r)||r,T=i(46012),S=i(77024),k=i(64939),b=i(71411),C=i(57672),x=i(16649),P=i(59522);function U(e,t,i,r,s){const a=(0,P.Yb)(t);window.setInterval((()=>{!function(e){const t=Date.now(),i=[];for(const s of e.store.visitorAssets){var r;(null===(r=s.material)||void 0===r?void 0:r.fileStatus)===C.o.LoginSyncing&&s.material.updatedAt&&i.push({fileId:s.fileId,material:{progressMigrate:(0,b.U$)(t,s.material.updatedAt,s.material.size)}})}e.store.visitorAssetsUpdateBatch(i)}(t),function(e,t,i,r,s,a){if(!t.store.dirty.migrate)return;if(r.onStart(),!e.store.userId)return null!=s&&s.uid?void e.mount(s.uid,a).then((()=>{i.mount(),e.setupPackage({newWorkspace:!0,draftId:"draftId"})})):void 0;if("setup"!==e.lifecycle)return;let o=!1;for(const f of t.store.visitorAssets){var n,l,d,c,u,p,h;(null===(n=f.material)||void 0===n?void 0:n.fileStatus)===C.o.Online||(null===(l=f.material)||void 0===l?void 0:l.fileStatus)===C.o.Local||(null===(d=f.material)||void 0===d?void 0:d.fileStatus)===C.o.LoginSyncFailed?"other"===f.material.groupType?E(e,t,f.fileId):L(e,t,f.fileId,a):(null===(c=f.material)||void 0===c?void 0:c.fileStatus)!==C.o.TranscodeFailed&&(null===(u=f.material)||void 0===u?void 0:u.fileStatus)!==C.o.NoTranscodeInformation&&(null===(p=f.material)||void 0===p?void 0:p.fileStatus)!==C.o.TranscodeNotSupported||t.store.visitorAssetsRemove({fileId:f.fileId}),(null===(h=f.material)||void 0===h?void 0:h.fileStatus)!==C.o.LoginSynced&&(o=!0)}for(const f of t.store.uploadFiles)f.fileStatus===C.o.Uploading?o=!0:f.fileStatus===C.o.UploadFailed&&t.store.uploadFilesRemove(f);o?"doing"!==t.store.state.migrate&&(t.store.stateSet("migrate","doing"),e.store.stateSet("migrate","doing")):(t.store.dirtySet("migrate",!1),t.store.stateSet("migrate","idle"),e.store.stateSet("migrate","idle"),r.onSuccess())}(e,t,i,a,null==r?void 0:r.profile,s)}),I.QT*I.vm)}function F(e){switch(e){case"video":default:return 1;case"audio":return 2;case"image":return 3}}async function L(e,t,i,r){var s,a,o,n;const l=t.store.visitorAssets.find((({fileId:e})=>i===e)),d=(0,P.U_)(i,null!==(s=null==l||null===(a=l.material)||void 0===a?void 0:a.size)&&void 0!==s?s:0,t),c=d.onSuccess,u=d.onFail;if(!l)return console.error(`cannot find file: ${i}`),u(`cannot find file: ${i}`),{status:"error"};if(null===(o=l.material)||void 0===o||!o.vid||!l.material.size)return console.error(`file has no vid or fileSize: ${i}`),u(`file has no vid or fileSize: ${i}`),{status:"error"};if(![C.o.Online,C.o.Local,C.o.LoginSyncFailed].includes(null===(n=l.material)||void 0===n?void 0:n.fileStatus))return console.error("only could sync Online/Local/LoginSyncFailed files"),u("only could sync Online/Local/LoginSyncFailed files"),{status:"error"};let p;var h,f;if("image"===l.material.groupType)p="";else if(p=null!==(h=null===(f=l.material.playInfo)||void 0===f?void 0:f.key)&&void 0!==h?h:t.store.decryptAlbum[l.path],!p)return console.error("has no decrypt key"),u("has no decrypt key"),{status:"error"};let m,v;t.store.visitorAssetsUpdate({fileId:i,material:{updatedAt:Date.now(),fileStatus:C.o.LoginSyncing}});try{(0,k.h3)(l.material)||(m=await e._sdk.syncVideoToEverCloud(l.material.vid,{fileSize:l.material.size,resouceType:F(l.material.groupType)}))}catch(R){if("string"==typeof R)try{const e=JSON.parse(R);var g,y,w;if(e.code===I.Ts.INSUFFICIENT_SPACE)null===(g=r.showExpandOnSyncShow)||void 0===g||g.call(r),u("No enough space to sync."),T.Zq.error("cloud","sync create meets space full","sync_create_full",new Error(R));else u(_.F2.t("{placeholder0}_synchronization_failed",{placeholder0:null===(y=l.material)||void 0===y?void 0:y.name},"Couldn\u2019t sync {placeholder0}")),S.A.warning(_.F2.t("{placeholder0}_synchronization_failed",{placeholder0:null===(w=l.material)||void 0===w?void 0:w.name},"Couldn\u2019t sync {placeholder0}")),T.Zq.error("cloud","sync create meets other error","sync_create_error",new Error(R))}catch(j){var A,b;u(_.F2.t("{placeholder0}_synchronization_failed",{placeholder0:null===(A=l.material)||void 0===A?void 0:A.name},"Couldn\u2019t sync {placeholder0}")),S.A.warning(_.F2.t("{placeholder0}_synchronization_failed",{placeholder0:null===(b=l.material)||void 0===b?void 0:b.name},"Couldn\u2019t sync {placeholder0}")),T.Zq.error("cloud","sync create meets json error","sync_create_json_parse",new Error(R))}else T.Zq.error("cloud","sync create meets syntax error","sync_create_syntax_parse",R);return console.warn("[FilerCloud#syncToEverCloud] failed:",R),t.store.visitorAssetsUpdate({fileId:i,material:{fileStatus:C.o.LoginSyncFailed}}),{status:"error"}}try{var U;const e=await m.done();if("success"!==e.status||null===(U=e.data)||void 0===U||!U.md5)return console.warn("[FilerCloud#syncToEverCloud] failed:",e),t.store.visitorAssetsUpdate({fileId:i,material:{fileStatus:C.o.LoginSyncFailed}}),u(`[FilerCloud#syncToEverCloud] failed: ${e}`),e;v=e.data.md5}catch(R){var L,E;return console.warn("[FilerCloud#syncToEverCloud] error:",R),T.Zq.error("cloud","sync meets error","sync_error",R),t.store.visitorAssetsUpdate({fileId:i,material:{fileStatus:C.o.LoginSyncFailed}}),u(`[FilerCloud#syncToEverCloud] error: ${null==R||null===(L=(E=R).toString)||void 0===L?void 0:L.call(E)}`),{status:"error"}}const M=(await(0,x.kU)(e,{md5s:[v]}))[0],O={md5:v,path:l.path,meta:l.meta,visitorDecryptKey:p,material:M};return r.handleLoginSyncSuccess(l,O),t.store.visitorAssetsUpdate({fileId:i,material:{fileStatus:C.o.LoginSynced}}),e.store.packageAssetsInsertOrUpdate(O),e.store.globalMaterialsInsertOrUpdate(M),e.store.dirtySet("upgrade",!0),e.store.dirtySet("transcode",!0),e.store.dirtySet("visual",!0),M||console.warn("[FilerCloud#syncToEverCloud] get_asset failed, no info"),c(v,l.material.size),{status:"success"}}async function E(e,t,i){var r,s,a;const o=t.store.visitorAssets.find((({fileId:e})=>i===e)),n=(0,P.hX)(i,t),l=n.onSuccess,d=n.onFail;if(!o)return console.error(`cannot find file: ${i}`),d(`cannot find file: ${i}`),{status:"error"};var c;if("other"!==(null===(r=o.material)||void 0===r?void 0:r.groupType)||null===(s=o.material)||void 0===s||!s.tumor)return console.error(`only should pass file into imitate sync: ${i}`,null===(c=o.material)||void 0===c?void 0:c.tumor),d(`only should pass file into imitate sync: ${i}`),{status:"error"};if(![C.o.Online,C.o.Local,C.o.LoginSyncFailed].includes(null===(a=o.material)||void 0===a?void 0:a.fileStatus))return console.error("only could sync Online/Local/LoginSyncFailed files"),d("only could sync Online/Local/LoginSyncFailed files"),{status:"error"};t.store.visitorAssetsUpdate({fileId:i,material:{updatedAt:Date.now(),fileStatus:C.o.LoginSyncing}});try{const r=await e.upload(o.material.tumor,{skipDuplicate:!0,fileType:"file",forceFilePath:o.path,meta:o.meta});return"success"===r.status&&r.md5?(t.store.visitorAssetsUpdate({fileId:i,material:{fileStatus:C.o.LoginSynced}}),e.store.packageAssetsUpdate({md5:r.md5,visitorDecryptKey:""}),l(r.md5,o.material.size),r):(console.warn("[FilerCloud#syncToEverCloud] failed:",r),t.store.visitorAssetsUpdate({fileId:i,material:{fileStatus:C.o.LoginSyncFailed}}),d(`[FilerCloud#syncToEverCloud] failed: ${r}`),r)}catch(h){var u,p;return console.warn("[FilerCloud#syncToEverCloud] failed:",h),T.Zq.error("cloud","sync imitate meets error","sync_imitate_error",h),t.store.visitorAssetsUpdate({fileId:i,material:{fileStatus:C.o.LoginSyncFailed}}),d(`[FilerCloud#syncToEverCloud] failed: ${null==h||null===(u=(p=h).toString)||void 0===u?void 0:u.call(p)}`),{status:"error"}}}const M={limit:{visitor:{single:500*s.Yi*s.Yi,total:500*s.Yi*s.Yi},cloud:{single:1024*s.Yi*s.Yi}},Tea:a.A,autoSaveToCloud:!1,autoSaveToLocal:!0,disableExportCover:!0,dependencies:{EverCloud:o.QO,validateEverCloudFileAccept:o.s0,getUploadEverCloudFileTypeFormat:o.cO,EVER_CLOUD_SUPPORT_SOURCE_TYPE:o.o4}};n.A.once("lifecycle:mounted",(()=>{const e=M;void 0===e.visual&&(e.visual={}),void 0===e.visual.sprite&&(e.visual.sprite=!0),void 0===e.switch&&(e.switch={}),void 0===e.switch.upload&&(e.switch.upload=!0),void 0===e.switch.upgrade&&(e.switch.upgrade=!0),void 0===e.autoSaveToCloud&&(e.autoSaveToCloud=!0),void 0===e.autoSaveToLocal&&(e.autoSaveToLocal=!1);const t=new c.Ay(e),i=new d.gl(e,t),r=new p.A,s=new u.b0(e,r),a=new A(e);l.A.setFilerVisitor(s),l.A.setFilerCloud(i),l.A.handleLoginSdkReady(),l.A.getCurrentSpaceDirectoryFiles();const o=n.A.profile;null!=o&&o.uid?i.mount(o.uid,l.A).then((()=>{i.setupPackage({newWorkspace:!0,draftId:"draft"})})):s.mount(),(0,d.ir)(i,l.A),(0,u.OP)(s,l.A),U(i,s,a,n.A,l.A)}))},47890:function(e,t,i){i.d(t,{v:function(){return a},w:function(){return o}});var r=i(99415),s=i(74296);function a(e,t){const i=(0,r.A)(e,2),a=i[0],o=i[1];if("2x"===t)return[2*a,2*o];const n=(0,r.A)(s.I6[t],2)[1];let l;l=a>=o?[a*n/o,n]:[n,o*n/a];if(l.some((e=>e>4096))){const e=Math.max(...l)/4096;l=l.map((t=>t/e))}return l=l.map((e=>function(e){const t=Math.floor(e);return t%2==1?t-1:t}(e))),l}function o(e,t="2x"){"2X"!==t.toUpperCase()&&console.error("getVideoSizeByResolution===",t);const i=(0,r.A)(e,2);return[2*i[0],2*i[1]]}},34984:function(e,t,i){i.d(t,{d:function(){return l},y:function(){return o}});var r=i(40492),s=i(12388),a=i(91689);async function o(e){const t=document.createElement("div"),r=await l({...e,el:t}),s=r.player,a=r.Events;return await Promise.all([i.e(3136),i.e(6590),i.e(782),i.e(1706),i.e(9978),i.e(8897),i.e(6236),i.e(1661),i.e(8730),i.e(2364),i.e(833)]).then(i.bind(i,2364)),new Promise((e=>{setTimeout((()=>{s.destroy(),e(void 0)}),15e3),s.on(a.CANPLAY,(()=>{var t,i;return e({width:null===(t=s.video)||void 0===t?void 0:t.videoWidth,height:null===(i=s.video)||void 0===i?void 0:i.videoHeight})})),s.on(a.ERROR,(t=>{console.error(t),e(void 0)}))}))}class n{}async function l(e){const t=e||{},r=t.id,o=t.el,l=t.url,d=t.headers,c=t.decryptKey,u=(await Promise.all([i.e(3136),i.e(6590),i.e(782),i.e(1706),i.e(9978),i.e(8897),i.e(6236),i.e(1661),i.e(8730),i.e(2364),i.e(833)]).then(i.bind(i,2364))).default,p=await i.e(4836).then(i.bind(i,4836)),h=p.SimplePlayer,f=p.Events,m=d||c,v=new h((0,s.A)({id:r,el:o,url:l,width:"100%",height:"100%",seekedStatus:"auto",plugins:[m?u:n],Mp4EncryptPlayer:{header:{headers:d},useEME:!1,keyValue:c},controls:!1},e,((e,t)=>{if((0,a.A)(e)&&(0,a.A)(t))return[...new Set(e.concat(t))]})));return v.crossOrigin="anonymous",{player:v,Events:f}}(0,r.A)(n,"pluginName","DummyPlugin")}},function(e){var t=function(t){return e(e.s=t)};e.O(0,[5271,3136,6590,782,1706,9978,8897,6236,1661,8730,2841,739,9013,6274,4189,4454,6208,6269,3805,3565,4235,6845,4556,3359,8779,4271,1180,3747,8755,6056,8691,1270,8358,6901,4675,4321,1028,4210,62,1806],(function(){return t(10937),t(46768)}));e.O()}]);
//# sourceMappingURL=main-7f044e6d.be2b3b19.js.map